<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Active Directory Authentication" /><meta name="author" content="Muhammad Adel" /><meta property="og:locale" content="en_US" /><meta name="description" content="Local Windows Authentication" /><meta property="og:description" content="Local Windows Authentication" /><link rel="canonical" href="https://itsfading.github.io/posts/Active-Directory-Authentication/" /><meta property="og:url" content="https://itsfading.github.io/posts/Active-Directory-Authentication/" /><meta property="og:site_name" content="Muhammad Adel" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-06-25T18:30:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Active Directory Authentication" /><meta name="twitter:site" content="@ItsFadinG_" /><meta name="twitter:creator" content="@Muhammad Adel" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Muhammad Adel"},"dateModified":"2025-04-27T14:27:47+03:00","datePublished":"2021-06-25T18:30:00+02:00","description":"Local Windows Authentication","headline":"Active Directory Authentication","mainEntityOfPage":{"@type":"WebPage","@id":"https://itsfading.github.io/posts/Active-Directory-Authentication/"},"url":"https://itsfading.github.io/posts/Active-Directory-Authentication/"}</script><title>Active Directory Authentication | Muhammad Adel</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Muhammad Adel"><meta name="application-name" content="Muhammad Adel"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/Mine.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Muhammad Adel</a></div><div class="site-subtitle font-italic">CyberSecurity geek, who wants to share his day-to-day knowledge</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://twitter.com/ItsFadinG_" aria-label="twitter" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="https://www.linkedin.com/in/muhammadadel14" aria-label="linkedin" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="https://github.com/ItsFadinG" aria-label="github" class="order-5" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['Muhammad.adel.tr','gmail.com'].join('@')" aria-label="email" class="order-6" > <i class="fas fa-envelope"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Active Directory Authentication</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Active Directory Authentication</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Muhammad Adel </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Fri, Jun 25, 2021, 6:30 PM +0200" prep="on" > Jun 25, 2021 <i class="unloaded">2021-06-25T18:30:00+02:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sun, Apr 27, 2025, 2:27 PM +0300" prefix="Updated " > Apr 27 <i class="unloaded">2025-04-27T14:27:47+03:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1960 words">10 min</span></div></div><div class="post-content"><h2 id="local-windows-authentication"><strong>Local Windows Authentication</strong></h2><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/AD-Auth/Untitled.png" alt="Untitled" /></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/AD-Auth/Untitled%201.png" alt="Untitled" /></p><p>This graphical representation should help you to make more sense in terms of how authentication flows on Windows based systems.</p><ol><li>The user starts their computer. Depending on the system configuration, they may also need to press <code class="language-plaintext highlighter-rouge">Ctrl+Alt+Del</code>.<li>In the background, the <code class="language-plaintext highlighter-rouge">winlogon.exe</code> process runs under the SYSTEM context and waits for user credentials.<li><code class="language-plaintext highlighter-rouge">winlogon.exe</code> communicates with credential providers (such as LSASS) to gather information like which users are already logged in or who last logged in. This improves user experience by pre-selecting the account, so users often only need to enter their password.<li>The gathered information is passed to the Logon UI, which is then presented to the user.<li>The user selects his/her profile or chooses ‘different user’ and provides their credentials to the UI.<li>The logon UI sends the credentials back to <code class="language-plaintext highlighter-rouge">CredUI.DLL</code><li><code class="language-plaintext highlighter-rouge">CredUI.DLL</code> is a proxy at this point, simply forwarding the credentials back to the credential provider.<li>And the <code class="language-plaintext highlighter-rouge">Winlogon.exe</code> process, which ultimately:<li>Initializes LSA on the user’s behalf and authenticates the user.</ol><h2 id="ntlm-authentication"><strong>NTLM Authentication</strong></h2><p>When Kerberos authentication is not possible, Windows will fall back to NTLM authentication. This can even happen between machines that are members of the same domain, but when all necessary conditions to use Kerberos are not in place. For example, Kerberos works with so-called service names. If we don’t have a name, Kerberos cannot be used. This is the case when we access a share on a file server by using the IP address of the server instead of its server name. NTLM authentication is a two-party authentication: the client and the server. It takes three steps:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/AD-Auth/ntlm.png" alt="Untitled" /></p><ol><li><strong>Negotiate:</strong> the client sends a negotiate packet to the server to request the authentication. There are different parameters and versions for NTLM, and the client has to inform the server what it is capable of. This is done with a negotiate packet.<li><strong>Challenge:</strong> the server sends a challenge packet to the client. This challenge includes a so-called “nonce”. A <strong>nonce</strong> is a random number of 16 bytes.<li><strong>Response:</strong> the client sends the response to the server: it calculates a response by hasing the nonce with the NT hash of the user’s passwrod and sends that to the server. Using a nonce allows the two parties to perform authentication without having to send the password (cleartext or encrypted) over the network. The server checks the credentials of the client by performing the same calculation as the client for the response, and if the response calculated by the server is the same as the response calculated by the client, then the client is authenticated to the server.</ol><h2 id="kerberos-authentication"><strong>Kerberos Authentication</strong></h2><p><strong>Overview</strong>:</p><ul><li><p><strong>Ticket Granting Ticket (TGT)</strong> - A ticket-granting ticket is an authentication ticket used to request service tickets from the TGS for specific resources from the domain.</p><li><p><strong>Key Distribution Center (KDC)</strong> - The Key Distribution Center is a service for issuing TGTs and service tickets that consist of the Authentication Service and the Ticket Granting Service.</p><li><p><strong>Authentication Service (AS)</strong> - The Authentication Service issues TGTs to be used by the TGS in the domain to request access to other machines and service tickets.</p><li><p><strong>Ticket Granting Service (TGS)</strong> - The Ticket Granting Service takes the TGT and returns a ticket to a machine on the domain.</p><li><p><strong>Service Principal Name (SPN)</strong> - A Service Principal Name is an identifier given to a service instance to associate a service instance with a domain service account. Windows requires that services have a domain service account which is why a service needs an SPN set. <strong>SPN Format</strong> are serviceclass/host:port servicename like, MSSQLSvc/SQLSERVER2.corp. local:1433</p><li><p><strong>KDC Long Term Secret Key (KDC LT Key)</strong> - The KDC key is based on the KRBTGT service account. It is used to encrypt the TGT and sign the PAC.</p><li><p><strong>Client Long Term Secret Key (Client LT Key)</strong> - The client key is based on the computer or service account. It is used to check the encrypted timestamp and encrypt the session key.</p><li><p><strong>Service Long Term Secret Key (Service LT Key)</strong> - The service key is based on the service account. It is used to encrypt the service portion of the service ticket and sign the PAC.</p><li><p><strong>Session Key</strong> - Issued by the KDC when a TGT is issued. The user will provide the session key to the KDC along with the TGT when requesting a service ticket.</p><li><p><strong>Privilege Attribute Certificate (PAC)</strong> - The PAC holds all of the user’s relevant information, it is sent along with the TGT to the KDC to be signed by the Target LT Key and the KDC LT Key in order to validate the user. The authorization step depends on it.</p></ul><p><strong>KRBTGT Account</strong></p><p>Every active directory domain has something called krbtgt account. By default, the <strong>krbtgt</strong> account is not visible in the user’s container. However, you can reveal it by accessing “View” and then selecting “Advanced Features” in the menu. After doing this, you will see the <strong>krbtgt</strong> account listed. This account is referred to as the key distribution center service account, which plays a significant role in Kerberos.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://miro.medium.com/v2/resize:fit:624/1*3HZ5F-rNxUcx505YH6mAtA.png" alt="" /></p><p>The term <strong>“key distribution center” (KDC)</strong> is commonly used to describe the central database that stores user credentials and manages incoming ticket requests. <strong><em>In the context of Active Directory, each domain controller essentially functions as a KDC.</em></strong> Therefore, when you encounter the term DC (domain controller) or KDC in Kerberos language, you can equate it to the key distribution center.</p><p>While the <strong>krbtgt</strong> account appears as a user account, it cannot be used for regular logins. By default, it is disabled and cannot be enabled. Its password is set by the system and is highly complex. You need not be concerned about the specifics of this password, as you will never need to use this account for login purposes. The system keeps the password secure, and no other entity should ever be aware of it.</p><p><strong>Kerberos Deep Drive</strong></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/AD-Auth/Untitled%203.png" alt="Untitled" /></p><h3 id="authentication-server-request-as-req"><strong>Authentication Server Request (AS-REQ)</strong></h3><p><strong>1.</strong> The user requests a Ticket-Granting Ticket (TGT) from the Key Distribution Center (KDC) without including any pre-authentication data. This initial request is sent in plaintext and contains no encrypted components.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/AD-Auth/AS-REQ-wire2.png" alt="AS-REQ-wire2.png" /></p><ol><li><strong>Protocol and Message Type:</strong><ul><li><strong><code class="language-plaintext highlighter-rouge">pvno: 5</code> :</strong> Kerberos Protocol Version 5.<li><strong><code class="language-plaintext highlighter-rouge">msg-type: krb-as-req (10)</code> :</strong> Indicates this is an AS-REQ (Authentication Server Request), the first step in Kerberos auth.</ul><li><strong>Pre-Authentication Data</strong><ul><li><strong><code class="language-plaintext highlighter-rouge">padata-type: pA-REQ-ENC-PA-REP (149)</code> :</strong> The client is attempting <strong>pre-authentication</strong> (proving identity before getting a TGT).<li><strong><code class="language-plaintext highlighter-rouge">padata-value: &lt;MISSING&gt;</code> :</strong> The encrypted timestamp (proof of identity) is missing.</ul><li><strong>Client Principal</strong><ul><li><strong><code class="language-plaintext highlighter-rouge">name-type: kRB5-NT-PRINCIPAL (1)</code> :</strong> Standard user principal (not a service account).<li><strong><code class="language-plaintext highlighter-rouge">cname-string: Administrator</code> :</strong> The client is requesting a TGT for the user <strong><code class="language-plaintext highlighter-rouge">Administrator</code></strong>.</ul><li><strong>Service Principal</strong><ul><li><strong><code class="language-plaintext highlighter-rouge">name-type: kRB5-NT-SRV-INST (2)</code> :</strong> Indicates a <strong>service principal</strong> (e.g., <strong><code class="language-plaintext highlighter-rouge">krbtgt/SAMBA.EXAMPLE.COM</code></strong>).<li><strong><code class="language-plaintext highlighter-rouge">sname-string: 2 items</code> :</strong> Typically contains:<ul><li><strong>Service name</strong>  <strong><code class="language-plaintext highlighter-rouge">krbtgt</code>.</strong><li><strong>Realm</strong> <strong><code class="language-plaintext highlighter-rouge">SAMBA.EXAMPLE.COM</code>.</strong></ul></ul></ol><p><strong>IF Pre-authentication Enabled (default)</strong></p><p>It will return an error <strong><code class="language-plaintext highlighter-rouge">KRB5KDC_ERR_PREAUTH_REQUIRED</code></strong> to the client to indicate that pre-authentication is required before sending the TGT ticket.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/AD-Auth/err-kerb2.png" alt="err-kerb2.png" /></p><p>Then, the user sends the current time stamp encrypted with their password to the KDC. Since the KDC can access everyone’s passwords, it decrypts the timestamp using the user’s password to verify its accuracy.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/AD-Auth/AS-REQ-Valid2.png" alt="AS-REQ-Valid2.png" /></p><p><strong>Pre-Authentication Data: <code class="language-plaintext highlighter-rouge">PA-ENC-TIMESTAMP</code> :</strong></p><ul><li>A <strong>client timestamp</strong> (to prevent replay attacks).<li>Encrypted with the <strong>user’s password hash</strong> (AES-256 here). The KDC decrypts using Administrator “User in the <strong><code class="language-plaintext highlighter-rouge">CNameString</code></strong>” password hash it to verify the client’s identity.</ul><p>Finally, The AS-REP packet will be sent with the <strong>TGT <code class="language-plaintext highlighter-rouge">ticket</code></strong> and the <strong><code class="language-plaintext highlighter-rouge">enc-part</code></strong> that holds the <strong>TGS session key encrypted with the user secret key.</strong></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/AD-Auth/AS-REP-wire2.png" alt="AS-REP-wire2.png" /></p><p><strong>IF Pre-authentication Disabled</strong></p><p>The client can send the AS-REQ <strong>without first encrypting a timestamp</strong>. The KDC will respond directly with an encrypted TGT and a message encrypted with the user password. (The following image assume that pre-authentication is disabled).</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/AD-Auth/Untitled%204.png" alt="Untitled" /></p><h3 id="authentication-server-response-as-rep"><strong>Authentication Server Response (AS-REP)</strong></h3><p><strong>2.</strong> The <strong>Authentication Server (AS)</strong> as part of the <strong>Key Distribution Center (KDC)</strong> checks if the provided user is in the database.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/AD-Auth/Untitled%205.png" alt="Untitled" /></p><p><strong>3.</strong> If the user is a valid domain user, The <strong>Authentication Server (AS)</strong> will generate the user secret key by hashing the user’s password. Then, the <strong>Authentication Server (AS)</strong> sends two messages to the User. </p><ul><li><strong>The First Message:</strong> is encrypted by the user secret key <em>(user’s password → hash it = user secret key)</em> and contains the ID of the <strong>Ticket Granting Server (TGS)</strong> and <strong>TGS</strong> session key which is a randomly generated session key.<li><strong>The Second Message:</strong> is the <strong>Ticket Granting Ticket (TGT)</strong> encrypted by TGS secret key <em>(<strong><code class="language-plaintext highlighter-rouge">krbtgt</code></strong> account password → hash it = <strong><code class="language-plaintext highlighter-rouge">krbtgt</code></strong> secret key)</em>., so it’s content can only be deciphered by the TGS. it contains <em>user ID</em>, <em>user network address</em>, <em>lifetime</em>, <em>timestamp</em> and the <em>TGS session key</em>.</ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/AD-Auth/Untitled%206.png" alt="Untitled" /></p><h3 id="ticket-granting-server-request-tgs-req"><strong>Ticket Granting Server Request (TGS-REQ)</strong></h3><p><strong>4.</strong> The user decrypt the first message by authenticating with his password to obtain the TGS session key.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/AD-Auth/Untitled%207.png" alt="Untitled" /></p><p><strong>5</strong>. Then, the user create two new messages:</p><ul><li><strong>The First Message:</strong> contains the service that the user want to access.<li><strong>The Second Message:</strong> is the <strong>User Authenticator</strong> encrypted by the TGS Session key which contains the user’s username.</ul><p>Finally, the server sends these two messages along with the TGT to the <strong>Ticket Granting Server (TGS)</strong>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/AD-Auth/Untitled%208.png" alt="Untitled" /></p><p>Below is a Wireshark packet capture for a more detailed view:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/AD-Auth/tgs-req.png" alt="image.png" /></p><blockquote><p><strong>Why there is an AP-REQ inside the TGS-REQ?</strong> AP-REQ stands for Authentication Protocol Request, This is required by the Kerberos protocol (RFC 4120) to prove the client/user’s identity to the Ticket-Granting Server (TGS) in case of the TGS-REQ or to the Service in case of the AP-REQ (in the final mutual authentication part between the user and the service).</p></blockquote><h3 id="ticket-granting-server-response-tgs-rep"><strong>Ticket Granting Server Response (TGS-REP)</strong></h3><p><strong>6</strong>. The TGS first checks the service ID if it is available in their database or not. then the TGS will grab a copy of the service secret key (service password <em>→ hash it =</em> service <em>secret key)</em> to encrypt the Service ticket with it..</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/AD-Auth/Untitled%209.png" alt="Untitled" /></p><p><strong>7</strong>. The TGS will decrypt the TGT with <em>the TGS secret key</em> which contains the TGS Session key. Then the User Authenticator will be decrypted by the TGS Session Key. Finally, the TGS will check if the information in TGT matches with the User Authenticator if it match the TGS will add it to its cache.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/AD-Auth/Untitled%2010.png" alt="Untitled" /></p><p><strong>8</strong>. The TGS will create its own messages and send it back to the user. </p><ul><li><strong>The First Message:</strong> contains the service ID <em>(that the user want to access)</em> and the <strong>Service Session Key</strong> the message will be encrypted by TGS Session Key <em>(which was extracted from the TGT)</em>.<li><strong>The Second Message:</strong> is the <strong>Service Ticket</strong> <strong>(TGS Tickets)</strong> which will be encrypted by Service Secret Key. It contains the <em>user’s ID, service name and the service session key.</em></ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/AD-Auth/Untitled%2011.png" alt="Untitled" /></p><p>Below is a Wireshark packet capture for a more detailed view:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/AD-Auth/tgs-rep.png" alt="image.png" /></p><h3 id="authentication-protocol-request-ap-req"><strong>Authentication Protocol Request (AP-REQ)</strong></h3><p><strong>9</strong>. Since the user has the TGS session key from the <strong>AS-REP</strong> phase, he will decrypt the first message. Now the user has access to the Service Session key. So he will create a <strong>User Authenticator Message</strong> and encrypt it with the Service Session Key. Then he will send both the User Authenticator and the Service Ticket to the Service.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/AD-Auth/Untitled%2012.png" alt="Untitled" /></p><p>Below is a Wireshark packet capture for a more detailed view:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/AD-Auth/ap-req.png" alt="image.png" /></p><h3 id="authentication-protocol-response-ap-rep"><strong>Authentication Protocol Response (AP-REP)</strong></h3><p><strong>10</strong>. Now the steps will happen again. The service will decrypt the Service Ticket using its secret key. As a result, it will have access to the Service Session Key to decrypt the User Authenticator. Lastly The service will <strong>check</strong> the matching between the two messages, if they are matched it will <strong>add</strong> the User Authenticator to the its cache and then <strong>create</strong> a Service Authenticator Message encrypted by the Service Session Key and send it to the user.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/AD-Auth/Untitled%2013.png" alt="Untitled" /></p><p>Below is a Wireshark packet capture for a more detailed view:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/AD-Auth/ap-rep.png" alt="image.png" /></p><p><strong>11</strong>. Finally, the User will decrypt the Service Authenticator using the Service Session Key and validate the service name. The mutual authentication is now complete. The Kerberos client can now start issuing service requests, and the Kerberos service can provide the requested services for the client.</p><h3 id="references"><strong>References</strong></h3><ul><li><a href="https://drive.google.com/file/d/1Lc9IzvvB4ZharVIqWMOaXjngXro0c6hd/view">DestCert</a>: Now, you can see the whole walk-through in one image.<li><a href="https://blog.redforce.io/windows-authentication-attacks-part-2-kerberos/">https://blog.redforce.io/windows-authentication-attacks-part-2-kerberos/</a><li><a href="https://labs.lares.com/fear-kerberos-pt1/">https://labs.lares.com/fear-kerberos-pt1/</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/active-directory-101/'>Active Directory 101</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/active-directory/" class="post-tag no-text-decoration" >active directory</a> <a href="/tags/android-security/" class="post-tag no-text-decoration" >Android Security</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Active Directory Authentication - Muhammad Adel&url=https://itsfading.github.io/posts/Active-Directory-Authentication/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Active Directory Authentication - Muhammad Adel&u=https://itsfading.github.io/posts/Active-Directory-Authentication/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Active Directory Authentication - Muhammad Adel&url=https://itsfading.github.io/posts/Active-Directory-Authentication/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Active-Directory-Authentication/">Active Directory Authentication</a><li><a href="/posts/Mobile-Hacking-Lab-IOS-Challenges-Writeups/">MobileHackingLab IOS Challenges Writeups</a><li><a href="/posts/Active-Directory-Basics/">Active Directory Basics</a><li><a href="/posts/Cybertalents-Shadower-Machine-Writeup/">Cybertalents Shadower Machine Writeup</a><li><a href="/posts/Cybertalents-Crashed-Machine-Writeup/">Cybertalents Crashed Machine Writeup</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/web/">web</a> <a class="post-tag" href="/tags/cybertalents/">cybertalents</a> <a class="post-tag" href="/tags/writeups/">writeups</a> <a class="post-tag" href="/tags/active-directory/">active directory</a> <a class="post-tag" href="/tags/redteaming/">redteaming</a> <a class="post-tag" href="/tags/android-security/">android security</a> <a class="post-tag" href="/tags/bug-hunting/">bug hunting</a> <a class="post-tag" href="/tags/machines/">machines</a> <a class="post-tag" href="/tags/android-security/">Android Security</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/TryHackMe-RedTeamCapstoneNetwork-Writeup/"><div class="card-body"> <span class="timeago small" > Jul 26, 2024 <i class="unloaded">2024-07-26T19:52:00+03:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Breaking the Vault | A Detailed Walkthrough of The RedTeam Capstone Challenge</h3><div class="text-muted small"><p> TryHackMe’s RedTeam Capstone Challenge provides an unparalleled, hands-on experience that simulates real-world hacking scenarios. This challenge tests your skills in network infiltration, vulnerabi...</p></div></div></a></div><div class="card"> <a href="/posts/Active-Directory-Basics/"><div class="card-body"> <span class="timeago small" > Jun 25, 2021 <i class="unloaded">2021-06-25T17:20:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Active Directory Basics</h3><div class="text-muted small"><p> Active directory overview what is Active directory? Active Directory is a collection of machines and servers connected inside of domains, that are a collective part of a bigger forest of domains, t...</p></div></div></a></div><div class="card"> <a href="/posts/Active-Directory-Enumeration/"><div class="card-body"> <span class="timeago small" > Jun 25, 2021 <i class="unloaded">2021-06-25T18:35:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Active Directory Enumeration</h3><div class="text-muted small"><p> Using PowerView Domain Information 1 2 3 4 5 6 PS C:\Users&gt; Get-NetDomain PS C:\Users&gt; Get-NetDomain -Domain m.local PS C:\Users&gt; Get-NetDomainSID PS C:\Users&gt; Get-NetDomainController...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Active-Directory-Basics/" class="btn btn-outline-primary" prompt="Older"><p>Active Directory Basics</p></a> <a href="/posts/Active-Directory-Enumeration/" class="btn btn-outline-primary" prompt="Newer"><p>Active Directory Enumeration</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://twitter.com/ItsFadinG_">Muhammad Adel</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by Passion and Enthusiasm</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/web/">web</a> <a class="post-tag" href="/tags/cybertalents/">cybertalents</a> <a class="post-tag" href="/tags/writeups/">writeups</a> <a class="post-tag" href="/tags/active-directory/">active directory</a> <a class="post-tag" href="/tags/redteaming/">redteaming</a> <a class="post-tag" href="/tags/android-security/">android security</a> <a class="post-tag" href="/tags/bug-hunting/">bug hunting</a> <a class="post-tag" href="/tags/machines/">machines</a> <a class="post-tag" href="/tags/android-security/">Android Security</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://itsfading.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
